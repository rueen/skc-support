import{i as L,j as i,k as Y,_ as Z,r as C,a as O,l as ee,b as I,d as y,c as l,w as s,e as p,m as te,n as E,f as ae,o as h,F as U,p as F,q as D,h as v,t as j,g as M,D as ne,P as se,s as z,M as oe,v as le}from"./index-2-XIWpSa.js";const re=(f,g={},_="",n={})=>{const m=Y.create({baseURL:L.baseUrl,timeout:6e4,responseType:"blob"});return m.interceptors.request.use(o=>{const e=localStorage.getItem("token");return e&&(o.headers.Authorization=`Bearer ${e}`),o},o=>(console.error("下载请求错误:",o),Promise.reject(o))),m({url:f,method:"get",params:g,...n}).then(o=>{let e=_;if(!e){const k=o.headers["content-disposition"];if(k){const x=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(k);if(x&&x[1]){e=x[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(N){console.error("文件名解码失败:",N)}}}if(!e){const u=o.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const r=new Blob([o.data]),d=document.createElement("a");return d.href=URL.createObjectURL(r),d.download=e,document.body.appendChild(d),d.click(),URL.revokeObjectURL(d.href),document.body.removeChild(d),{success:!0,filename:e}}).catch(o=>{let e="下载失败";if(o.response)if(o.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const r=new FileReader;r.onload=()=>{try{e=JSON.parse(r.result).message||"下载失败",i.error(e)}catch{i.error("下载失败")}},r.readAsText(o.response.data)}catch{i.error("下载失败")}else i.error(e);return Promise.reject(o)})},ce=(f,g={},_="",n={})=>{const[m,o]=f.split("."),e=L.api[m]&&L.api[m][o];if(!e)return console.error(`API ${f} 不存在`),i.error(`API ${f} 不存在`),Promise.reject(new Error(`API ${f} 不存在`));let r=e;return n.urlParams&&(r=r.replace(/:([^/]+)/g,(d,k)=>{const u=n.urlParams[k];return u===void 0?(console.warn(`URL 参数 ${k} 未提供`),d):u})),re(r,g,_,n)},de={class:"task content-container"},ie={class:"table-container"},ue={class:"table-header"},pe={class:"left"},me={class:"right"},fe=["onClick"],_e={__name:"list",setup(f){const g=ae(),_=C(!1),n=O({taskName:"",channelId:void 0,taskStatus:void 0}),m=C([]),o=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"action",fixed:"right",width:180}],e=C([]),r=O({current:1,pageSize:10,total:0}),d=()=>{r.current=1,b()},k=()=>{n.taskName="",n.channelId=void 0,n.taskStatus=void 0,d()},u=a=>{Object.assign(r,a),b()},x=()=>{g.push("/task/create")},N=a=>{g.push(`/task/edit/${a.id}`)},V=async a=>{try{const t=await le("task.delete",{},{urlParams:{id:a.id}});t.code===0?(i.success("删除成功"),b()):i.error(t.message)}catch{i.error("删除失败")}},q=()=>{oe.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const a=i.loading("正在导出数据，请稍候...",0),t={taskName:n.taskName,channelId:n.channelId,taskStatus:n.taskStatus};await ce("task.export",t,`任务列表_${new Date().toLocaleDateString()}.xlsx`),a(),i.success("导出成功")}catch(a){console.error("导出失败:",a),i.error("导出失败，请稍后重试")}}})},b=async()=>{_.value=!0;try{const a=await E("task.list",{page:r.current,pageSize:r.pageSize,...n});a.code===0?(e.value=a.data.list,r.total=a.data.total):i.error(a.message)}finally{_.value=!1}},J=async()=>{const a=await E("channel.list");a.code===0&&(m.value=a.data.list)},T=C([]),$=O({}),G=async()=>{const a=await te();T.value=Object.values(a),Object.values(a).map(t=>{$[t.value]=t.text})};return ee(async()=>{G(),b(),J()}),(a,t)=>{const H=p("a-input"),w=p("a-form-item"),A=p("a-select-option"),B=p("a-select"),S=p("a-button"),P=p("a-space"),K=p("a-form"),Q=p("a-popconfirm"),W=p("a-table");return h(),I("div",de,[y("div",ie,[y("div",ue,[y("div",pe,[l(K,{layout:"inline",model:n},{default:s(()=>[l(w,{label:"任务名称"},{default:s(()=>[l(H,{value:n.taskName,"onUpdate:value":t[0]||(t[0]=c=>n.taskName=c),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),l(w,{label:"平台渠道"},{default:s(()=>[l(B,{value:n.channelId,"onUpdate:value":t[1]||(t[1]=c=>n.channelId=c),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:s(()=>[(h(!0),I(U,null,F(m.value,c=>(h(),D(A,{key:c.id,value:c.id},{default:s(()=>[v(j(c.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(w,{label:"任务状态"},{default:s(()=>[l(B,{value:n.taskStatus,"onUpdate:value":t[2]||(t[2]=c=>n.taskStatus=c),placeholder:"请选择状态",style:{width:"120px"},"allow-clear":""},{default:s(()=>[(h(!0),I(U,null,F(T.value,c=>(h(),D(A,{key:c.value,value:c.value},{default:s(()=>[v(j(c.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(w,null,{default:s(()=>[l(P,null,{default:s(()=>[l(S,{type:"primary",onClick:d},{default:s(()=>t[3]||(t[3]=[v("查询")])),_:1}),l(S,{onClick:k},{default:s(()=>t[4]||(t[4]=[v("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),y("div",me,[l(P,null,{default:s(()=>[l(S,{onClick:q},{icon:s(()=>[l(M(ne))]),default:s(()=>[t[5]||(t[5]=v(" 导出 "))]),_:1}),l(S,{type:"primary",onClick:x},{icon:s(()=>[l(M(se))]),default:s(()=>[t[6]||(t[6]=v(" 新建任务 "))]),_:1})]),_:1})])]),l(W,{columns:o,"data-source":e.value,loading:_.value,pagination:r,onChange:u},{bodyCell:s(({column:c,record:R})=>[c.key==="taskStatus"?(h(),I(U,{key:0},[v(j($[R.taskStatus]),1)],64)):z("",!0),c.key==="action"?(h(),D(P,{key:1},{default:s(()=>[y("a",{onClick:X=>N(R)},"编辑",8,fe),l(Q,{title:"确定要删除该任务吗？",onConfirm:X=>V(R)},{default:s(()=>t[7]||(t[7]=[y("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])]),_:2},1024)):z("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},he=Z(_e,[["__scopeId","data-v-104f671d"]]);export{he as default};
