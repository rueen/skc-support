import{_ as Ie,a as $e,b as Ne,j as Z,r as b,c as ee,k as Re,d as p,e as h,f as l,s as k,w as a,g as d,y as te,x as Oe,h as je,l as M,m as y,o as u,F as g,n as j,p as _,i,t as o,q as De,M as Me,A as ae}from"./index-DnOUOQCB.js";import{d as Ye}from"./download-HJZhdJP_.js";import{d as Ee,e as We}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Ue}from"./GroupOwner-CgS7hNSh.js";const He={class:"task-audit content-container"},Fe={class:"table-container"},Pe={class:"table-header"},xe={style:{width:"100%",display:"flex","justify-content":"space-between"}},Be=["onClick"],Le={class:"danger"},Ve={key:0,class:"count-container"},ze={__name:"confirm-audit-list",setup(qe){const Y=$e(),{t:c}=Ne(),se=Z(()=>Y.loaded?Y.getEnumOptions("TaskAuditStatus"):[]),E=je(),W=Oe(),U=b(!1),x=b(!1),$=b(!1),H=b(!1),S=b(""),N=b(null),v=b([]),F=b([]),B=()=>{const e=te().startOf("month").format("YYYY-MM-DD HH:mm:ss"),s=te().endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,s]},n=ee({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:B(),completedTaskCount:void 0,keyword:""}),L=b([]),V=b([]),le=Z(()=>[{title:c("submittedTasks.list.taskName"),key:"taskName"},{title:c("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:c("submittedTasks.list.memberInfo"),key:"member"},{title:c("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:c("submittedTasks.rejectTimes"),dataIndex:"rejectTimes",key:"rejectTimes"},{title:c("submittedTasks.preAuditor"),key:"preWaiterName"},{title:c("submittedTasks.preAuditTime"),key:"preAuditTime"},{title:c("submittedTasks.confirmAuditor"),key:"waiterName"},{title:c("submittedTasks.confirmAuditTime"),key:"confirmAuditTime"},{title:c("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),R=b([]),z=b(0),T=ee({current:1,pageSize:10,total:0}),ne={selectedRowKeys:v,onChange:e=>{v.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},oe=()=>{const e=W.query.filters;if(e){const s={},f=Ee(e);console.log(f),Object.keys(f).forEach(w=>{w==="current"?T.current=f[w]:s[w]=f[w]}),Object.assign(n,{taskAuditStatus:null},s);const r={...W.query};delete r.filters,E.replace({path:W.path,query:r})}},q=()=>{T.current=1,P()},ue=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:B(),completedTaskCount:void 0,keyword:""}),q()},ie=e=>{Object.assign(T,e),P()},re=e=>{E.push(`/member/view/${e.memberId}`)},de=e=>{const s=We({...n,current:T.current});E.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:s}})},ce=async e=>{v.value=[e.id],G()},G=async()=>{if(!v.value.length){y.warning(c("submittedTasks.list.selectTask"));return}const e=await ae("taskSubmitted.batchConfirmAuditApprove",{ids:v.value});e.code===0?(y.success(c("submittedTasks.resolveSuccess")),R.value.forEach(s=>{v.value.includes(s.id)&&(s.taskAuditStatus="approved")}),v.value=[]):y.error(e.message)},me=e=>{v.value=[e.id],S.value="",$.value=!0},pe=async()=>{if(!S.value){y.error("请输入拒绝原因");return}H.value=!0;try{await ae("taskSubmitted.batchConfirmAuditReject",{ids:v.value,reason:S.value}),y.success("审核拒绝成功"),$.value=!1,R.value.forEach(e=>{v.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),v.value=[]}catch(e){y.error(e.message)}finally{H.value=!1}},ke=()=>{if(!v.value.length){y.warning("请选择要拒绝的任务");return}S.value="",$.value=!0},fe=async()=>{const e=await M("channel.list");e.code===0&&(L.value=e.data.list)},ve=()=>{Me.confirm({title:c("common.export"),content:c("common.confirmExportContent"),onOk:async()=>{var e,s;try{const f=y.loading(c("common.exporting"),0),r={taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword};await Ye("taskSubmitted.confirmAuditExport",r,`复审列表_${new Date().toLocaleDateString()}.xlsx`),f(),y.success(c("common.exportSuccess"))}catch(f){console.error("导出失败:",f),y.error(c("common.exportFailed"))}}})},K=async(e="")=>{try{const s=await M("group.list",{page:1,pageSize:50,keyword:e});s.code===0&&(V.value=s.data.list||[])}catch{y.error("获取群组列表失败")}},P=async()=>{var e,s;U.value=!0;try{const f={page:T.current,pageSize:T.pageSize,taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword},r=await M("taskSubmitted.confirmAuditList",{...f});r.code===0?(R.value=r.data.list,T.total=r.data.total,z.value=r.data.totalAmount):y.error(r.message)}finally{U.value=!1}},be=async()=>{if(F.value.length)return;const e=await M("waiter.list",{page:1,pageSize:100});e.code===0&&(F.value=e.data.list||[])};return Re(()=>{oe(),P(),K(),fe(),be()}),(e,s)=>{const f=d("a-input"),r=d("a-form-item"),w=d("a-select-option"),D=d("a-select"),he=d("a-range-picker"),ye=d("a-input-number"),ge=d("a-form"),O=d("a-button"),C=d("a-space"),_e=d("DownloadOutlined"),Te=d("a-avatar"),we=d("a-typography-link"),Ae=d("a-tag"),J=d("a-popconfirm"),Se=d("a-table"),A=d("a-descriptions-item"),Q=d("a-descriptions"),X=d("a-modal"),Ce=d("a-textarea");return u(),p("div",He,[h("div",Fe,[h("div",Pe,[l(ge,{layout:"inline",model:n},{default:a(()=>[l(r,{label:e.$t("submittedTasks.search.taskName")},{default:a(()=>[l(f,{value:n.taskName,"onUpdate:value":s[0]||(s[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.channel")},{default:a(()=>[l(D,{value:n.channelId,"onUpdate:value":s[1]||(s[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,j(L.value,t=>(u(),_(w,{key:t.id,value:t.id},{default:a(()=>[i(o(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.submitTime")},{default:a(()=>[l(he,{value:n.submitTimeRange,"onUpdate:value":s[2]||(s[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[l(D,{value:n.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=t=>n.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,j(se.value,t=>(u(),_(w,{key:t.value,value:t.value},{default:a(()=>[i(o(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.preAuditor")},{default:a(()=>[l(D,{value:n.preWaiterId,"onUpdate:value":s[4]||(s[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:a(()=>[(u(!0),p(g,null,j(F.value,t=>(u(),_(w,{key:t.id,value:t.id},{default:a(()=>[i(o(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.groupId")},{default:a(()=>[l(D,{value:n.groupId,"onUpdate:value":s[5]||(s[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:K},{default:a(()=>[(u(!0),p(g,null,j(V.value,t=>(u(),_(w,{key:t.id,value:t.id},{default:a(()=>[i(o(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[l(ye,{value:n.completedTaskCount,"onUpdate:value":s[6]||(s[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),l(r,{label:e.$t("member.search.keyword")},{default:a(()=>[l(f,{value:n.keyword,"onUpdate:value":s[7]||(s[7]=t=>n.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),h("div",xe,[h("div",null,[l(C,null,{default:a(()=>[l(O,{type:"primary",onClick:q},{default:a(()=>[i(o(e.$t("common.search")),1)]),_:1}),l(O,{onClick:ue},{default:a(()=>[i(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),h("div",null,[l(C,null,{default:a(()=>[R.value.length?(u(),_(O,{key:0,onClick:ve},{icon:a(()=>[l(_e)]),default:a(()=>[i(" "+o(e.$t("common.export")),1)]),_:1})):k("",!0),l(O,{type:"primary",onClick:G},{default:a(()=>[i(o(e.$t("common.batchResolve")),1)]),_:1}),l(O,{danger:"",onClick:ke},{default:a(()=>[i(o(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(Se,{columns:le.value,"data-source":R.value,loading:U.value,pagination:T,"row-selection":ne,rowKey:"id",onChange:ie},{bodyCell:a(({column:t,record:m})=>[t.key==="taskName"?(u(),_(C,{key:0},{default:a(()=>[l(Te,{src:m.channelIcon,size:"small"},null,8,["src"]),h("span",null,o(m.taskName),1)]),_:2},1024)):k("",!0),t.key==="taskAuditStatus"?(u(),p(g,{key:1},[i(o(De(Y).getEnumText("TaskAuditStatus",m.taskAuditStatus)),1)],64)):k("",!0),t.key==="preWaiterName"?(u(),p(g,{key:2},[i(o(m.preWaiterName||"--"),1)],64)):k("",!0),t.key==="preAuditTime"?(u(),p(g,{key:3},[i(o(m.preAuditTime||"--"),1)],64)):k("",!0),t.key==="waiterName"?(u(),p(g,{key:4},[i(o(m.waiterName||"--"),1)],64)):k("",!0),t.key==="confirmAuditTime"?(u(),p(g,{key:5},[i(o(m.auditTime||"--"),1)],64)):k("",!0),t.key==="member"?(u(),p(g,{key:6},[h("div",null,[l(C,null,{default:a(()=>[l(we,{onClick:I=>re(m)},{default:a(()=>[i(o(m.nickname),1)]),_:2},1032,["onClick"]),m.isNew?(u(),_(Ae,{key:0,color:"green"},{default:a(()=>s[11]||(s[11]=[i("new")])),_:1})):k("",!0)]),_:2},1024)]),h("div",null,o(m.account),1),(u(!0),p(g,null,j(m.groups,I=>(u(),p("div",null,[l(C,null,{default:a(()=>[h("span",null,o(I.groupName),1),I.isOwner?(u(),_(Ue,{key:0})):k("",!0)]),_:2},1024)]))),256))],64)):k("",!0),t.key==="action"?(u(),_(C,{key:7},{default:a(()=>[h("a",{onClick:I=>de(m)},o(e.$t("submittedTasks.list.view")),9,Be),m.taskAuditStatus==="pending"?(u(),_(J,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:I=>ce(m)},{default:a(()=>[h("a",null,o(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):k("",!0),m.taskAuditStatus==="pending"?(u(),_(J,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:I=>me(m)},{default:a(()=>[h("a",Le,o(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):k("",!0)]),_:2},1024)):k("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),T.total?(u(),p("div",Ve,[l(Q,{column:2},{default:a(()=>[l(A,{label:e.$t("common.totalCount")},{default:a(()=>[i(o(T.total),1)]),_:1},8,["label"]),l(A,{label:e.$t("common.totalAmount")},{default:a(()=>[i(o(z.value),1)]),_:1},8,["label"])]),_:1})])):k("",!0)]),l(X,{open:x.value,"onUpdate:open":s[8]||(s[8]=t=>x.value=t),title:"任务详情",footer:null},{default:a(()=>[l(Q,{column:1},{default:a(()=>[l(A,{label:"任务名称"},{default:a(()=>{var t;return[i(o((t=N.value)==null?void 0:t.taskName),1)]}),_:1}),l(A,{label:"任务类型"},{default:a(()=>{var t;return[i(o((t=N.value)==null?void 0:t.taskType),1)]}),_:1}),l(A,{label:"任务描述"},{default:a(()=>{var t;return[i(o((t=N.value)==null?void 0:t.description),1)]}),_:1}),l(A,{label:"任务奖励"},{default:a(()=>{var t;return[i(o((t=N.value)==null?void 0:t.reward),1)]}),_:1}),l(A,{label:"创建时间"},{default:a(()=>{var t;return[i(o((t=N.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(X,{open:$.value,"onUpdate:open":s[10]||(s[10]=t=>$.value=t),title:"拒绝原因",onOk:pe,confirmLoading:H.value},{default:a(()=>[l(Ce,{value:S.value,"onUpdate:value":s[9]||(s[9]=t=>S.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Xe=Ie(ze,[["__scopeId","data-v-16ef651c"]]);export{Xe as default};
