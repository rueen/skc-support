import{i as d,j as B,_ as te,k as ae,r as P,a as E,l as ne,b as N,d as b,c as r,w as n,e as p,f as se,o as f,F,m as M,n as S,h,t as U,g as w,D as oe,P as le,p as R,M as re}from"./index-Be5aNowM.js";import{T as L,g as ce,a as ie,b as de}from"./enums-Vx4wKXVy.js";import{c as $,a as ue,g as z,d as pe}from"./request-CYM1fdgd.js";const me=(k,g={},x="",m={})=>{const s=ue.create({baseURL:$.baseUrl,timeout:6e4,responseType:"blob"});return s.interceptors.request.use(o=>{const e=B.get("token");return e&&(o.headers.Authorization=`Bearer ${e}`),o},o=>(console.error("下载请求错误:",o),Promise.reject(o))),s({url:k,method:"get",params:g,...m}).then(o=>{let e=x;if(!e){const _=o.headers["content-disposition"];if(_){const v=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(_);if(v&&v[1]){e=v[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(D){console.error("文件名解码失败:",D)}}}if(!e){const u=o.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const i=new Blob([o.data]),l=document.createElement("a");return l.href=URL.createObjectURL(i),l.download=e,document.body.appendChild(l),l.click(),URL.revokeObjectURL(l.href),document.body.removeChild(l),{success:!0,filename:e}}).catch(o=>{let e="下载失败";if(o.response)if(o.response.status===401)e="登录已过期，请重新登录",B.remove("token"),window.location.href="/login";else try{const i=new FileReader;i.onload=()=>{try{e=JSON.parse(i.result).message||"下载失败",d.error(e)}catch{d.error("下载失败")}},i.readAsText(o.response.data)}catch{d.error("下载失败")}else d.error(e);return Promise.reject(o)})},fe=(k,g={},x="",m={})=>{const[s,o]=k.split("."),e=$.api[s]&&$.api[s][o];if(!e)return console.error(`API ${k} 不存在`),d.error(`API ${k} 不存在`),Promise.reject(new Error(`API ${k} 不存在`));let i=e;return m.urlParams&&(i=i.replace(/:([^/]+)/g,(l,_)=>{const u=m.urlParams[_];return u===void 0?(console.warn(`URL 参数 ${_} 未提供`),l):u})),me(i,g,x,m)},_e={class:"task content-container"},ke={class:"table-container"},he={class:"table-header"},ge={class:"left"},ve={class:"right"},ye=["onClick"],xe={__name:"list",setup(k){const g=se(),{locale:x}=ae(),m=P(!1),s=E({taskName:"",channelId:void 0,taskStatus:void 0}),o=P([]),e=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"action",fixed:"right",width:180}],i=P([]),l=E({current:1,pageSize:10,total:0}),_=t=>ce(ie,t,x.value),u=t=>de[t],v=()=>{l.current=1,T()},D=()=>{s.taskName="",s.channelId=void 0,s.taskStatus=void 0,v()},V=t=>{Object.assign(l,t),T()},q=()=>{g.push("/task/create")},J=t=>{g.push(`/task/edit/${t.id}`)},G=async t=>{try{const a=await pe("task.delete",{},{urlParams:{id:t.id}});a.code===0?(d.success("删除成功"),T()):d.error(a.message)}catch{d.error("删除失败")}},H=()=>{re.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const t=d.loading("正在导出数据，请稍候...",0),a={taskName:s.taskName,channelId:s.channelId,taskStatus:s.taskStatus};await fe("task.export",a,`任务列表_${new Date().toLocaleDateString()}.xlsx`),t(),d.success("导出成功")}catch(t){console.error("导出失败:",t),d.error("导出失败，请稍后重试")}}})},T=async()=>{m.value=!0;try{const t=await z("task.list",{page:l.current,pageSize:l.pageSize,...s});t.code===0?(i.value=t.data.list,l.total=t.data.total):d.error(t.message)}finally{m.value=!1}},K=async()=>{const t=await z("channel.list");t.code===0&&(o.value=t.data.list)};return ne(()=>{T(),K()}),(t,a)=>{const Q=p("a-input"),C=p("a-form-item"),A=p("a-select-option"),j=p("a-select"),I=p("a-button"),O=p("a-space"),W=p("a-form"),X=p("a-tag"),Y=p("a-popconfirm"),Z=p("a-table");return f(),N("div",_e,[b("div",ke,[b("div",he,[b("div",ge,[r(W,{layout:"inline",model:s},{default:n(()=>[r(C,{label:"任务名称"},{default:n(()=>[r(Q,{value:s.taskName,"onUpdate:value":a[0]||(a[0]=c=>s.taskName=c),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),r(C,{label:"平台渠道"},{default:n(()=>[r(j,{value:s.channelId,"onUpdate:value":a[1]||(a[1]=c=>s.channelId=c),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:n(()=>[(f(!0),N(F,null,M(o.value,c=>(f(),S(A,{key:c.id,value:c.id},{default:n(()=>[h(U(c.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(C,{label:"任务状态"},{default:n(()=>[r(j,{value:s.taskStatus,"onUpdate:value":a[2]||(a[2]=c=>s.taskStatus=c),placeholder:"请选择状态",style:{width:"120px"},"allow-clear":""},{default:n(()=>[(f(!0),N(F,null,M(Object.values(w(L)),c=>(f(),S(A,{key:c,value:c},{default:n(()=>[h(U(_(c)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(C,null,{default:n(()=>[r(O,null,{default:n(()=>[r(I,{type:"primary",onClick:v},{default:n(()=>a[3]||(a[3]=[h("查询")])),_:1}),r(I,{onClick:D},{default:n(()=>a[4]||(a[4]=[h("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),b("div",ve,[r(O,null,{default:n(()=>[r(I,{onClick:H},{icon:n(()=>[r(w(oe))]),default:n(()=>[a[5]||(a[5]=h(" 导出 "))]),_:1}),r(I,{type:"primary",onClick:q},{icon:n(()=>[r(w(le))]),default:n(()=>[a[6]||(a[6]=h(" 新建任务 "))]),_:1})]),_:1})])]),r(Z,{columns:e,"data-source":i.value,loading:m.value,pagination:l,onChange:V},{bodyCell:n(({column:c,record:y})=>[c.key==="taskStatus"?(f(),S(X,{key:0,color:u(y.taskStatus)},{default:n(()=>[h(U(_(y.taskStatus)),1)]),_:2},1032,["color"])):R("",!0),c.key==="action"?(f(),S(O,{key:1},{default:n(()=>[y.taskStatus===w(L).NOT_STARTED?(f(),N("a",{key:0,onClick:ee=>J(y)},"编辑",8,ye)):R("",!0),y.taskStatus===w(L).NOT_STARTED?(f(),S(Y,{key:1,title:"确定要删除该任务吗？",onConfirm:ee=>G(y)},{default:n(()=>a[7]||(a[7]=[b("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])):R("",!0)]),_:2},1024)):R("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},Te=te(xe,[["__scopeId","data-v-fb46a88f"]]);export{Te as default};
