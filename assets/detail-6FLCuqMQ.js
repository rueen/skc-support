import{_ as ie,c as oe,r as _,e as q,d as x,G as te,p as se,n as z,o as m,w as s,g as M,f as b,x as N,h as l,i as c,k as C,t as f,F as de,q as ae,v as T,D as re,z as ke,A as ee,j as ge,l as _e,B as he,C as ye}from"./index-BknH-23p.js";import{P as be}from"./PageHeader-BgqNhcCq.js";import{S as Te}from"./SelectTask-DiXWXII6.js";const Ie={class:"select-task-group-modal"},$e={class:"filter-form"},Ce={key:0,class:"selected-info"},we={key:1,class:"selected-info"},Ge={__name:"SelectTaskGroup",props:{visible:{type:Boolean,default:!1},selectedId:{type:[Array,Number,String],default:()=>[]},selectedTaskGroupInfo:{type:Object,default:()=>({})},mode:{type:String,default:"multiple",validator:P=>["multiple","single"].includes(P)}},emits:["update:visible","confirm","cancel"],setup(P,{emit:I}){const{t:w}=oe(),o=P,G=I,h=_(!1),F=_(!1),d=_([]),e=_(null),v=q({taskGroupName:"",taskName:""}),V=x(()=>[{title:w("task.group.name"),dataIndex:"taskGroupName",key:"taskGroupName",width:200},{title:w("task.group.statistics"),key:"statistics",width:120},{title:w("task.group.createTime"),dataIndex:"createTime",key:"createTime",sorter:!0},{title:w("task.group.updateTime"),dataIndex:"updateTime",key:"updateTime",sorter:!0}]),$=_([]),k=q({current:1,pageSize:10,total:0}),R=q({sorterField:void 0,sorterOrder:void 0}),B=x(()=>o.mode==="single"?{type:"radio",selectedRowKeys:d.value,onChange:(i,t)=>{E(i,t)},getCheckboxProps:i=>({disabled:!1})}:{selectedRowKeys:d.value,onChange:(i,t)=>{K(i)},getCheckboxProps:i=>({disabled:!1})}),E=(i,t)=>{d.value=i||[],e.value=t&&t.length>0?t[0]:null},K=(i,t)=>{const r=$.value.map(y=>y.id),p=d.value.filter(y=>!r.includes(y));d.value=[...p,...i]},D=()=>{k.current=1,Y()},W=()=>{v.taskGroupName="",v.taskName="",D()},O=(i,t,r)=>{Object.assign(k,i),Object.assign(R,{sorterField:r.field,sorterOrder:r.order}),Y()},J=()=>{o.mode==="single"?G("confirm",{taskGroupId:d.value[0]||null,taskGroup:e.value}):G("confirm",{taskGroupIds:d.value}),j()},j=()=>{G("update:visible",!1),G("cancel")},Y=async()=>{h.value=!0;try{const i=await ae("taskGroup.list",{page:k.current,pageSize:k.pageSize,...R,...v});if(i.code===0){if($.value=i.data.list,k.total=i.data.total,o.mode==="single"&&d.value.length>0&&!e.value){const t=d.value[0],r=$.value.find(p=>p.id===t);r&&(e.value=r)}}else T.error(i.message)}finally{h.value=!1}},L=()=>{if(o.mode==="single"){let i=null;if(Array.isArray(o.selectedId)?i=o.selectedId.length>0?o.selectedId[0]:null:i=o.selectedId,i!=null&&i!==""){d.value=[i];const t=$.value.find(r=>r.id===i);t?e.value=t:e.value=o.selectedTaskGroupInfo}else d.value=[],e.value=null}else o.selectedId&&o.selectedId.length>0?d.value=Array.isArray(o.selectedId)?[...o.selectedId]:[o.selectedId]:d.value=[]};return te(()=>o.visible,i=>{i?(Y(),L()):(d.value=[],o.mode==="single"&&(e.value=null),k.current=1)}),te(()=>o.selectedId,()=>{o.visible&&L()},{deep:!0}),se(()=>{o.visible&&(Y(),L())}),(i,t)=>{const r=c("a-input"),p=c("a-form-item"),y=c("a-button"),A=c("a-space"),Q=c("a-form"),a=c("a-alert"),n=c("a-table"),S=c("a-modal");return m(),z(S,{open:P.visible,title:i.$t("task.selectTaskGroup.title"),width:900,"confirm-loading":F.value,onOk:J,onCancel:j},{default:s(()=>[M("div",Ie,[M("div",$e,[l(Q,{layout:"inline",model:v},{default:s(()=>[l(p,{label:i.$t("task.search.taskGroupName")},{default:s(()=>[l(r,{value:v.taskGroupName,"onUpdate:value":t[0]||(t[0]=g=>v.taskGroupName=g),placeholder:i.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(p,{label:i.$t("task.search.taskName")},{default:s(()=>[l(r,{value:v.taskName,"onUpdate:value":t[1]||(t[1]=g=>v.taskName=g),placeholder:i.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(p,null,{default:s(()=>[l(A,null,{default:s(()=>[l(y,{type:"primary",onClick:D},{default:s(()=>[C(f(i.$t("common.search")),1)]),_:1}),l(y,{onClick:W},{default:s(()=>[C(f(i.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),o.mode==="multiple"?(m(),b("div",Ce,[l(a,{message:i.$t("task.selectTaskGroup.selectedCount",{count:d.value.length}),type:"info","show-icon":""},null,8,["message"])])):N("",!0),o.mode==="single"&&e.value?(m(),b("div",we,[l(a,{message:i.$t("task.selectTaskGroup.selectedTaskGroup",{name:e.value.taskGroupName}),type:"info","show-icon":""},null,8,["message"])])):N("",!0),l(n,{columns:V.value,"data-source":$.value,loading:h.value,pagination:k,"row-selection":B.value,rowKey:"id",onChange:O,size:"middle"},{bodyCell:s(({column:g,record:U})=>[g.key==="statistics"?(m(),b(de,{key:0},[C(f(U.enrolledCount)+"/"+f(U.completedCount),1)],64)):N("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},Se=ie(Ge,[["__scopeId","data-v-a529a67c"]]),Ne={class:"select-article-modal"},Ae={class:"filter-form"},Ue={key:0,class:"selected-info"},Pe={key:1,class:"selected-info"},De={key:0,class:"content-preview"},Le=["onClick"],Ye={__name:"SelectArticle",props:{visible:{type:Boolean,default:!1},selectedId:{type:[Array,Number,String],default:()=>[]},selectedArticleInfo:{type:Object,default:()=>({})},mode:{type:String,default:"multiple",validator:P=>["multiple","single"].includes(P)}},emits:["update:visible","confirm","cancel"],setup(P,{emit:I}){const{t:w}=oe(),o=P,G=I,h=_(!1),F=_(!1),d=_([]),e=_(null),v=q({title:"",location:""}),V=x(()=>[{title:w("article.title"),dataIndex:"title",key:"title",width:200},{title:w("article.updateTime"),dataIndex:"updateTime",key:"updateTime",width:180},{title:w("article.action"),key:"action",width:100}]),$=_([]),k=q({current:1,pageSize:10,total:0}),R=q({sorterField:void 0,sorterOrder:void 0}),B=x(()=>o.mode==="single"?{type:"radio",selectedRowKeys:d.value,onChange:(t,r)=>{E(t,r)},getCheckboxProps:t=>({disabled:!1})}:{selectedRowKeys:d.value,onChange:(t,r)=>{K(t)},getCheckboxProps:t=>({disabled:!1})}),E=(t,r)=>{d.value=t||[],e.value=r&&r.length>0?r[0]:null},K=(t,r)=>{const p=$.value.map(A=>A.id),y=d.value.filter(A=>!p.includes(A));d.value=[...y,...t]},D=()=>{k.current=1,L()},W=()=>{v.title="",v.location="",D()},O=(t,r,p)=>{Object.assign(k,t),Object.assign(R,{sorterField:p.field,sorterOrder:p.order}),L()},J=t=>{window.open(`${re.h5Url}/article/${t.id}`,"_blank")},j=()=>{o.mode==="single"?G("confirm",{articleId:d.value[0]||null,article:e.value}):G("confirm",{articleIds:d.value}),Y()},Y=()=>{G("update:visible",!1),G("cancel")},L=async()=>{h.value=!0;try{const t=await ae("article.list",{page:k.current,pageSize:k.pageSize,...R,...v});if(t.code===0){if($.value=t.data.list,k.total=t.data.total,o.mode==="single"&&d.value.length>0&&!e.value){const r=d.value[0],p=$.value.find(y=>y.id===r);p&&(e.value=p)}}else T.error(t.message)}finally{h.value=!1}},i=()=>{if(o.mode==="single"){let t=null;if(Array.isArray(o.selectedId)?t=o.selectedId.length>0?o.selectedId[0]:null:t=o.selectedId,t!=null&&t!==""){d.value=[t];const r=$.value.find(p=>p.id===t);r?e.value=r:e.value=o.selectedArticleInfo}else d.value=[],e.value=null}else o.selectedId&&o.selectedId.length>0?d.value=Array.isArray(o.selectedId)?[...o.selectedId]:[o.selectedId]:d.value=[]};return te(()=>o.visible,t=>{t?(L(),i()):(d.value=[],o.mode==="single"&&(e.value=null),k.current=1)}),te(()=>o.selectedId,()=>{o.visible&&i()},{deep:!0}),se(()=>{o.visible&&(L(),i())}),(t,r)=>{const p=c("a-input"),y=c("a-form-item"),A=c("a-button"),Q=c("a-space"),a=c("a-form"),n=c("a-alert"),S=c("a-table"),g=c("a-modal");return m(),z(g,{open:P.visible,title:t.$t("article.selectArticle.title"),width:900,"confirm-loading":F.value,onOk:j,onCancel:Y},{default:s(()=>[M("div",Ne,[M("div",Ae,[l(a,{layout:"inline",model:v},{default:s(()=>[l(y,{label:t.$t("article.title")},{default:s(()=>[l(p,{value:v.title,"onUpdate:value":r[0]||(r[0]=U=>v.title=U),placeholder:t.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(y,{label:t.$t("article.location")},{default:s(()=>[l(p,{value:v.location,"onUpdate:value":r[1]||(r[1]=U=>v.location=U),placeholder:t.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(y,null,{default:s(()=>[l(Q,null,{default:s(()=>[l(A,{type:"primary",onClick:D},{default:s(()=>[C(f(t.$t("common.search")),1)]),_:1}),l(A,{onClick:W},{default:s(()=>[C(f(t.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),o.mode==="multiple"?(m(),b("div",Ue,[l(n,{message:t.$t("article.selectArticle.selectedCount",{count:d.value.length}),type:"info","show-icon":""},null,8,["message"])])):N("",!0),o.mode==="single"&&e.value?(m(),b("div",Pe,[l(n,{message:t.$t("article.selectArticle.selectedArticle",{title:e.value.title}),type:"info","show-icon":""},null,8,["message"])])):N("",!0),l(S,{columns:V.value,"data-source":$.value,loading:h.value,pagination:k,"row-selection":B.value,rowKey:"id",onChange:O,size:"middle"},{bodyCell:s(({column:U,record:H})=>[U.key==="content"?(m(),b("div",De,f(H.content.length>50?H.content.substring(0,50)+"...":H.content),1)):N("",!0),U.key==="action"?(m(),b("a",{key:1,onClick:le=>J(H)},f(t.$t("article.preview")),9,Le)):N("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},Be=ie(Ye,[["__scopeId","data-v-e15b9aed"]]),Oe={class:"content-container"},Re={class:"form-container"},ze={key:0},qe={style:{"margin-top":"10px"}},Me={key:0},Fe={key:1},je={key:0},He={key:1},Ve={key:0},Ee={key:1},Qe={__name:"detail",setup(P){const{t:I}=oe(),w=ke(),o=ge(),G=_(),h=_([]),F={action:re.imageUploadUrl,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}},d=x(()=>w.name==="AdEdit"),e=q({title:"",location:"home_banner",startTime:void 0,endTime:void 0,content:{adImage:"",linkType:"none",articleId:null,articleName:null,taskId:null,taskName:null,taskGroupId:null,taskGroupName:null,externalLinks:null}}),v={title:[{required:!0,message:I("ad.detail.validation.titleRequired")}],location:[{required:!0,message:I("ad.detail.validation.locationRequired")}],startTime:[{required:!0,message:I("ad.detail.validation.startTimeRequired")}],endTime:[{required:!0,message:I("ad.detail.validation.endTimeRequired")}]},V=a=>{a.file.status==="removed"&&(e.content.adImage="")},$=a=>{a.code===0?(e.content.adImage=a.data.url,h.value=[{uid:"-1",name:"image.png",status:"done",url:e.content.adImage}],T.success("上传成功")):(T.error(response.message||"上传失败"),h.value=h.value.filter(n=>n.uid!==file.uid))},k=()=>{T.error("上传失败"),h.value=[]},R=a=>a.type.startsWith("image/")?a.size/1024/1024<1?!0:(T.error("图片必须小于 1MB！"),!1):(T.error("只能上传图片文件！"),!1),B=_(!1),E=()=>{B.value=!0},K=({taskId:a,task:n})=>{a&&n&&(e.content.taskId=a,e.content.taskName=n.taskName,B.value=!1)},D=_(!1),W=()=>{D.value=!0},O=_(!1),J=()=>{O.value=!0},j=({taskGroupId:a,taskGroup:n})=>{a&&n&&(e.content.taskGroupId=a,e.content.taskGroupName=n.taskGroupName,O.value=!1)},Y=({articleId:a,article:n})=>{a&&n&&(e.content.articleId=a,e.content.articleName=n.title,D.value=!1)},L=async a=>{try{t.value=!0;const n=await ye("ad.add",a);n.code===0?(T.success(I("common.submitSuccess")),o.back()):T.error(n.message)}catch(n){console.log(n),T.error(I("common.submitFailed"))}finally{t.value=!1}},i=async a=>{try{t.value=!0;const n=await he("ad.edit",{...a},{urlParams:{id:w.params.id}});n.code===0?(T.success(I("common.submitSuccess")),o.back()):T.error(n.message)}catch(n){console.log(n),T.error(I("common.submitFailed"))}finally{t.value=!1}},t=_(!1),r=()=>{G.value.validate().then(async()=>{if(!e.content.adImage){T.error(I("ad.detail.validation.adImageRequired"));return}const a={...e,startTime:e.startTime?ee(e.startTime).format("YYYY-MM-DD HH:mm:ss"):null,endTime:e.endTime?ee(e.endTime).format("YYYY-MM-DD HH:mm:ss"):null};d.value?await i(a):await L(a)})},p=()=>{o.back()},y=async a=>{try{const n=await ae("ad.detail",{},{urlParams:{id:a}});if(n.code===0){const S=n.data;Object.assign(e,S,{startTime:ee(S.startTime),endTime:ee(S.endTime)}),h.value=[{uid:"-1",name:"image.png",status:"done",url:S.content.adImage}]}}catch(n){console.log(n),T.error(n)}},A=_([]),Q=async()=>{try{const a=await ae("public.location",{});a.code===0&&(A.value=a.data||[])}catch(a){console.log(a)}};return se(()=>{Q(),d.value&&y(w.params.id)}),(a,n)=>{const S=c("a-input"),g=c("a-form-item"),U=c("a-select-option"),H=c("a-select"),le=c("a-date-picker"),ne=c("a-col"),ce=c("a-row"),ue=c("plus-outlined"),me=c("a-upload"),X=c("a-radio"),pe=c("a-radio-group"),Z=c("a-button"),fe=c("a-space"),ve=c("a-form");return m(),b("div",Oe,[l(be,{title:d.value?a.$t("ad.detail.editTitle"):a.$t("ad.detail.createTitle"),back:!0,class:"page-header"},null,8,["title"]),M("div",Re,[l(ve,{ref_key:"formRef",ref:G,model:e,rules:v,"label-col":{span:5},"wrapper-col":{span:18},layout:"horizontal"},{default:s(()=>[l(g,{label:a.$t("ad.detail.title"),name:"title"},{default:s(()=>[l(S,{value:e.title,"onUpdate:value":n[0]||(n[0]=u=>e.title=u),placeholder:a.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),l(g,{label:a.$t("ad.detail.location"),name:"location"},{default:s(()=>[l(H,{value:e.location,"onUpdate:value":n[1]||(n[1]=u=>e.location=u),placeholder:a.$t("common.selectPlaceholder")},{default:s(()=>[(m(!0),b(de,null,_e(A.value,u=>(m(),z(U,{key:u.code,value:u.code},{default:s(()=>[C(f(u.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(g,{label:a.$t("ad.detail.adTime"),required:""},{default:s(()=>[l(ce,{gutter:8},{default:s(()=>[l(ne,{span:11},{default:s(()=>[l(g,{name:"startTime"},{default:s(()=>[l(le,{value:e.startTime,"onUpdate:value":n[2]||(n[2]=u=>e.startTime=u),"show-time":"",style:{width:"100%"},placeholder:a.$t("ad.detail.startTime"),format:"YYYY-MM-DD HH:mm:ss"},null,8,["value","placeholder"])]),_:1})]),_:1}),l(ne,{span:2,style:{"text-align":"center","line-height":"32px"}},{default:s(()=>n[10]||(n[10]=[M("span",null,"至",-1)])),_:1}),l(ne,{span:11},{default:s(()=>[l(g,{name:"endTime"},{default:s(()=>[l(le,{value:e.endTime,"onUpdate:value":n[3]||(n[3]=u=>e.endTime=u),"show-time":"",style:{width:"100%"},placeholder:a.$t("ad.detail.endTime"),format:"YYYY-MM-DD HH:mm:ss"},null,8,["value","placeholder"])]),_:1})]),_:1})]),_:1})]),_:1},8,["label"]),l(g,{label:a.$t("ad.detail.adImage"),required:""},{default:s(()=>[l(me,{"file-list":h.value,"onUpdate:fileList":n[4]||(n[4]=u=>h.value=u),action:F.action,headers:F.headers,"before-upload":R,onSuccess:$,onError:k,onChange:V,accept:"image/*","list-type":"picture-card","max-count":1},{default:s(()=>[h.value.length?N("",!0):(m(),b("div",ze,[l(ue)]))]),_:1},8,["file-list","action","headers"])]),_:1},8,["label"]),l(g,{label:a.$t("ad.detail.link"),required:""},{default:s(()=>[l(pe,{value:e.content.linkType,"onUpdate:value":n[5]||(n[5]=u=>e.content.linkType=u),name:"linkType"},{default:s(()=>[l(X,{value:"none"},{default:s(()=>[C(f(a.$t("ad.detail.linkType.none")),1)]),_:1}),l(X,{value:"article"},{default:s(()=>[C(f(a.$t("ad.detail.linkType.article")),1)]),_:1}),l(X,{value:"task"},{default:s(()=>[C(f(a.$t("ad.detail.linkType.task")),1)]),_:1}),l(X,{value:"taskGroup"},{default:s(()=>[C(f(a.$t("ad.detail.linkType.taskGroup")),1)]),_:1}),l(X,{value:"externalLinks"},{default:s(()=>[C(f(a.$t("ad.detail.linkType.externalLinks")),1)]),_:1})]),_:1},8,["value"]),M("div",qe,[e.content.linkType==="article"?(m(),z(Z,{key:0,type:"primary",onClick:W},{default:s(()=>[e.content.articleId!=null?(m(),b("span",Me,f(a.$t("ad.detail.selectArticleBtnText",{name:e.content.articleName})),1)):(m(),b("span",Fe,f(a.$t("ad.detail.selectArticleBtnText1")),1))]),_:1})):N("",!0),e.content.linkType==="task"?(m(),z(Z,{key:1,type:"primary",onClick:E},{default:s(()=>[e.content.taskId!=null?(m(),b("span",je,f(a.$t("ad.detail.selectTaskBtnText",{name:e.content.taskName})),1)):(m(),b("span",He,f(a.$t("ad.detail.selectTaskBtnText1")),1))]),_:1})):N("",!0),e.content.linkType==="taskGroup"?(m(),z(Z,{key:2,type:"primary",onClick:J},{default:s(()=>[e.content.taskGroupId!=null?(m(),b("span",Ve,f(a.$t("ad.detail.selectTaskGroupBtnText",{name:e.content.taskGroupName})),1)):(m(),b("span",Ee,f(a.$t("ad.detail.selectTaskGroupBtnText1")),1))]),_:1})):N("",!0),e.content.linkType==="externalLinks"?(m(),z(g,{key:3,name:"externalLinks"},{default:s(()=>[l(S,{value:e.content.externalLinks,"onUpdate:value":n[6]||(n[6]=u=>e.content.externalLinks=u),placeholder:a.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1})):N("",!0)])]),_:1},8,["label"]),l(g,{"wrapper-col":{span:16,offset:4}},{default:s(()=>[l(fe,null,{default:s(()=>[l(Z,{type:"primary",onClick:r},{default:s(()=>[C(f(a.$t("common.submit")),1)]),_:1}),l(Z,{onClick:p},{default:s(()=>[C(f(a.$t("common.cancel")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),l(Te,{visible:B.value,"onUpdate:visible":n[7]||(n[7]=u=>B.value=u),selectedId:e.content.taskId,selectedTaskInfo:{taskName:e.content.taskName,taskId:e.content.taskId},mode:"single",onConfirm:K},null,8,["visible","selectedId","selectedTaskInfo"]),l(Se,{visible:O.value,"onUpdate:visible":n[8]||(n[8]=u=>O.value=u),selectedId:e.content.taskGroupId,selectedTaskGroupInfo:{taskGroupName:e.content.taskGroupName,taskGroupId:e.content.taskGroupId},mode:"single",onConfirm:j},null,8,["visible","selectedId","selectedTaskGroupInfo"]),l(Be,{visible:D.value,"onUpdate:visible":n[9]||(n[9]=u=>D.value=u),selectedId:e.content.articleId,selectedArticleInfo:{title:e.content.articleName,id:e.content.articleId},mode:"single",onConfirm:Y},null,8,["visible","selectedId","selectedArticleInfo"])])}}};export{Qe as default};
