import{_ as Ae,a as Ce,b as Ie,j as Q,r as k,c as X,k as $e,d as h,e as f,f as n,w as s,g as i,x as Ne,h as Re,l as E,m as v,o as u,F as _,n as O,p as g,i as r,t as o,s as y,q as Oe,M as je,A as Z}from"./index-vUqQ2LA3.js";import{d as De}from"./download-2rF-yjEE.js";import{d as Ee,e as We}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Ue}from"./GroupOwner-DTII3wXl.js";const Fe={class:"task-audit content-container"},Me={class:"table-container"},xe={class:"table-header"},Pe={style:{width:"100%",display:"flex","justify-content":"space-between"}},Ye=["onClick"],Be={class:"danger"},Le={__name:"confirm-audit-list",setup(Ve){const W=Ce(),{t:m}=Ie(),ee=Q(()=>W.loaded?W.getEnumOptions("TaskAuditStatus"):[]),U=Re(),F=Ne(),M=k(!1),B=k(!1),C=k(!1),x=k(!1),w=k(""),I=k(null),p=k([]),P=k([]),l=X({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),L=k([]),V=k([]),te=Q(()=>[{title:m("submittedTasks.list.taskName"),key:"taskName"},{title:m("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:m("submittedTasks.list.memberInfo"),key:"member"},{title:m("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:m("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:m("submittedTasks.list.confirmAuditor"),key:"waiterName"},{title:m("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),$=k([]),T=X({current:1,pageSize:10,total:0}),ae={selectedRowKeys:p,onChange:e=>{p.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},z=k(null),se=()=>{const e=F.query.filters;if(e){z.value=Ee(e),Object.assign(l,{taskAuditStatus:null},z.value);const a={...F.query};delete a.filters,U.replace({path:F.path,query:a})}},H=()=>{T.current=1,Y()},le=()=>{Object.assign(l,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),H()},ne=e=>{Object.assign(T,e),Y()},oe=e=>{U.push(`/member/view/${e.memberId}`)},ue=e=>{var b,d;const a=We({...l,submitStartTime:(b=l.submitTimeRange)==null?void 0:b[0],submitEndTime:(d=l.submitTimeRange)==null?void 0:d[1],submitTimeRange:void 0});U.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:a}})},ie=async e=>{p.value=[e.id],q()},q=async()=>{if(!p.value.length){v.warning(m("submittedTasks.list.selectTask"));return}const e=await Z("taskSubmitted.batchConfirmAuditApprove",{ids:p.value});e.code===0?(v.success(m("submittedTasks.resolveSuccess")),$.value.forEach(a=>{p.value.includes(a.id)&&(a.taskAuditStatus="approved")}),p.value=[]):v.error(e.message)},re=e=>{p.value=[e.id],w.value="",C.value=!0},de=async()=>{if(!w.value){v.error("请输入拒绝原因");return}x.value=!0;try{await Z("taskSubmitted.batchConfirmAuditReject",{ids:p.value,reason:w.value}),v.success("审核拒绝成功"),C.value=!1,$.value.forEach(e=>{p.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),p.value=[]}catch(e){v.error(e.message)}finally{x.value=!1}},ce=()=>{if(!p.value.length){v.warning("请选择要拒绝的任务");return}w.value="",C.value=!0},me=async()=>{const e=await E("channel.list");e.code===0&&(L.value=e.data.list)},pe=()=>{je.confirm({title:m("common.export"),content:m("common.confirmExportContent"),onOk:async()=>{var e,a;try{const b=v.loading(m("common.exporting"),0),d={taskName:l.taskName,channelId:l.channelId,taskAuditStatus:l.taskAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(e=l.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=l.submitTimeRange)==null?void 0:a[1],completedTaskCount:l.completedTaskCount,keyword:l.keyword};await De("taskSubmitted.confirmAuditExport",d,`复审列表_${new Date().toLocaleDateString()}.xlsx`),b(),v.success(m("common.exportSuccess"))}catch(b){console.error("导出失败:",b),v.error(m("common.exportFailed"))}}})},G=async(e="")=>{try{const a=await E("group.list",{page:1,pageSize:50,keyword:e});a.code===0&&(V.value=a.data.list||[])}catch{v.error("获取群组列表失败")}},Y=async()=>{var e,a;M.value=!0;try{const b={page:T.current,pageSize:T.pageSize,taskName:l.taskName,channelId:l.channelId,taskAuditStatus:l.taskAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(e=l.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=l.submitTimeRange)==null?void 0:a[1],completedTaskCount:l.completedTaskCount,keyword:l.keyword},d=await E("taskSubmitted.confirmAuditList",{...b});d.code===0?($.value=d.data.list,T.total=d.data.total):v.error(d.message)}finally{M.value=!1}},ke=async()=>{if(P.value.length)return;const e=await E("waiter.list",{page:1,pageSize:100});e.code===0&&(P.value=e.data.list||[])};return $e(()=>{se(),Y(),G(),me(),ke()}),(e,a)=>{const b=i("a-input"),d=i("a-form-item"),j=i("a-select-option"),D=i("a-select"),fe=i("a-range-picker"),ve=i("a-input-number"),be=i("a-form"),N=i("a-button"),S=i("a-space"),he=i("DownloadOutlined"),ge=i("a-avatar"),ye=i("a-typography-link"),_e=i("a-tag"),K=i("a-popconfirm"),we=i("a-table"),R=i("a-descriptions-item"),Te=i("a-descriptions"),J=i("a-modal"),Se=i("a-textarea");return u(),h("div",Fe,[f("div",Me,[f("div",xe,[n(be,{layout:"inline",model:l},{default:s(()=>[n(d,{label:e.$t("submittedTasks.search.taskName")},{default:s(()=>[n(b,{value:l.taskName,"onUpdate:value":a[0]||(a[0]=t=>l.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.channel")},{default:s(()=>[n(D,{value:l.channelId,"onUpdate:value":a[1]||(a[1]=t=>l.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(u(!0),h(_,null,O(L.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:s(()=>[r(o(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.submitTime")},{default:s(()=>[n(fe,{value:l.submitTimeRange,"onUpdate:value":a[2]||(a[2]=t=>l.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:s(()=>[n(D,{value:l.taskAuditStatus,"onUpdate:value":a[3]||(a[3]=t=>l.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(u(!0),h(_,null,O(ee.value,t=>(u(),g(j,{key:t.value,value:t.value},{default:s(()=>[r(o(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.preAuditor")},{default:s(()=>[n(D,{value:l.preWaiterId,"onUpdate:value":a[4]||(a[4]=t=>l.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:s(()=>[(u(!0),h(_,null,O(P.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:s(()=>[r(o(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.groupId")},{default:s(()=>[n(D,{value:l.groupId,"onUpdate:value":a[5]||(a[5]=t=>l.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:G},{default:s(()=>[(u(!0),h(_,null,O(V.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:s(()=>[r(o(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(d,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:s(()=>[n(ve,{value:l.completedTaskCount,"onUpdate:value":a[6]||(a[6]=t=>l.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),n(d,{label:e.$t("member.search.keyword")},{default:s(()=>[n(b,{value:l.keyword,"onUpdate:value":a[7]||(a[7]=t=>l.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),f("div",Pe,[f("div",null,[n(S,null,{default:s(()=>[n(N,{type:"primary",onClick:H},{default:s(()=>[r(o(e.$t("common.search")),1)]),_:1}),n(N,{onClick:le},{default:s(()=>[r(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),f("div",null,[n(S,null,{default:s(()=>[$.value.length?(u(),g(N,{key:0,onClick:pe},{icon:s(()=>[n(he)]),default:s(()=>[r(" "+o(e.$t("common.export")),1)]),_:1})):y("",!0),n(N,{type:"primary",onClick:q},{default:s(()=>[r(o(e.$t("common.batchResolve")),1)]),_:1}),n(N,{danger:"",onClick:ce},{default:s(()=>[r(o(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(we,{columns:te.value,"data-source":$.value,loading:M.value,pagination:T,"row-selection":ae,rowKey:"id",onChange:ne},{bodyCell:s(({column:t,record:c})=>[t.key==="taskName"?(u(),g(S,{key:0},{default:s(()=>[n(ge,{src:c.channelIcon,size:"small"},null,8,["src"]),f("span",null,o(c.taskName),1)]),_:2},1024)):y("",!0),t.key==="taskAuditStatus"?(u(),h(_,{key:1},[r(o(Oe(W).getEnumText("TaskAuditStatus",c.taskAuditStatus)),1)],64)):y("",!0),t.key==="preWaiterName"?(u(),h(_,{key:2},[r(o(c.preWaiterName||"--"),1)],64)):y("",!0),t.key==="waiterName"?(u(),h(_,{key:3},[r(o(c.waiterName||"--"),1)],64)):y("",!0),t.key==="member"?(u(),h(_,{key:4},[f("div",null,[n(S,null,{default:s(()=>[n(ye,{onClick:A=>oe(c)},{default:s(()=>[r(o(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(u(),g(_e,{key:0,color:"green"},{default:s(()=>a[11]||(a[11]=[r("new")])),_:1})):y("",!0)]),_:2},1024)]),f("div",null,o(c.account),1),(u(!0),h(_,null,O(c.groups,A=>(u(),h("div",null,[n(S,null,{default:s(()=>[f("span",null,o(A.groupName),1),A.isOwner?(u(),g(Ue,{key:0})):y("",!0)]),_:2},1024)]))),256))],64)):y("",!0),t.key==="action"?(u(),g(S,{key:5},{default:s(()=>[f("a",{onClick:A=>ue(c)},o(e.$t("submittedTasks.list.view")),9,Ye),c.taskAuditStatus==="pending"?(u(),g(K,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:A=>ie(c)},{default:s(()=>[f("a",null,o(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):y("",!0),c.taskAuditStatus==="pending"?(u(),g(K,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:A=>re(c)},{default:s(()=>[f("a",Be,o(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):y("",!0)]),_:2},1024)):y("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),n(J,{open:B.value,"onUpdate:open":a[8]||(a[8]=t=>B.value=t),title:"任务详情",footer:null},{default:s(()=>[n(Te,{column:1},{default:s(()=>[n(R,{label:"任务名称"},{default:s(()=>{var t;return[r(o((t=I.value)==null?void 0:t.taskName),1)]}),_:1}),n(R,{label:"任务类型"},{default:s(()=>{var t;return[r(o((t=I.value)==null?void 0:t.taskType),1)]}),_:1}),n(R,{label:"任务描述"},{default:s(()=>{var t;return[r(o((t=I.value)==null?void 0:t.description),1)]}),_:1}),n(R,{label:"任务奖励"},{default:s(()=>{var t;return[r(o((t=I.value)==null?void 0:t.reward),1)]}),_:1}),n(R,{label:"创建时间"},{default:s(()=>{var t;return[r(o((t=I.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),n(J,{open:C.value,"onUpdate:open":a[10]||(a[10]=t=>C.value=t),title:"拒绝原因",onOk:de,confirmLoading:x.value},{default:s(()=>[n(Se,{value:w.value,"onUpdate:value":a[9]||(a[9]=t=>w.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Ke=Ae(Le,[["__scopeId","data-v-47d2335e"]]);export{Ke as default};
