import{_ as te,a as ue,b as se,r as _,c as Q,j as O,B as ae,k as le,p as B,o as f,w as o,e as N,f as s,g as c,d as Y,n as W,F,i as w,t as k,s as U,q as de,l as X,m as T,x as me,y as P,h as pe,z as fe,A as ke}from"./index-DnOUOQCB.js";import{P as ve}from"./PageHeader-CQx10F3U.js";const _e={class:"select-task-modal"},he={class:"filter-form"},ge={class:"selected-info"},be={key:1},ye={__name:"SelectTask",props:{visible:{type:Boolean,default:!1},selectedId:{type:Array,default:()=>[]}},emits:["update:visible","confirm","cancel"],setup(q,{emit:h}){const S=ue(),{t:I}=se(),m=q,C=h,$=_(!1),g=_(!1),p=_([]),a=_([]),d=Q({taskName:"",channelId:void 0,taskStatus:void 0}),M=_([]),V=O(()=>S.loaded?S.getEnumOptions("TaskStatus"):[]),j=O(()=>[{title:I("task.list.name"),key:"taskName",width:200},{title:I("task.list.status"),key:"taskStatus",width:100},{title:I("task.list.time"),key:"taskTime",width:200}]),D=_([]),b=Q({current:1,pageSize:10,total:0}),L=O(()=>({selectedRowKeys:a.value,onChange:(e,i)=>{R(e,i)},getCheckboxProps:e=>({disabled:!1})})),R=(e,i)=>{a.value=e;const y=D.value.map(n=>n.id);p.value=p.value.filter(n=>!y.includes(n.id)),p.value=[...p.value,...i]},E=()=>{b.current=1,u()},A=()=>{d.taskName="",d.channelId=void 0,d.taskStatus=void 0,E()},K=e=>{Object.assign(b,e),u()},t=()=>{const e=p.value.map(i=>i.id);C("confirm",{taskIds:e,taskItems:p.value}),l()},l=()=>{C("update:visible",!1),C("cancel")},u=async()=>{$.value=!0;try{const e=await X("task.list",{page:b.current,pageSize:b.pageSize,...d});if(e.code===0){D.value=e.data.list,b.total=e.data.total;const i=D.value.filter(y=>p.value.some(n=>n.id===y.id)).map(y=>y.id);a.value=[...new Set([...a.value,...i])]}else T.error(e.message)}finally{$.value=!1}},v=async()=>{const e=await X("channel.list");e.code===0&&(M.value=e.data.list)},G=()=>{m.selectedId&&m.selectedId.length>0&&(a.value=[...m.selectedId],H())},H=async()=>{if(m.selectedId&&m.selectedId.length>0)try{p.value=[]}catch(e){console.error("Failed to load selected tasks info:",e)}};return ae(()=>m.visible,e=>{e?(u(),M.value.length||v(),G()):(p.value=[],a.value=[],b.current=1)}),ae(()=>m.selectedId,()=>{m.visible&&G()},{deep:!0}),le(()=>{m.visible&&(u(),v(),G())}),(e,i)=>{const y=c("a-input"),n=c("a-form-item"),J=c("a-select-option"),Z=c("a-select"),x=c("a-button"),ee=c("a-space"),oe=c("a-form"),ne=c("a-alert"),ce=c("a-avatar"),re=c("a-table"),ie=c("a-modal");return f(),B(ie,{open:q.visible,title:e.$t("task.selectTask.title"),width:900,"confirm-loading":g.value,onOk:t,onCancel:l},{default:o(()=>[N("div",_e,[N("div",he,[s(oe,{layout:"inline",model:d},{default:o(()=>[s(n,{label:e.$t("task.search.taskName")},{default:o(()=>[s(y,{value:d.taskName,"onUpdate:value":i[0]||(i[0]=r=>d.taskName=r),placeholder:e.$t("common.inputPlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("task.search.channelId")},{default:o(()=>[s(Z,{value:d.channelId,"onUpdate:value":i[1]||(i[1]=r=>d.channelId=r),placeholder:e.$t("task.search.channelPlaceholder"),style:{width:"120px"},"allow-clear":""},{default:o(()=>[(f(!0),Y(F,null,W(M.value,r=>(f(),B(J,{key:r.id,value:r.id},{default:o(()=>[w(k(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("task.search.taskStatus")},{default:o(()=>[s(Z,{value:d.taskStatus,"onUpdate:value":i[2]||(i[2]=r=>d.taskStatus=r),placeholder:e.$t("task.search.statusPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:o(()=>[(f(!0),Y(F,null,W(V.value,r=>(f(),B(J,{key:r.value,value:r.value},{default:o(()=>[w(k(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),s(n,null,{default:o(()=>[s(ee,null,{default:o(()=>[s(x,{type:"primary",onClick:E},{default:o(()=>[w(k(e.$t("common.search")),1)]),_:1}),s(x,{onClick:A},{default:o(()=>[w(k(e.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),N("div",ge,[s(ne,{message:e.$t("task.selectTask.selectedCount",{count:p.value.length}),type:"info","show-icon":""},null,8,["message"])]),s(re,{columns:j.value,"data-source":D.value,loading:$.value,pagination:b,"row-selection":L.value,rowKey:"id",onChange:K,size:"middle"},{bodyCell:o(({column:r,record:z})=>[r.key==="taskName"?(f(),B(ee,{key:0},{default:o(()=>[s(ce,{src:z.channelIcon,size:"small"},null,8,["src"]),N("span",null,k(z.taskName),1)]),_:2},1024)):U("",!0),r.key==="taskTime"?(f(),Y("div",be,k(z.startTime)+" - "+k(z.endTime),1)):U("",!0),r.key==="taskStatus"?(f(),Y(F,{key:2},[w(k(de(S).getEnumText("TaskStatus",z.taskStatus)),1)],64)):U("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},Te=te(ye,[["__scopeId","data-v-5e371c95"]]),we={class:"task-form content-container"},Se={class:"form-container"},Ie={key:0,class:"selected-tasks-info"},Ce={class:"selected-tasks-list"},$e={__name:"detail",setup(q){const{t:h}=se(),S=me(),I=pe(),m=_(),C=O(()=>S.name==="TaskEdit"),$=_(!1),g=_([]),p=O(()=>g.value.map(t=>t.id)),a=Q({taskGroupName:"",taskGroupReward:0}),d={taskGroupName:[{required:!0,message:h("task.group.validation.taskGroupNameRequired")}],taskGroupReward:[{required:!0,message:h("task.group.validation.taskGroupRewardRequired")}]},M=()=>{$.value=!0},V=({taskIds:t,taskItems:l})=>{g.value=l},j=()=>{},D=t=>{g.value=g.value.filter(l=>l.id!==t),T.success(h("task.group.taskRemovedSuccess"))},b=async()=>{try{R.value=!0;const t={...a,groupIds:a.groupMode===0?[]:a.groupIds,startTime:a.startTime?P(a.startTime).format("YYYY-MM-DD HH:mm:ss"):null,endTime:a.endTime?P(a.endTime).format("YYYY-MM-DD HH:mm:ss"):null},l=await ke("task.add",t);l.code===0?(T.success(h("common.submitSuccess")),I.back()):T.error(l.message)}catch(t){console.log(t),T.error(h("common.submitFailed"))}finally{R.value=!1}},L=async()=>{try{R.value=!0;const t={...a,groupIds:a.groupMode===0?[]:a.groupIds,startTime:a.startTime?P(a.startTime).format("YYYY-MM-DD HH:mm:ss"):null,endTime:a.endTime?P(a.endTime).format("YYYY-MM-DD HH:mm:ss"):null},l=await fe("task.edit",{...t},{urlParams:{id:S.params.id}});l.code===0?(T.success(h("common.submitSuccess")),I.back()):T.error(l.message)}catch(t){console.log(t),T.error(h("common.submitFailed"))}finally{R.value=!1}},R=_(!1),E=()=>{m.value.validate().then(async()=>{C.value?await L():await b()})},A=()=>{I.back()},K=async t=>{try{const l=await X("task.detail",{},{urlParams:{id:t}});if(l.code===0){let u={};for(let v in l.data)v!=="groups"&&(u[v]=l.data[v]);u.startTime&&(u.startTime=P(u.startTime)),u.endTime&&(u.endTime=P(u.endTime)),Object.assign(a,u)}}catch(l){console.log(l),T.error(l)}};return le(()=>{C.value&&K(S.params.id)}),(t,l)=>{const u=c("a-input"),v=c("a-form-item"),G=c("a-input-number"),H=c("a-button"),e=c("a-tag"),i=c("a-space"),y=c("a-form");return f(),Y("div",we,[s(ve,{title:C.value?t.$t("task.group.editTitle"):t.$t("task.group.createTitle"),back:!0,class:"page-header"},null,8,["title"]),N("div",Se,[s(y,{ref_key:"formRef",ref:m,model:a,rules:d,"label-col":{span:5},"wrapper-col":{span:18},layout:"horizontal"},{default:o(()=>[s(v,{label:t.$t("task.group.name")},{default:o(()=>[s(u,{value:a.taskGroupName,"onUpdate:value":l[0]||(l[0]=n=>a.taskGroupName=n),placeholder:t.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),s(v,{label:t.$t("task.group.reward")},{default:o(()=>[s(G,{value:a.taskGroupReward,"onUpdate:value":l[1]||(l[1]=n=>a.taskGroupReward=n),min:0,precision:2,step:.1,placeholder:t.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),s(v,{label:t.$t("task.group.relatedTask")},{default:o(()=>[N("div",null,[s(H,{type:"primary",onClick:M},{default:o(()=>[w(k(t.$t("task.group.selectTaskBtnText",{count:g.value.length})),1)]),_:1}),g.value.length>0?(f(),Y("div",Ie,[N("div",Ce,[(f(!0),Y(F,null,W(g.value,n=>(f(),B(e,{key:n.id,closable:"",onClose:J=>D(n.id),style:{"margin-top":"8px"}},{default:o(()=>[w(k(n.taskName),1)]),_:2},1032,["onClose"]))),128))])])):U("",!0)])]),_:1},8,["label"]),s(v,{"wrapper-col":{span:16,offset:4}},{default:o(()=>[s(i,null,{default:o(()=>[s(H,{type:"primary",onClick:E},{default:o(()=>[w(k(t.$t("common.submit")),1)]),_:1}),s(H,{onClick:A},{default:o(()=>[w(k(t.$t("common.cancel")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),s(Te,{visible:$.value,"onUpdate:visible":l[2]||(l[2]=n=>$.value=n),selectedId:p.value,onConfirm:V,onCancel:j},null,8,["visible","selectedId"])])}}},De=te($e,[["__scopeId","data-v-f832b236"]]);export{De as default};
