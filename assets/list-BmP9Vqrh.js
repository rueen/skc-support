import{i as $,j as m,k as Y,_ as Z,r as D,l as ee,a as A,m as te,n as ae,b as y,d as b,c as r,w as a,e as _,p as B,f as ne,o as p,F as C,q as F,s as O,h,t as v,g as E,D as se,P as oe,v as I,M as le,x as re}from"./index-BnRn-NfI.js";const ce=(g,S={},x="",f={})=>{const n=Y.create({baseURL:$.baseUrl,timeout:6e4,responseType:"blob"});return n.interceptors.request.use(o=>{const e=localStorage.getItem("token");return e&&(o.headers.Authorization=`Bearer ${e}`),o},o=>(console.error("下载请求错误:",o),Promise.reject(o))),n({url:g,method:"get",params:S,...f}).then(o=>{let e=x;if(!e){const d=o.headers["content-disposition"];if(d){const w=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(d);if(w&&w[1]){e=w[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(U){console.error("文件名解码失败:",U)}}}if(!e){const u=o.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const i=new Blob([o.data]),c=document.createElement("a");return c.href=URL.createObjectURL(i),c.download=e,document.body.appendChild(c),c.click(),URL.revokeObjectURL(c.href),document.body.removeChild(c),{success:!0,filename:e}}).catch(o=>{let e="下载失败";if(o.response)if(o.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const i=new FileReader;i.onload=()=>{try{e=JSON.parse(i.result).message||"下载失败",m.error(e)}catch{m.error("下载失败")}},i.readAsText(o.response.data)}catch{m.error("下载失败")}else m.error(e);return Promise.reject(o)})},ie=(g,S={},x="",f={})=>{const[n,o]=g.split("."),e=$.api[n]&&$.api[n][o];if(!e)return console.error(`API ${g} 不存在`),m.error(`API ${g} 不存在`),Promise.reject(new Error(`API ${g} 不存在`));let i=e;return f.urlParams&&(i=i.replace(/:([^/]+)/g,(c,d)=>{const u=f.urlParams[d];return u===void 0?(console.warn(`URL 参数 ${d} 未提供`),c):u})),ce(i,S,x,f)},de={class:"task content-container"},ue={class:"table-container"},pe={class:"table-header"},me={class:"left"},fe={class:"right"},ke={key:0},_e={key:1},he=["onClick"],ye={__name:"list",setup(g){const S=ne(),x=D(!1),f=ee(),n=A({taskName:"",channelId:void 0,taskStatus:void 0}),o=D([]),e=te(()=>f.loaded?f.getEnumOptions("TaskStatus"):[]),i=[{title:"任务名称",key:"taskName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus",customRender:({text:s})=>f.getEnumText("TaskStatus",s)},{title:"任务名额 / 已提交",key:"taskQuota"},{title:"任务时间",key:"taskTime"},{title:"操作",key:"action",fixed:"right",width:180}],c=D([]),d=A({current:1,pageSize:10,total:0}),u=()=>{d.current=1,T()},w=()=>{n.taskName="",n.channelId=void 0,n.taskStatus=void 0,u()},U=s=>{Object.assign(d,s),T()},M=()=>{S.push("/task/create")},z=s=>{S.push(`/task/edit/${s.id}`)},V=async s=>{try{const t=await re("task.delete",{},{urlParams:{id:s.id}});t.code===0?(m.success("删除成功"),T()):m.error(t.message)}catch{m.error("删除失败")}},q=()=>{le.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const s=m.loading("正在导出数据，请稍候...",0),t={taskName:n.taskName,channelId:n.channelId,taskStatus:n.taskStatus};await ie("task.export",t,`任务列表_${new Date().toLocaleDateString()}.xlsx`),s(),m.success("导出成功")}catch(s){console.error("导出失败:",s),m.error("导出失败，请稍后重试")}}})},T=async()=>{x.value=!0;try{const s=await B("task.list",{page:d.current,pageSize:d.pageSize,...n});s.code===0?(c.value=s.data.list,d.total=s.data.total):m.error(s.message)}finally{x.value=!1}},Q=async()=>{const s=await B("channel.list");s.code===0&&(o.value=s.data.list)};return ae(async()=>{T(),Q()}),(s,t)=>{const J=_("a-input"),R=_("a-form-item"),L=_("a-select-option"),j=_("a-select"),P=_("a-button"),N=_("a-space"),G=_("a-form"),H=_("a-avatar"),K=_("a-popconfirm"),W=_("a-table");return p(),y("div",de,[b("div",ue,[b("div",pe,[b("div",me,[r(G,{layout:"inline",model:n},{default:a(()=>[r(R,{label:"任务名称"},{default:a(()=>[r(J,{value:n.taskName,"onUpdate:value":t[0]||(t[0]=l=>n.taskName=l),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),r(R,{label:"平台渠道"},{default:a(()=>[r(j,{value:n.channelId,"onUpdate:value":t[1]||(t[1]=l=>n.channelId=l),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:a(()=>[(p(!0),y(C,null,F(o.value,l=>(p(),O(L,{key:l.id,value:l.id},{default:a(()=>[h(v(l.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(R,{label:"任务状态"},{default:a(()=>[r(j,{value:n.taskStatus,"onUpdate:value":t[2]||(t[2]=l=>n.taskStatus=l),placeholder:"请选择任务状态",allowClear:""},{default:a(()=>[(p(!0),y(C,null,F(e.value,l=>(p(),O(L,{key:l.value,value:l.value},{default:a(()=>[h(v(l.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(R,null,{default:a(()=>[r(N,null,{default:a(()=>[r(P,{type:"primary",onClick:u},{default:a(()=>t[3]||(t[3]=[h("查询")])),_:1}),r(P,{onClick:w},{default:a(()=>t[4]||(t[4]=[h("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),b("div",fe,[r(N,null,{default:a(()=>[r(P,{onClick:q},{icon:a(()=>[r(E(se))]),default:a(()=>[t[5]||(t[5]=h(" 导出 "))]),_:1}),r(P,{type:"primary",onClick:M},{icon:a(()=>[r(E(oe))]),default:a(()=>[t[6]||(t[6]=h(" 新建任务 "))]),_:1})]),_:1})])]),r(W,{columns:i,"data-source":c.value,loading:x.value,pagination:d,onChange:U},{bodyCell:a(({column:l,record:k})=>[l.key==="taskName"?(p(),O(N,{key:0},{default:a(()=>[r(H,{src:k.channelIcon},null,8,["src"]),h(" "+v(k.taskName),1)]),_:2},1024)):I("",!0),l.key==="taskTime"?(p(),y(C,{key:1},[h(v(k.startTime)+" - "+v(k.endTime),1)],64)):I("",!0),l.key==="taskQuota"?(p(),y(C,{key:2},[k.unlimitedQuota?(p(),y("span",ke,"不限制")):(p(),y("span",_e,v(k.quota),1)),b("span",null," / "+v(k.submittedCount),1)],64)):I("",!0),l.key==="taskStatus"?(p(),y(C,{key:3},[h(v(E(f).getEnumText("TaskStatus",k.taskStatus)),1)],64)):I("",!0),l.key==="action"?(p(),O(N,{key:4},{default:a(()=>[b("a",{onClick:X=>z(k)},"编辑",8,he),r(K,{title:"确定要删除该任务吗？",onConfirm:X=>V(k)},{default:a(()=>t[7]||(t[7]=[b("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])]),_:2},1024)):I("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},ge=Z(ye,[["__scopeId","data-v-b55a52db"]]);export{ge as default};
