import{_ as Ce,a as Pe,b as Re,j as ee,r as g,c as F,k as Ne,d as k,e as y,f as o,s as f,w as s,g as i,y as te,x as Oe,h as je,l as O,m as h,o as n,F as w,n as $,p as v,i as c,t as r,q as Ge,M as De,A as ae}from"./index-Zoa6Hfy2.js";import{d as Me}from"./download-C6ZCsbTH.js";import{d as Ye,e as We}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Ee}from"./GroupOwner-B_fap3mE.js";const Fe={class:"task-audit content-container"},Ue={class:"table-container"},He={class:"table-header"},ze={class:"left"},Be={class:"right"},Le=["onClick"],qe={class:"danger"},Ve={key:0,class:"count-container"},Ke={__name:"pre-audit-list",setup(Je){const j=Pe(),{t:d}=Re(),se=ee(()=>j.loaded?j.getEnumOptions("TaskPreAuditStatus"):[]),G=Oe(),D=je(),M=g(!1),C=g(!1),Y=g(!1),S=g(""),b=g([]),U=()=>{const e=te().startOf("month").format("YYYY-MM-DD HH:mm:ss"),t=te().endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,t]},le=()=>{const e=G.query.filters;if(e){const t={},p=Ye(e);Object.keys(p).forEach(T=>{T==="current"?_.current=p[T]:t[T]=p[T]}),Object.assign(l,{taskPreAuditStatus:null},t);const u={...G.query};delete u.filters,D.replace({path:G.path,query:u})}},l=F({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:U(),completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),H=g([]),z=g([]),W=g([]),oe=ee(()=>[{title:d("submittedTasks.list.taskName"),key:"taskName"},{title:d("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:d("submittedTasks.list.memberInfo"),key:"member"},{title:d("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:d("submittedTasks.rejectTimes"),dataIndex:"rejectTimes",key:"rejectTimes"},{title:d("submittedTasks.preAuditor"),key:"preWaiterName"},{title:d("submittedTasks.preAuditTime"),dataIndex:"preAuditTime",key:"preAuditTime",sorter:!0},{title:d("submittedTasks.list.action"),key:"action"}]),P=g([]),B=g(0),_=F({current:1,pageSize:10,total:0}),L=F({sorterField:void 0,sorterOrder:void 0}),ne={selectedRowKeys:b,onChange:e=>{b.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},q=()=>{_.current=1,E()},re=()=>{Object.assign(l,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:U(),completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),q()},ue=(e,t,p)=>{Object.assign(_,e),Object.assign(L,{sorterField:p.field,sorterOrder:p.order}),E()},ie=e=>{D.push(`/member/view/${e.memberId}`)},de=e=>{const t=We({...l,current:_.current});D.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"pre",filters:t}})},ce=async e=>{b.value=[e.id],V()},V=async()=>{if(!b.value.length){h.warning(d("submittedTasks.list.selectTask"));return}const e=await ae("taskSubmitted.batchPreAuditApprove",{ids:b.value});e.code===0?(h.success(d("submittedTasks.resolveSuccess")),P.value.forEach(t=>{b.value.includes(t.id)&&(t.taskPreAuditStatus="approved")}),b.value=[]):h.error(e.message)},me=e=>{b.value=[e.id],S.value="",C.value=!0},pe=async()=>{if(!S.value){h.error(d("submittedTasks.rejectReasonRequired"));return}Y.value=!0;try{await ae("taskSubmitted.batchPreAuditReject",{ids:b.value,reason:S.value}),h.success(d("submittedTasks.rejectSuccess")),C.value=!1,P.value.forEach(e=>{b.value.includes(e.id)&&(e.taskPreAuditStatus="rejected")}),b.value=[]}catch(e){h.error(e.message)}finally{Y.value=!1}},ke=()=>{if(!b.value.length){h.warning(d("submittedTasks.list.selectTask"));return}S.value="",C.value=!0},fe=async()=>{const e=await O("channel.list");e.code===0&&(H.value=e.data.list)},ve=()=>{De.confirm({title:d("common.export"),content:d("common.confirmExportContent"),onOk:async()=>{var e,t;try{const p=h.loading(d("common.exporting"),0),u={taskName:l.taskName,channelId:l.channelId,taskPreAuditStatus:l.taskPreAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(e=l.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=l.submitTimeRange)==null?void 0:t[1],completedTaskCount:l.completedTaskCount,keyword:l.keyword,taskGroupId:l.taskGroupId};await Me("taskSubmitted.preAuditExport",u,`初审列表_${new Date().toLocaleDateString()}.xlsx`),p(),h.success(d("common.exportSuccess"))}catch(p){console.error("导出失败:",p),h.error(d("common.exportFailed"))}}})},K=async(e="")=>{try{const t=await O("group.list",{page:1,pageSize:50,keyword:e});t.code===0&&(z.value=t.data.list||[])}catch{h.error("获取群组列表失败")}},E=async()=>{var e,t;M.value=!0;try{const p={page:_.current,pageSize:_.pageSize,taskName:l.taskName,channelId:l.channelId,taskPreAuditStatus:l.taskPreAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(e=l.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=l.submitTimeRange)==null?void 0:t[1],completedTaskCount:l.completedTaskCount,keyword:l.keyword,taskGroupId:l.taskGroupId},u=await O("taskSubmitted.preAuditList",{...p,...L});u.code===0?(P.value=u.data.list,_.total=u.data.total,B.value=u.data.totalAmount):h.error(u.message)}finally{M.value=!1}},be=async()=>{if(W.value.length)return;const e=await O("waiter.list",{page:1,pageSize:100});if(e.code===0){const t={id:0,username:"无"};W.value=[t,...e.data.list]}},J=g([]),Q=async(e="")=>{const t=await O("taskGroup.list",{page:1,pageSize:50,taskGroupName:e});t.code===0&&(J.value=t.data.list||[])};return Ne(()=>{le(),E(),K(),fe(),be(),Q()}),(e,t)=>{const p=i("a-input"),u=i("a-form-item"),T=i("a-select-option"),R=i("a-select"),he=i("a-range-picker"),ge=i("a-input-number"),N=i("a-button"),I=i("a-space"),ye=i("a-form"),_e=i("DownloadOutlined"),Te=i("a-avatar"),X=i("a-tag"),we=i("a-typography-link"),Z=i("a-popconfirm"),Se=i("a-table"),x=i("a-descriptions-item"),Ie=i("a-descriptions"),Ae=i("a-textarea"),$e=i("a-modal");return n(),k("div",Fe,[y("div",Ue,[y("div",He,[y("div",ze,[o(ye,{layout:"inline",model:l},{default:s(()=>[o(u,{label:e.$t("submittedTasks.search.taskName")},{default:s(()=>[o(p,{value:l.taskName,"onUpdate:value":t[0]||(t[0]=a=>l.taskName=a),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.channel")},{default:s(()=>[o(R,{value:l.channelId,"onUpdate:value":t[1]||(t[1]=a=>l.channelId=a),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":""},{default:s(()=>[(n(!0),k(w,null,$(H.value,a=>(n(),v(T,{key:a.id,value:a.id},{default:s(()=>[c(r(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.submitTime")},{default:s(()=>[o(he,{value:l.submitTimeRange,"onUpdate:value":t[2]||(t[2]=a=>l.submitTimeRange=a),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["value"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:s(()=>[o(R,{value:l.taskPreAuditStatus,"onUpdate:value":t[3]||(t[3]=a=>l.taskPreAuditStatus=a),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":""},{default:s(()=>[(n(!0),k(w,null,$(se.value,a=>(n(),v(T,{key:a.value,value:a.value},{default:s(()=>[c(r(a.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.preAuditor")},{default:s(()=>[o(R,{value:l.preWaiterId,"onUpdate:value":t[4]||(t[4]=a=>l.preWaiterId=a),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":""},{default:s(()=>[(n(!0),k(w,null,$(W.value,a=>(n(),v(T,{key:a.id,value:a.id},{default:s(()=>[c(r(a.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.groupId")},{default:s(()=>[o(R,{value:l.groupId,"onUpdate:value":t[5]||(t[5]=a=>l.groupId=a),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":"","show-search":"","filter-option":!1,onSearch:K},{default:s(()=>[(n(!0),k(w,null,$(z.value,a=>(n(),v(T,{key:a.id,value:a.id},{default:s(()=>[c(r(a.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:s(()=>[o(ge,{value:l.completedTaskCount,"onUpdate:value":t[6]||(t[6]=a=>l.completedTaskCount=a),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times")},null,8,["value","addon-after"])]),_:1},8,["label"]),o(u,{label:e.$t("member.search.keyword")},{default:s(()=>[o(p,{value:l.keyword,"onUpdate:value":t[7]||(t[7]=a=>l.keyword=a),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),o(u,{label:e.$t("task.search.taskGroup")},{default:s(()=>[o(R,{value:l.taskGroupId,"onUpdate:value":t[8]||(t[8]=a=>l.taskGroupId=a),placeholder:e.$t("common.selectPlaceholder"),allowClear:"","show-search":"","filter-option":!1,onSearch:Q},{default:s(()=>[(n(!0),k(w,null,$(J.value,a=>(n(),v(T,{key:a.id,value:a.id},{default:s(()=>[c(r(a.taskGroupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),o(u,null,{default:s(()=>[o(I,null,{default:s(()=>[o(N,{type:"primary",onClick:q},{default:s(()=>[c(r(e.$t("common.search")),1)]),_:1}),o(N,{onClick:re},{default:s(()=>[c(r(e.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),y("div",Be,[o(I,null,{default:s(()=>[P.value.length?(n(),v(N,{key:0,onClick:ve},{icon:s(()=>[o(_e)]),default:s(()=>[c(" "+r(e.$t("common.export")),1)]),_:1})):f("",!0),o(N,{type:"primary",onClick:V},{default:s(()=>[c(r(e.$t("common.batchResolve")),1)]),_:1}),o(N,{danger:"",onClick:ke},{default:s(()=>[c(r(e.$t("common.batchReject")),1)]),_:1})]),_:1})])]),o(Se,{columns:oe.value,"data-source":P.value,loading:M.value,pagination:_,showSorterTooltip:!1,"row-selection":ne,rowKey:"id",onChange:ue},{bodyCell:s(({column:a,record:m})=>[a.key==="taskName"?(n(),v(I,{key:0},{default:s(()=>[o(Te,{src:m.channelIcon,size:"small"},null,8,["src"]),y("span",null,r(m.taskName),1),m.taskGroup?(n(),v(X,{key:0,color:"orange"},{default:s(()=>[c(r(m.taskGroup.taskGroupName),1)]),_:2},1024)):f("",!0)]),_:2},1024)):f("",!0),a.key==="taskPreAuditStatus"?(n(),k(w,{key:1},[c(r(Ge(j).getEnumText("TaskPreAuditStatus",m.taskPreAuditStatus)),1)],64)):f("",!0),a.key==="preWaiterName"?(n(),k(w,{key:2},[c(r(m.preWaiterName||"--"),1)],64)):f("",!0),a.key==="preAuditTime"?(n(),k(w,{key:3},[c(r(m.preAuditTime||"--"),1)],64)):f("",!0),a.key==="member"?(n(),k(w,{key:4},[y("div",null,[o(I,null,{default:s(()=>[o(we,{onClick:A=>ie(m)},{default:s(()=>[c(r(m.nickname),1)]),_:2},1032,["onClick"]),m.isNew?(n(),v(X,{key:0,color:"green"},{default:s(()=>t[11]||(t[11]=[c("new")])),_:1})):f("",!0)]),_:2},1024)]),y("div",null,r(m.account),1),(n(!0),k(w,null,$(m.groups,A=>(n(),k("div",null,[o(I,null,{default:s(()=>[y("span",null,r(A.groupName),1),A.isOwner?(n(),v(Ee,{key:0})):f("",!0)]),_:2},1024)]))),256))],64)):f("",!0),a.key==="action"?(n(),v(I,{key:5},{default:s(()=>[y("a",{onClick:A=>de(m)},r(e.$t("submittedTasks.list.view")),9,Le),m.taskPreAuditStatus==="pending"?(n(),v(Z,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:A=>ce(m)},{default:s(()=>[y("a",null,r(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):f("",!0),m.taskPreAuditStatus==="pending"?(n(),v(Z,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:A=>me(m)},{default:s(()=>[y("a",qe,r(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):f("",!0)]),_:2},1024)):f("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),_.total?(n(),k("div",Ve,[o(Ie,{column:2},{default:s(()=>[o(x,{label:e.$t("common.totalCount")},{default:s(()=>[c(r(_.total),1)]),_:1},8,["label"]),o(x,{label:e.$t("common.totalAmount")},{default:s(()=>[c(r(B.value),1)]),_:1},8,["label"])]),_:1})])):f("",!0)]),o($e,{open:C.value,"onUpdate:open":t[10]||(t[10]=a=>C.value=a),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:pe,confirmLoading:Y.value},{default:s(()=>[o(Ae,{value:S.value,"onUpdate:value":t[9]||(t[9]=a=>S.value=a),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},et=Ce(Ke,[["__scopeId","data-v-688c5531"]]);export{et as default};
