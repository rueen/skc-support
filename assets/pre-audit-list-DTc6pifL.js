import{_ as $e,a as Ce,b as Pe,j as X,r as g,c as Z,k as Re,d as p,e as h,f as n,s as k,w as l,g as i,y as ee,x as Ne,h as je,l as j,m as y,o,F as w,n as $,p as f,i as c,t as u,q as Oe,M as Ge,A as te}from"./index-C2N8CbWR.js";import{d as De}from"./download-BQnDe9A5.js";import{d as Me,e as Ye}from"./routeParamsEncryption-BKFTaOaF.js";import{G as We}from"./GroupOwner-DMeEMEmY.js";const Ee={class:"task-audit content-container"},Ue={class:"table-container"},He={class:"table-header"},Fe={style:{width:"100%",display:"flex","justify-content":"space-between"}},ze=["onClick"],Be={class:"danger"},Le={key:0,class:"count-container"},qe={__name:"pre-audit-list",setup(Ve){const O=Ce(),{t:d}=Pe(),ae=X(()=>O.loaded?O.getEnumOptions("TaskPreAuditStatus"):[]),G=Ne(),D=je(),M=g(!1),C=g(!1),Y=g(!1),S=g(""),v=g([]),U=()=>{const e=ee().startOf("month").format("YYYY-MM-DD HH:mm:ss"),t=ee().endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,t]},se=()=>{const e=G.query.filters;if(e){const t={},b=Me(e);Object.keys(b).forEach(T=>{T==="current"?_.current=b[T]:t[T]=b[T]}),Object.assign(s,{taskPreAuditStatus:null},t);const r={...G.query};delete r.filters,D.replace({path:G.path,query:r})}},s=Z({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:U(),completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),H=g([]),F=g([]),W=g([]),le=X(()=>[{title:d("submittedTasks.list.taskName"),key:"taskName"},{title:d("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:d("submittedTasks.list.memberInfo"),key:"member"},{title:d("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:d("submittedTasks.rejectTimes"),dataIndex:"rejectTimes",key:"rejectTimes"},{title:d("submittedTasks.preAuditor"),key:"preWaiterName"},{title:d("submittedTasks.preAuditTime"),key:"preAuditTime"},{title:d("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),P=g([]),z=g(0),_=Z({current:1,pageSize:10,total:0}),ne={selectedRowKeys:v,onChange:e=>{v.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},B=()=>{_.current=1,E()},oe=()=>{Object.assign(s,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:U(),completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),B()},ue=e=>{Object.assign(_,e),E()},re=e=>{D.push(`/member/view/${e.memberId}`)},ie=e=>{const t=Ye({...s,current:_.current});D.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"pre",filters:t}})},de=async e=>{v.value=[e.id],L()},L=async()=>{if(!v.value.length){y.warning(d("submittedTasks.list.selectTask"));return}const e=await te("taskSubmitted.batchPreAuditApprove",{ids:v.value});e.code===0?(y.success(d("submittedTasks.resolveSuccess")),P.value.forEach(t=>{v.value.includes(t.id)&&(t.taskPreAuditStatus="approved")}),v.value=[]):y.error(e.message)},ce=e=>{v.value=[e.id],S.value="",C.value=!0},me=async()=>{if(!S.value){y.error(d("submittedTasks.rejectReasonRequired"));return}Y.value=!0;try{await te("taskSubmitted.batchPreAuditReject",{ids:v.value,reason:S.value}),y.success(d("submittedTasks.rejectSuccess")),C.value=!1,P.value.forEach(e=>{v.value.includes(e.id)&&(e.taskPreAuditStatus="rejected")}),v.value=[]}catch(e){y.error(e.message)}finally{Y.value=!1}},pe=()=>{if(!v.value.length){y.warning(d("submittedTasks.list.selectTask"));return}S.value="",C.value=!0},ke=async()=>{const e=await j("channel.list");e.code===0&&(H.value=e.data.list)},fe=()=>{Ge.confirm({title:d("common.export"),content:d("common.confirmExportContent"),onOk:async()=>{var e,t;try{const b=y.loading(d("common.exporting"),0),r={taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword,taskGroupId:s.taskGroupId};await De("taskSubmitted.preAuditExport",r,`初审列表_${new Date().toLocaleDateString()}.xlsx`),b(),y.success(d("common.exportSuccess"))}catch(b){console.error("导出失败:",b),y.error(d("common.exportFailed"))}}})},q=async(e="")=>{try{const t=await j("group.list",{page:1,pageSize:50,keyword:e});t.code===0&&(F.value=t.data.list||[])}catch{y.error("获取群组列表失败")}},E=async()=>{var e,t;M.value=!0;try{const b={page:_.current,pageSize:_.pageSize,taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword,taskGroupId:s.taskGroupId},r=await j("taskSubmitted.preAuditList",{...b});r.code===0?(P.value=r.data.list,_.total=r.data.total,z.value=r.data.totalAmount):y.error(r.message)}finally{M.value=!1}},ve=async()=>{if(W.value.length)return;const e=await j("waiter.list",{page:1,pageSize:100});if(e.code===0){const t={id:0,username:"无"};W.value=[t,...e.data.list]}},V=g([]),x=async(e="")=>{const t=await j("taskGroup.list",{page:1,pageSize:50,taskGroupName:e});t.code===0&&(V.value=t.data.list||[])};return Re(()=>{se(),E(),q(),ke(),ve(),x()}),(e,t)=>{const b=i("a-input"),r=i("a-form-item"),T=i("a-select-option"),R=i("a-select"),be=i("a-range-picker"),he=i("a-input-number"),ye=i("a-form"),N=i("a-button"),I=i("a-space"),ge=i("DownloadOutlined"),_e=i("a-avatar"),K=i("a-tag"),Te=i("a-typography-link"),J=i("a-popconfirm"),we=i("a-table"),Q=i("a-descriptions-item"),Se=i("a-descriptions"),Ie=i("a-textarea"),Ae=i("a-modal");return o(),p("div",Ee,[h("div",Ue,[h("div",He,[n(ye,{layout:"inline",model:s},{default:l(()=>[n(r,{label:e.$t("submittedTasks.search.taskName")},{default:l(()=>[n(b,{value:s.taskName,"onUpdate:value":t[0]||(t[0]=a=>s.taskName=a),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.channel")},{default:l(()=>[n(R,{value:s.channelId,"onUpdate:value":t[1]||(t[1]=a=>s.channelId=a),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),p(w,null,$(H.value,a=>(o(),f(T,{key:a.id,value:a.id},{default:l(()=>[c(u(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.submitTime")},{default:l(()=>[n(be,{value:s.submitTimeRange,"onUpdate:value":t[2]||(t[2]=a=>s.submitTimeRange=a),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:l(()=>[n(R,{value:s.taskPreAuditStatus,"onUpdate:value":t[3]||(t[3]=a=>s.taskPreAuditStatus=a),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),p(w,null,$(ae.value,a=>(o(),f(T,{key:a.value,value:a.value},{default:l(()=>[c(u(a.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.preAuditor")},{default:l(()=>[n(R,{value:s.preWaiterId,"onUpdate:value":t[4]||(t[4]=a=>s.preWaiterId=a),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:l(()=>[(o(!0),p(w,null,$(W.value,a=>(o(),f(T,{key:a.id,value:a.id},{default:l(()=>[c(u(a.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.groupId")},{default:l(()=>[n(R,{value:s.groupId,"onUpdate:value":t[5]||(t[5]=a=>s.groupId=a),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:q},{default:l(()=>[(o(!0),p(w,null,$(F.value,a=>(o(),f(T,{key:a.id,value:a.id},{default:l(()=>[c(u(a.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:l(()=>[n(he,{value:s.completedTaskCount,"onUpdate:value":t[6]||(t[6]=a=>s.completedTaskCount=a),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),n(r,{label:e.$t("member.search.keyword")},{default:l(()=>[n(b,{value:s.keyword,"onUpdate:value":t[7]||(t[7]=a=>s.keyword=a),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),n(r,{label:e.$t("task.search.taskGroup")},{default:l(()=>[n(R,{value:s.taskGroupId,"onUpdate:value":t[8]||(t[8]=a=>s.taskGroupId=a),placeholder:e.$t("common.selectPlaceholder"),allowClear:"",style:{width:"120px"},"show-search":"","filter-option":!1,onSearch:x},{default:l(()=>[(o(!0),p(w,null,$(V.value,a=>(o(),f(T,{key:a.id,value:a.id},{default:l(()=>[c(u(a.taskGroupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),h("div",Fe,[h("div",null,[n(I,null,{default:l(()=>[n(N,{type:"primary",onClick:B},{default:l(()=>[c(u(e.$t("common.search")),1)]),_:1}),n(N,{onClick:oe},{default:l(()=>[c(u(e.$t("common.reset")),1)]),_:1})]),_:1})]),h("div",null,[n(I,null,{default:l(()=>[P.value.length?(o(),f(N,{key:0,onClick:fe},{icon:l(()=>[n(ge)]),default:l(()=>[c(" "+u(e.$t("common.export")),1)]),_:1})):k("",!0),n(N,{type:"primary",onClick:L},{default:l(()=>[c(u(e.$t("common.batchResolve")),1)]),_:1}),n(N,{danger:"",onClick:pe},{default:l(()=>[c(u(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(we,{columns:le.value,"data-source":P.value,loading:M.value,pagination:_,"row-selection":ne,rowKey:"id",onChange:ue},{bodyCell:l(({column:a,record:m})=>[a.key==="taskName"?(o(),f(I,{key:0},{default:l(()=>[n(_e,{src:m.channelIcon,size:"small"},null,8,["src"]),h("span",null,u(m.taskName),1),m.taskGroup?(o(),f(K,{key:0,color:"orange"},{default:l(()=>[c(u(m.taskGroup.taskGroupName),1)]),_:2},1024)):k("",!0)]),_:2},1024)):k("",!0),a.key==="taskPreAuditStatus"?(o(),p(w,{key:1},[c(u(Oe(O).getEnumText("TaskPreAuditStatus",m.taskPreAuditStatus)),1)],64)):k("",!0),a.key==="preWaiterName"?(o(),p(w,{key:2},[c(u(m.preWaiterName||"--"),1)],64)):k("",!0),a.key==="preAuditTime"?(o(),p(w,{key:3},[c(u(m.preAuditTime||"--"),1)],64)):k("",!0),a.key==="member"?(o(),p(w,{key:4},[h("div",null,[n(I,null,{default:l(()=>[n(Te,{onClick:A=>re(m)},{default:l(()=>[c(u(m.nickname),1)]),_:2},1032,["onClick"]),m.isNew?(o(),f(K,{key:0,color:"green"},{default:l(()=>t[11]||(t[11]=[c("new")])),_:1})):k("",!0)]),_:2},1024)]),h("div",null,u(m.account),1),(o(!0),p(w,null,$(m.groups,A=>(o(),p("div",null,[n(I,null,{default:l(()=>[h("span",null,u(A.groupName),1),A.isOwner?(o(),f(We,{key:0})):k("",!0)]),_:2},1024)]))),256))],64)):k("",!0),a.key==="action"?(o(),f(I,{key:5},{default:l(()=>[h("a",{onClick:A=>ie(m)},u(e.$t("submittedTasks.list.view")),9,ze),m.taskPreAuditStatus==="pending"?(o(),f(J,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:A=>de(m)},{default:l(()=>[h("a",null,u(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):k("",!0),m.taskPreAuditStatus==="pending"?(o(),f(J,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:A=>ce(m)},{default:l(()=>[h("a",Be,u(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):k("",!0)]),_:2},1024)):k("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),_.total?(o(),p("div",Le,[n(Se,{column:2},{default:l(()=>[n(Q,{label:e.$t("common.totalCount")},{default:l(()=>[c(u(_.total),1)]),_:1},8,["label"]),n(Q,{label:e.$t("common.totalAmount")},{default:l(()=>[c(u(z.value),1)]),_:1},8,["label"])]),_:1})])):k("",!0)]),n(Ae,{open:C.value,"onUpdate:open":t[10]||(t[10]=a=>C.value=a),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:me,confirmLoading:Y.value},{default:l(()=>[n(Ie,{value:S.value,"onUpdate:value":t[9]||(t[9]=a=>S.value=a),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},Xe=$e(qe,[["__scopeId","data-v-7b91848e"]]);export{Xe as default};
