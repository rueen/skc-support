import{_ as Se,a as Ae,b as $e,j as K,r as b,c as J,k as Ce,d as g,e as p,f as n,w as l,g as r,x as Pe,h as Ie,l as j,m as v,o,F as _,n as I,p as h,i as c,t as u,s as y,q as Re,M as Ne,A as Q}from"./index-DsMvC6-J.js";import{d as je}from"./download-DFtRogYz.js";import{d as Oe,e as We}from"./routeParamsEncryption-BKFTaOaF.js";import{G as De}from"./GroupOwner-xwK52J2t.js";const Ee={class:"task-audit content-container"},Ue={class:"table-container"},Fe={class:"table-header"},Me={style:{width:"100%",display:"flex","justify-content":"space-between"}},Ye=["onClick"],Be={class:"danger"},Le={class:"count-container"},qe={__name:"pre-audit-list",setup(ze){const O=Ae(),{t:d}=$e(),X=K(()=>O.loaded?O.getEnumOptions("TaskPreAuditStatus"):[]),W=Pe(),D=Ie(),E=b(!1),$=b(!1),U=b(!1),w=b(""),k=b([]),Y=b(null),Z=()=>{const e=W.query.filters;if(e){Y.value=Oe(e),Object.assign(s,{taskPreAuditStatus:null},Y.value);const t={...W.query};delete t.filters,D.replace({path:W.path,query:t})}},s=J({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),B=b([]),L=b([]),F=b([]),ee=K(()=>[{title:d("submittedTasks.list.taskName"),key:"taskName"},{title:d("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:d("submittedTasks.list.memberInfo"),key:"member"},{title:d("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:d("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:d("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),C=b([]),q=b(0),T=J({current:1,pageSize:10,total:0}),te={selectedRowKeys:k,onChange:e=>{k.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},z=()=>{T.current=1,M()},ae=()=>{Object.assign(s,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),z()},se=e=>{Object.assign(T,e),M()},le=e=>{D.push(`/member/view/${e.memberId}`)},ne=e=>{var f,i;const t=We({...s,submitStartTime:(f=s.submitTimeRange)==null?void 0:f[0],submitEndTime:(i=s.submitTimeRange)==null?void 0:i[1],submitTimeRange:void 0});D.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"pre",filters:t}})},oe=async e=>{k.value=[e.id],H()},H=async()=>{if(!k.value.length){v.warning(d("submittedTasks.list.selectTask"));return}const e=await Q("taskSubmitted.batchPreAuditApprove",{ids:k.value});e.code===0?(v.success(d("submittedTasks.resolveSuccess")),C.value.forEach(t=>{k.value.includes(t.id)&&(t.taskPreAuditStatus="approved")}),k.value=[]):v.error(e.message)},ue=e=>{k.value=[e.id],w.value="",$.value=!0},ie=async()=>{if(!w.value){v.error(d("submittedTasks.rejectReasonRequired"));return}U.value=!0;try{await Q("taskSubmitted.batchPreAuditReject",{ids:k.value,reason:w.value}),v.success(d("submittedTasks.rejectSuccess")),$.value=!1,C.value.forEach(e=>{k.value.includes(e.id)&&(e.taskPreAuditStatus="rejected")}),k.value=[]}catch(e){v.error(e.message)}finally{U.value=!1}},re=()=>{if(!k.value.length){v.warning(d("submittedTasks.list.selectTask"));return}w.value="",$.value=!0},de=async()=>{const e=await j("channel.list");e.code===0&&(B.value=e.data.list)},ce=()=>{Ne.confirm({title:d("common.export"),content:d("common.confirmExportContent"),onOk:async()=>{var e,t;try{const f=v.loading(d("common.exporting"),0),i={taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword};await je("taskSubmitted.preAuditExport",i,`初审列表_${new Date().toLocaleDateString()}.xlsx`),f(),v.success(d("common.exportSuccess"))}catch(f){console.error("导出失败:",f),v.error(d("common.exportFailed"))}}})},V=async(e="")=>{try{const t=await j("group.list",{page:1,pageSize:50,keyword:e});t.code===0&&(L.value=t.data.list||[])}catch{v.error("获取群组列表失败")}},M=async()=>{var e,t;E.value=!0;try{const f={page:T.current,pageSize:T.pageSize,taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword},i=await j("taskSubmitted.preAuditList",{...f});i.code===0?(C.value=i.data.list,T.total=i.data.total,q.value=i.data.totalAmount):v.error(i.message)}finally{E.value=!1}},me=async()=>{if(F.value.length)return;const e=await j("waiter.list",{page:1,pageSize:100});if(e.code===0){const t={id:0,username:"无"};F.value=[t,...e.data.list]}};return Ce(()=>{Z(),M(),V(),de(),me()}),(e,t)=>{const f=r("a-input"),i=r("a-form-item"),R=r("a-select-option"),N=r("a-select"),pe=r("a-range-picker"),ke=r("a-input-number"),ve=r("a-form"),P=r("a-button"),S=r("a-space"),fe=r("DownloadOutlined"),be=r("a-avatar"),he=r("a-typography-link"),ge=r("a-tag"),x=r("a-popconfirm"),ye=r("a-table"),G=r("a-descriptions-item"),_e=r("a-descriptions"),Te=r("a-textarea"),we=r("a-modal");return o(),g("div",Ee,[p("div",Ue,[p("div",Fe,[n(ve,{layout:"inline",model:s},{default:l(()=>[n(i,{label:e.$t("submittedTasks.search.taskName")},{default:l(()=>[n(f,{value:s.taskName,"onUpdate:value":t[0]||(t[0]=a=>s.taskName=a),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.channel")},{default:l(()=>[n(N,{value:s.channelId,"onUpdate:value":t[1]||(t[1]=a=>s.channelId=a),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),g(_,null,I(B.value,a=>(o(),h(R,{key:a.id,value:a.id},{default:l(()=>[c(u(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.submitTime")},{default:l(()=>[n(pe,{value:s.submitTimeRange,"onUpdate:value":t[2]||(t[2]=a=>s.submitTimeRange=a),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:l(()=>[n(N,{value:s.taskPreAuditStatus,"onUpdate:value":t[3]||(t[3]=a=>s.taskPreAuditStatus=a),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),g(_,null,I(X.value,a=>(o(),h(R,{key:a.value,value:a.value},{default:l(()=>[c(u(a.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.preAuditor")},{default:l(()=>[n(N,{value:s.preWaiterId,"onUpdate:value":t[4]||(t[4]=a=>s.preWaiterId=a),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:l(()=>[(o(!0),g(_,null,I(F.value,a=>(o(),h(R,{key:a.id,value:a.id},{default:l(()=>[c(u(a.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.groupId")},{default:l(()=>[n(N,{value:s.groupId,"onUpdate:value":t[5]||(t[5]=a=>s.groupId=a),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:V},{default:l(()=>[(o(!0),g(_,null,I(L.value,a=>(o(),h(R,{key:a.id,value:a.id},{default:l(()=>[c(u(a.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(i,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:l(()=>[n(ke,{value:s.completedTaskCount,"onUpdate:value":t[6]||(t[6]=a=>s.completedTaskCount=a),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),n(i,{label:e.$t("member.search.keyword")},{default:l(()=>[n(f,{value:s.keyword,"onUpdate:value":t[7]||(t[7]=a=>s.keyword=a),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),p("div",Me,[p("div",null,[n(S,null,{default:l(()=>[n(P,{type:"primary",onClick:z},{default:l(()=>[c(u(e.$t("common.search")),1)]),_:1}),n(P,{onClick:ae},{default:l(()=>[c(u(e.$t("common.reset")),1)]),_:1})]),_:1})]),p("div",null,[n(S,null,{default:l(()=>[C.value.length?(o(),h(P,{key:0,onClick:ce},{icon:l(()=>[n(fe)]),default:l(()=>[c(" "+u(e.$t("common.export")),1)]),_:1})):y("",!0),n(P,{type:"primary",onClick:H},{default:l(()=>[c(u(e.$t("common.batchResolve")),1)]),_:1}),n(P,{danger:"",onClick:re},{default:l(()=>[c(u(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(ye,{columns:ee.value,"data-source":C.value,loading:E.value,pagination:T,"row-selection":te,rowKey:"id",onChange:se},{bodyCell:l(({column:a,record:m})=>[a.key==="taskName"?(o(),h(S,{key:0},{default:l(()=>[n(be,{src:m.channelIcon,size:"small"},null,8,["src"]),p("span",null,u(m.taskName),1)]),_:2},1024)):y("",!0),a.key==="taskPreAuditStatus"?(o(),g(_,{key:1},[c(u(Re(O).getEnumText("TaskPreAuditStatus",m.taskPreAuditStatus)),1)],64)):y("",!0),a.key==="preWaiterName"?(o(),g(_,{key:2},[c(u(m.preWaiterName||"--"),1)],64)):y("",!0),a.key==="member"?(o(),g(_,{key:3},[p("div",null,[n(S,null,{default:l(()=>[n(he,{onClick:A=>le(m)},{default:l(()=>[c(u(m.nickname),1)]),_:2},1032,["onClick"]),m.isNew?(o(),h(ge,{key:0,color:"green"},{default:l(()=>t[10]||(t[10]=[c("new")])),_:1})):y("",!0)]),_:2},1024)]),p("div",null,u(m.account),1),(o(!0),g(_,null,I(m.groups,A=>(o(),g("div",null,[n(S,null,{default:l(()=>[p("span",null,u(A.groupName),1),A.isOwner?(o(),h(De,{key:0})):y("",!0)]),_:2},1024)]))),256))],64)):y("",!0),a.key==="action"?(o(),h(S,{key:4},{default:l(()=>[p("a",{onClick:A=>ne(m)},u(e.$t("submittedTasks.list.view")),9,Ye),m.taskPreAuditStatus==="pending"?(o(),h(x,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:A=>oe(m)},{default:l(()=>[p("a",null,u(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):y("",!0),m.taskPreAuditStatus==="pending"?(o(),h(x,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:A=>ue(m)},{default:l(()=>[p("a",Be,u(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):y("",!0)]),_:2},1024)):y("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),p("div",Le,[n(_e,{column:2},{default:l(()=>[n(G,{label:e.$t("submittedTasks.list.totalCount")},{default:l(()=>[c(u(T.total),1)]),_:1},8,["label"]),n(G,{label:e.$t("submittedTasks.list.totalAmount")},{default:l(()=>[c(u(q.value),1)]),_:1},8,["label"])]),_:1})])]),n(we,{open:$.value,"onUpdate:open":t[9]||(t[9]=a=>$.value=a),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:ie,confirmLoading:U.value},{default:l(()=>[n(Te,{value:w.value,"onUpdate:value":t[8]||(t[8]=a=>w.value=a),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},Ke=Se(qe,[["__scopeId","data-v-e9079287"]]);export{Ke as default};
