import{i as T,j as i,k as Y,_ as Z,r as U,l as ee,a as E,m as te,b as C,d as x,c as o,w as a,e as u,n as A,f as ae,o as h,F as D,p as B,q as L,h as v,t as O,g as I,D as ne,P as se,s as F,M as oe,v as le}from"./index-DWbj4jnr.js";const re=(f,g={},_="",m={})=>{const k=Y.create({baseURL:T.baseUrl,timeout:6e4,responseType:"blob"});return k.interceptors.request.use(n=>{const e=localStorage.getItem("token");return e&&(n.headers.Authorization=`Bearer ${e}`),n},n=>(console.error("下载请求错误:",n),Promise.reject(n))),k({url:f,method:"get",params:g,...m}).then(n=>{let e=_;if(!e){const p=n.headers["content-disposition"];if(p){const y=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(p);if(y&&y[1]){e=y[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(N){console.error("文件名解码失败:",N)}}}if(!e){const l=n.headers["content-type"];l?l.includes("excel")||l.includes("spreadsheetml")?e="export.xlsx":l.includes("csv")?e="export.csv":l.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const c=new Blob([n.data]),d=document.createElement("a");return d.href=URL.createObjectURL(c),d.download=e,document.body.appendChild(d),d.click(),URL.revokeObjectURL(d.href),document.body.removeChild(d),{success:!0,filename:e}}).catch(n=>{let e="下载失败";if(n.response)if(n.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const c=new FileReader;c.onload=()=>{try{e=JSON.parse(c.result).message||"下载失败",i.error(e)}catch{i.error("下载失败")}},c.readAsText(n.response.data)}catch{i.error("下载失败")}else i.error(e);return Promise.reject(n)})},ce=(f,g={},_="",m={})=>{const[k,n]=f.split("."),e=T.api[k]&&T.api[k][n];if(!e)return console.error(`API ${f} 不存在`),i.error(`API ${f} 不存在`),Promise.reject(new Error(`API ${f} 不存在`));let c=e;return m.urlParams&&(c=c.replace(/:([^/]+)/g,(d,p)=>{const l=m.urlParams[p];return l===void 0?(console.warn(`URL 参数 ${p} 未提供`),d):l})),re(c,g,_,m)},de={class:"task content-container"},ie={class:"table-container"},ue={class:"table-header"},me={class:"left"},pe={class:"right"},fe=["onClick"],_e={__name:"list",setup(f){const g=ae(),_=U(!1),m=ee(),k=m.arrEnum.TaskStatus,n=m.jsonEnum.TaskStatus,e=E({taskName:"",channelId:void 0,taskStatus:void 0}),c=U([]),d=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"action",fixed:"right",width:180}],p=U([]),l=E({current:1,pageSize:10,total:0}),y=()=>{l.current=1,b()},N=()=>{e.taskName="",e.channelId=void 0,e.taskStatus=void 0,y()},M=s=>{Object.assign(l,s),b()},z=()=>{g.push("/task/create")},V=s=>{g.push(`/task/edit/${s.id}`)},q=async s=>{try{const t=await le("task.delete",{},{urlParams:{id:s.id}});t.code===0?(i.success("删除成功"),b()):i.error(t.message)}catch{i.error("删除失败")}},J=()=>{oe.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const s=i.loading("正在导出数据，请稍候...",0),t={taskName:e.taskName,channelId:e.channelId,taskStatus:e.taskStatus};await ce("task.export",t,`任务列表_${new Date().toLocaleDateString()}.xlsx`),s(),i.success("导出成功")}catch(s){console.error("导出失败:",s),i.error("导出失败，请稍后重试")}}})},b=async()=>{_.value=!0;try{const s=await A("task.list",{page:l.current,pageSize:l.pageSize,...e});s.code===0?(p.value=s.data.list,l.total=s.data.total):i.error(s.message)}finally{_.value=!1}},G=async()=>{const s=await A("channel.list");s.code===0&&(c.value=s.data.list)};return te(async()=>{b(),G()}),(s,t)=>{const H=u("a-input"),S=u("a-form-item"),$=u("a-select-option"),j=u("a-select"),w=u("a-button"),P=u("a-space"),K=u("a-form"),Q=u("a-popconfirm"),W=u("a-table");return h(),C("div",de,[x("div",ie,[x("div",ue,[x("div",me,[o(K,{layout:"inline",model:e},{default:a(()=>[o(S,{label:"任务名称"},{default:a(()=>[o(H,{value:e.taskName,"onUpdate:value":t[0]||(t[0]=r=>e.taskName=r),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),o(S,{label:"平台渠道"},{default:a(()=>[o(j,{value:e.channelId,"onUpdate:value":t[1]||(t[1]=r=>e.channelId=r),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:a(()=>[(h(!0),C(D,null,B(c.value,r=>(h(),L($,{key:r.id,value:r.id},{default:a(()=>[v(O(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),o(S,{label:"任务状态"},{default:a(()=>[o(j,{value:e.taskStatus,"onUpdate:value":t[2]||(t[2]=r=>e.taskStatus=r),placeholder:"请选择状态",style:{width:"120px"},"allow-clear":""},{default:a(()=>[(h(!0),C(D,null,B(I(k),r=>(h(),L($,{key:r.value,value:r.value},{default:a(()=>[v(O(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),o(S,null,{default:a(()=>[o(P,null,{default:a(()=>[o(w,{type:"primary",onClick:y},{default:a(()=>t[3]||(t[3]=[v("查询")])),_:1}),o(w,{onClick:N},{default:a(()=>t[4]||(t[4]=[v("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),x("div",pe,[o(P,null,{default:a(()=>[o(w,{onClick:J},{icon:a(()=>[o(I(ne))]),default:a(()=>[t[5]||(t[5]=v(" 导出 "))]),_:1}),o(w,{type:"primary",onClick:z},{icon:a(()=>[o(I(se))]),default:a(()=>[t[6]||(t[6]=v(" 新建任务 "))]),_:1})]),_:1})])]),o(W,{columns:d,"data-source":p.value,loading:_.value,pagination:l,onChange:M},{bodyCell:a(({column:r,record:R})=>[r.key==="taskStatus"?(h(),C(D,{key:0},[v(O(I(n)[R.taskStatus]),1)],64)):F("",!0),r.key==="action"?(h(),L(P,{key:1},{default:a(()=>[x("a",{onClick:X=>V(R)},"编辑",8,fe),o(Q,{title:"确定要删除该任务吗？",onConfirm:X=>q(R)},{default:a(()=>t[7]||(t[7]=[x("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])]),_:2},1024)):F("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},he=Z(_e,[["__scopeId","data-v-bbd921a9"]]);export{he as default};
