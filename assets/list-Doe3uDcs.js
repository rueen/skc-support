import{i as $,j as m,k as X,_ as Y,r as O,l as Z,a as A,m as ee,n as te,b,d as y,c as l,w as s,e as f,p as B,f as ae,o as k,F as R,q as F,s as U,h as _,t as w,g as D,D as ne,P as se,v as E,M as oe,x as le}from"./index-DMD8F-5D.js";const re=(h,g={},v="",p={})=>{const a=X.create({baseURL:$.baseUrl,timeout:6e4,responseType:"blob"});return a.interceptors.request.use(o=>{const e=localStorage.getItem("token");return e&&(o.headers.Authorization=`Bearer ${e}`),o},o=>(console.error("下载请求错误:",o),Promise.reject(o))),a({url:h,method:"get",params:g,...p}).then(o=>{let e=v;if(!e){const d=o.headers["content-disposition"];if(d){const x=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(d);if(x&&x[1]){e=x[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(N){console.error("文件名解码失败:",N)}}}if(!e){const u=o.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const i=new Blob([o.data]),c=document.createElement("a");return c.href=URL.createObjectURL(i),c.download=e,document.body.appendChild(c),c.click(),URL.revokeObjectURL(c.href),document.body.removeChild(c),{success:!0,filename:e}}).catch(o=>{let e="下载失败";if(o.response)if(o.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const i=new FileReader;i.onload=()=>{try{e=JSON.parse(i.result).message||"下载失败",m.error(e)}catch{m.error("下载失败")}},i.readAsText(o.response.data)}catch{m.error("下载失败")}else m.error(e);return Promise.reject(o)})},ce=(h,g={},v="",p={})=>{const[a,o]=h.split("."),e=$.api[a]&&$.api[a][o];if(!e)return console.error(`API ${h} 不存在`),m.error(`API ${h} 不存在`),Promise.reject(new Error(`API ${h} 不存在`));let i=e;return p.urlParams&&(i=i.replace(/:([^/]+)/g,(c,d)=>{const u=p.urlParams[d];return u===void 0?(console.warn(`URL 参数 ${d} 未提供`),c):u})),re(i,g,v,p)},ie={class:"task content-container"},de={class:"table-container"},ue={class:"table-header"},me={class:"left"},pe={class:"right"},fe=["onClick"],ke={__name:"list",setup(h){const g=ae(),v=O(!1),p=Z(),a=A({taskName:"",channelId:void 0,taskStatus:void 0}),o=O([]),e=ee(()=>p.loaded?p.getEnumOptions("TaskStatus"):[]),i=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus",customRender:({text:n})=>p.getEnumText("TaskStatus",n)},{title:"任务时间",key:"taskTime"},{title:"操作",key:"action",fixed:"right",width:180}],c=O([]),d=A({current:1,pageSize:10,total:0}),u=()=>{d.current=1,C()},x=()=>{a.taskName="",a.channelId=void 0,a.taskStatus=void 0,u()},N=n=>{Object.assign(d,n),C()},M=()=>{g.push("/task/create")},z=n=>{g.push(`/task/edit/${n.id}`)},V=async n=>{try{const t=await le("task.delete",{},{urlParams:{id:n.id}});t.code===0?(m.success("删除成功"),C()):m.error(t.message)}catch{m.error("删除失败")}},q=()=>{oe.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const n=m.loading("正在导出数据，请稍候...",0),t={taskName:a.taskName,channelId:a.channelId,taskStatus:a.taskStatus};await ce("task.export",t,`任务列表_${new Date().toLocaleDateString()}.xlsx`),n(),m.success("导出成功")}catch(n){console.error("导出失败:",n),m.error("导出失败，请稍后重试")}}})},C=async()=>{v.value=!0;try{const n=await B("task.list",{page:d.current,pageSize:d.pageSize,...a});n.code===0?(c.value=n.data.list,d.total=n.data.total):m.error(n.message)}finally{v.value=!1}},J=async()=>{const n=await B("channel.list");n.code===0&&(o.value=n.data.list)};return te(async()=>{C(),J()}),(n,t)=>{const G=f("a-input"),I=f("a-form-item"),L=f("a-select-option"),j=f("a-select"),T=f("a-button"),P=f("a-space"),H=f("a-form"),K=f("a-popconfirm"),Q=f("a-table");return k(),b("div",ie,[y("div",de,[y("div",ue,[y("div",me,[l(H,{layout:"inline",model:a},{default:s(()=>[l(I,{label:"任务名称"},{default:s(()=>[l(G,{value:a.taskName,"onUpdate:value":t[0]||(t[0]=r=>a.taskName=r),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),l(I,{label:"平台渠道"},{default:s(()=>[l(j,{value:a.channelId,"onUpdate:value":t[1]||(t[1]=r=>a.channelId=r),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:s(()=>[(k(!0),b(R,null,F(o.value,r=>(k(),U(L,{key:r.id,value:r.id},{default:s(()=>[_(w(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(I,{label:"任务状态"},{default:s(()=>[l(j,{value:a.taskStatus,"onUpdate:value":t[2]||(t[2]=r=>a.taskStatus=r),placeholder:"请选择任务状态",allowClear:""},{default:s(()=>[(k(!0),b(R,null,F(e.value,r=>(k(),U(L,{key:r.value,value:r.value},{default:s(()=>[_(w(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(I,null,{default:s(()=>[l(P,null,{default:s(()=>[l(T,{type:"primary",onClick:u},{default:s(()=>t[3]||(t[3]=[_("查询")])),_:1}),l(T,{onClick:x},{default:s(()=>t[4]||(t[4]=[_("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),y("div",pe,[l(P,null,{default:s(()=>[l(T,{onClick:q},{icon:s(()=>[l(D(ne))]),default:s(()=>[t[5]||(t[5]=_(" 导出 "))]),_:1}),l(T,{type:"primary",onClick:M},{icon:s(()=>[l(D(se))]),default:s(()=>[t[6]||(t[6]=_(" 新建任务 "))]),_:1})]),_:1})])]),l(Q,{columns:i,"data-source":c.value,loading:v.value,pagination:d,onChange:N},{bodyCell:s(({column:r,record:S})=>[r.key==="taskTime"?(k(),b(R,{key:0},[_(w(S.startTime)+" - "+w(S.endTime),1)],64)):E("",!0),r.key==="taskStatus"?(k(),b(R,{key:1},[_(w(D(p).getEnumText("TaskStatus",S.taskStatus)),1)],64)):E("",!0),r.key==="action"?(k(),U(P,{key:2},{default:s(()=>[y("a",{onClick:W=>z(S)},"编辑",8,fe),l(K,{title:"确定要删除该任务吗？",onConfirm:W=>V(S)},{default:s(()=>t[7]||(t[7]=[y("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])]),_:2},1024)):E("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},he=Y(ke,[["__scopeId","data-v-de1a5152"]]);export{he as default};
