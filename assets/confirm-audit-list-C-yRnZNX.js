import{_ as Ce,a as Ae,b as Ie,j as J,r as k,c as Q,k as Ne,d as h,e as f,f as l,w as s,g as i,x as Re,h as $e,l as j,m as v,o,F as y,n as x,p as b,i as r,t as u,s as g,q as Oe,M as je,A as X}from"./index-DFAY5ft_.js";import{d as xe}from"./download-CPPJrjrx.js";import{d as De,e as Ee}from"./routeParamsEncryption-BKFTaOaF.js";import{G as We}from"./GroupOwner-CiW9sODe.js";const Ue={class:"task-audit content-container"},Fe={class:"table-container"},Me={class:"table-header"},Ye={style:{width:"100%",display:"flex","justify-content":"space-between"}},Be=["onClick"],Le={__name:"confirm-audit-list",setup(Pe){const D=Ae(),{t:m}=Ie(),Z=J(()=>D.loaded?D.getEnumOptions("TaskAuditStatus"):[]),E=$e(),W=Re(),U=k(!1),L=k(!1),C=k(!1),F=k(!1),T=k(""),A=k(null),p=k([]),M=k([]),n=Q({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),P=k([]),V=k([]),ee=J(()=>[{title:m("submittedTasks.list.taskName"),key:"taskName"},{title:m("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:m("submittedTasks.list.memberInfo"),key:"member"},{title:m("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:m("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:m("submittedTasks.list.confirmAuditor"),key:"waiterName"},{title:m("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),I=k([]),w=Q({current:1,pageSize:10,total:0}),te={selectedRowKeys:p,onChange:e=>{p.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},z=k(null),ae=()=>{const e=W.query.filters;if(e){z.value=De(e),Object.assign(n,z.value);const a={...W.query};delete a.filters,E.replace({path:W.path,query:a})}},H=()=>{w.current=1,Y()},se=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),H()},ne=e=>{Object.assign(w,e),Y()},le=e=>{E.push(`/member/view/${e.memberId}`)},oe=e=>{var _,d;const a=Ee({...n,submitStartTime:(_=n.submitTimeRange)==null?void 0:_[0],submitEndTime:(d=n.submitTimeRange)==null?void 0:d[1],submitTimeRange:void 0});E.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:a}})},ue=async e=>{p.value=[e.id],q()},q=async()=>{if(!p.value.length){v.warning(m("submittedTasks.list.selectTask"));return}const e=await X("taskSubmitted.batchConfirmAuditApprove",{ids:p.value});e.code===0?(v.success(m("submittedTasks.resolveSuccess")),I.value.forEach(a=>{p.value.includes(a.id)&&(a.taskAuditStatus="approved")}),p.value=[]):v.error(e.message)},ie=e=>{p.value=[e.id],T.value="",C.value=!0},re=async()=>{if(!T.value){v.error("请输入拒绝原因");return}F.value=!0;try{await X("taskSubmitted.batchConfirmAuditReject",{ids:p.value,reason:T.value}),v.success("审核拒绝成功"),C.value=!1,I.value.forEach(e=>{p.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),p.value=[]}catch(e){v.error(e.message)}finally{F.value=!1}},de=()=>{if(!p.value.length){v.warning("请选择要拒绝的任务");return}T.value="",C.value=!0},ce=async()=>{const e=await j("channel.list");e.code===0&&(P.value=e.data.list)},me=()=>{je.confirm({title:m("common.export"),content:m("common.confirmExportContent"),onOk:async()=>{var e,a;try{const _=v.loading(m("common.exporting"),0),d={taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=n.submitTimeRange)==null?void 0:a[1],completedTaskCount:n.completedTaskCount};await xe("taskSubmitted.confirmAuditExport",d,`复审列表_${new Date().toLocaleDateString()}.xlsx`),_(),v.success(m("common.exportSuccess"))}catch(_){console.error("导出失败:",_),v.error(m("common.exportFailed"))}}})},pe=async(e="")=>{try{const a=await j("group.list",{params:{page:1,pageSize:50,keyword:e}});a.code===0&&(V.value=a.data.list||[])}catch{v.error("获取群组列表失败")}},Y=async()=>{var e,a;U.value=!0;try{const _={page:w.current,pageSize:w.pageSize,taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=n.submitTimeRange)==null?void 0:a[1],completedTaskCount:n.completedTaskCount},d=await j("taskSubmitted.confirmAuditList",{..._});d.code===0?(I.value=d.data.list,w.total=d.data.total):v.error(d.message)}finally{U.value=!1}},ke=async()=>{if(M.value.length)return;const e=await j("waiter.list",{page:1,pageSize:100});e.code===0&&(M.value=e.data.list||[])};return Ne(()=>{ae(),Y(),pe(),ce(),ke()}),(e,a)=>{const _=i("a-input"),d=i("a-form-item"),$=i("a-select-option"),O=i("a-select"),fe=i("a-range-picker"),ve=i("a-input-number"),be=i("a-form"),N=i("a-button"),S=i("a-space"),ge=i("DownloadOutlined"),_e=i("a-avatar"),he=i("a-typography-link"),ye=i("a-tag"),G=i("a-popconfirm"),Te=i("a-table"),R=i("a-descriptions-item"),we=i("a-descriptions"),K=i("a-modal"),Se=i("a-textarea");return o(),h("div",Ue,[f("div",Fe,[f("div",Me,[l(be,{layout:"inline",model:n},{default:s(()=>[l(d,{label:e.$t("submittedTasks.search.taskName")},{default:s(()=>[l(_,{value:n.taskName,"onUpdate:value":a[0]||(a[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.channel")},{default:s(()=>[l(O,{value:n.channelId,"onUpdate:value":a[1]||(a[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(o(!0),h(y,null,x(P.value,t=>(o(),b($,{key:t.id,value:t.id},{default:s(()=>[r(u(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.submitTime")},{default:s(()=>[l(fe,{value:n.submitTimeRange,"onUpdate:value":a[2]||(a[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:s(()=>[l(O,{value:n.taskAuditStatus,"onUpdate:value":a[3]||(a[3]=t=>n.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(o(!0),h(y,null,x(Z.value,t=>(o(),b($,{key:t.value,value:t.value},{default:s(()=>[r(u(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.preAuditor")},{default:s(()=>[l(O,{value:n.preWaiterId,"onUpdate:value":a[4]||(a[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:s(()=>[(o(!0),h(y,null,x(M.value,t=>(o(),b($,{key:t.id,value:t.id},{default:s(()=>[r(u(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.groupId")},{default:s(()=>[l(O,{value:n.groupId,"onUpdate:value":a[5]||(a[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":""},{default:s(()=>[(o(!0),h(y,null,x(V.value,t=>(o(),b($,{key:t.id,value:t.id},{default:s(()=>[r(u(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:s(()=>[l(ve,{value:n.completedTaskCount,"onUpdate:value":a[6]||(a[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"])]),_:1},8,["model"]),f("div",Ye,[f("div",null,[l(S,null,{default:s(()=>[l(N,{type:"primary",onClick:H},{default:s(()=>[r(u(e.$t("common.search")),1)]),_:1}),l(N,{onClick:se},{default:s(()=>[r(u(e.$t("common.reset")),1)]),_:1})]),_:1})]),f("div",null,[l(S,null,{default:s(()=>[I.value.length?(o(),b(N,{key:0,onClick:me},{icon:s(()=>[l(ge)]),default:s(()=>[r(" "+u(e.$t("common.export")),1)]),_:1})):g("",!0),l(N,{type:"primary",onClick:q},{default:s(()=>[r(u(e.$t("common.batchResolve")),1)]),_:1}),l(N,{danger:"",onClick:de},{default:s(()=>[r(u(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(Te,{columns:ee.value,"data-source":I.value,loading:U.value,pagination:w,"row-selection":te,rowKey:"id",onChange:ne},{bodyCell:s(({column:t,record:c})=>[t.key==="taskName"?(o(),b(S,{key:0},{default:s(()=>[l(_e,{src:c.channelIcon,size:"small"},null,8,["src"]),f("span",null,u(c.taskName),1)]),_:2},1024)):g("",!0),t.key==="taskAuditStatus"?(o(),h(y,{key:1},[r(u(Oe(D).getEnumText("TaskAuditStatus",c.taskAuditStatus)),1)],64)):g("",!0),t.key==="preWaiterName"?(o(),h(y,{key:2},[r(u(c.preWaiterName||"--"),1)],64)):g("",!0),t.key==="waiterName"?(o(),h(y,{key:3},[r(u(c.waiterName||"--"),1)],64)):g("",!0),t.key==="member"?(o(),h(y,{key:4},[f("div",null,[l(S,null,{default:s(()=>[l(he,{onClick:B=>le(c)},{default:s(()=>[r(u(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(o(),b(ye,{key:0,color:"green"},{default:s(()=>a[10]||(a[10]=[r("new")])),_:1})):g("",!0)]),_:2},1024)]),f("div",null,[l(S,{class:"group-name"},{default:s(()=>[f("span",null,u(c.groupName),1),c.isOwner?(o(),b(We,{key:0})):g("",!0)]),_:2},1024)])],64)):g("",!0),t.key==="action"?(o(),b(S,{key:5},{default:s(()=>[f("a",{onClick:B=>oe(c)},"查看",8,Be),c.taskAuditStatus==="pending"?(o(),b(G,{key:0,title:"确定要通过该任务吗？",onConfirm:B=>ue(c)},{default:s(()=>a[11]||(a[11]=[f("a",null,"通过",-1)])),_:2},1032,["onConfirm"])):g("",!0),c.taskAuditStatus==="pending"?(o(),b(G,{key:1,title:"确定要拒绝该任务吗？",onConfirm:B=>ie(c)},{default:s(()=>a[12]||(a[12]=[f("a",{class:"danger"},"拒绝",-1)])),_:2},1032,["onConfirm"])):g("",!0)]),_:2},1024)):g("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),l(K,{open:L.value,"onUpdate:open":a[7]||(a[7]=t=>L.value=t),title:"任务详情",footer:null},{default:s(()=>[l(we,{column:1},{default:s(()=>[l(R,{label:"任务名称"},{default:s(()=>{var t;return[r(u((t=A.value)==null?void 0:t.taskName),1)]}),_:1}),l(R,{label:"任务类型"},{default:s(()=>{var t;return[r(u((t=A.value)==null?void 0:t.taskType),1)]}),_:1}),l(R,{label:"任务描述"},{default:s(()=>{var t;return[r(u((t=A.value)==null?void 0:t.description),1)]}),_:1}),l(R,{label:"任务奖励"},{default:s(()=>{var t;return[r(u((t=A.value)==null?void 0:t.reward),1)]}),_:1}),l(R,{label:"创建时间"},{default:s(()=>{var t;return[r(u((t=A.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(K,{open:C.value,"onUpdate:open":a[9]||(a[9]=t=>C.value=t),title:"拒绝原因",onOk:re,confirmLoading:F.value},{default:s(()=>[l(Se,{value:T.value,"onUpdate:value":a[8]||(a[8]=t=>T.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Ge=Ce(Le,[["__scopeId","data-v-fb78c2a1"]]);export{Ge as default};
