import{_ as Ce,a as $e,b as Ie,j as Z,r as f,c as ee,k as Ne,d as p,e as b,f as l,s as k,w as a,g as d,x as Re,h as Oe,l as E,m as y,o as u,F as g,n as O,p as _,i,t as o,q as je,M as De,A as te}from"./index-B7rucJEo.js";import{d as Ee}from"./download-Coj9eE8w.js";import{d as We,e as Ue}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Fe}from"./GroupOwner-RibmaOXc.js";const Me={class:"task-audit content-container"},Pe={class:"table-container"},Ye={class:"table-header"},Be={style:{width:"100%",display:"flex","justify-content":"space-between"}},Le=["onClick"],Ve={class:"danger"},xe={key:0,class:"count-container"},ze={__name:"confirm-audit-list",setup(He){const W=$e(),{t:c}=Ie(),ae=Z(()=>W.loaded?W.getEnumOptions("TaskAuditStatus"):[]),U=Oe(),F=Re(),M=f(!1),L=f(!1),$=f(!1),P=f(!1),A=f(""),I=f(null),v=f([]),Y=f([]),n=ee({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),V=f([]),x=f([]),se=Z(()=>[{title:c("submittedTasks.list.taskName"),key:"taskName"},{title:c("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:c("submittedTasks.list.memberInfo"),key:"member"},{title:c("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:c("submittedTasks.preAuditor"),key:"preWaiterName"},{title:c("submittedTasks.preAuditTime"),key:"preAuditTime"},{title:c("submittedTasks.confirmAuditor"),key:"waiterName"},{title:c("submittedTasks.confirmAuditTime"),key:"confirmAuditTime"},{title:c("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),N=f([]),z=f(0),T=ee({current:1,pageSize:10,total:0}),le={selectedRowKeys:v,onChange:e=>{v.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},H=f(null),ne=()=>{const e=F.query.filters;if(e){H.value=We(e),Object.assign(n,{taskAuditStatus:null},H.value);const s={...F.query};delete s.filters,U.replace({path:F.path,query:s})}},q=()=>{T.current=1,B()},oe=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),q()},ue=e=>{Object.assign(T,e),B()},ie=e=>{U.push(`/member/view/${e.memberId}`)},re=e=>{var h,r;const s=Ue({...n,submitStartTime:(h=n.submitTimeRange)==null?void 0:h[0],submitEndTime:(r=n.submitTimeRange)==null?void 0:r[1],submitTimeRange:void 0});U.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:s}})},de=async e=>{v.value=[e.id],G()},G=async()=>{if(!v.value.length){y.warning(c("submittedTasks.list.selectTask"));return}const e=await te("taskSubmitted.batchConfirmAuditApprove",{ids:v.value});e.code===0?(y.success(c("submittedTasks.resolveSuccess")),N.value.forEach(s=>{v.value.includes(s.id)&&(s.taskAuditStatus="approved")}),v.value=[]):y.error(e.message)},me=e=>{v.value=[e.id],A.value="",$.value=!0},ce=async()=>{if(!A.value){y.error("请输入拒绝原因");return}P.value=!0;try{await te("taskSubmitted.batchConfirmAuditReject",{ids:v.value,reason:A.value}),y.success("审核拒绝成功"),$.value=!1,N.value.forEach(e=>{v.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),v.value=[]}catch(e){y.error(e.message)}finally{P.value=!1}},pe=()=>{if(!v.value.length){y.warning("请选择要拒绝的任务");return}A.value="",$.value=!0},ke=async()=>{const e=await E("channel.list");e.code===0&&(V.value=e.data.list)},fe=()=>{De.confirm({title:c("common.export"),content:c("common.confirmExportContent"),onOk:async()=>{var e,s;try{const h=y.loading(c("common.exporting"),0),r={taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword};await Ee("taskSubmitted.confirmAuditExport",r,`复审列表_${new Date().toLocaleDateString()}.xlsx`),h(),y.success(c("common.exportSuccess"))}catch(h){console.error("导出失败:",h),y.error(c("common.exportFailed"))}}})},K=async(e="")=>{try{const s=await E("group.list",{page:1,pageSize:50,keyword:e});s.code===0&&(x.value=s.data.list||[])}catch{y.error("获取群组列表失败")}},B=async()=>{var e,s;M.value=!0;try{const h={page:T.current,pageSize:T.pageSize,taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword},r=await E("taskSubmitted.confirmAuditList",{...h});r.code===0?(N.value=r.data.list,T.total=r.data.total,z.value=r.data.totalAmount):y.error(r.message)}finally{M.value=!1}},ve=async()=>{if(Y.value.length)return;const e=await E("waiter.list",{page:1,pageSize:100});e.code===0&&(Y.value=e.data.list||[])};return Ne(()=>{ne(),B(),K(),ke(),ve()}),(e,s)=>{const h=d("a-input"),r=d("a-form-item"),j=d("a-select-option"),D=d("a-select"),be=d("a-range-picker"),ye=d("a-input-number"),he=d("a-form"),R=d("a-button"),S=d("a-space"),ge=d("DownloadOutlined"),_e=d("a-avatar"),Te=d("a-typography-link"),we=d("a-tag"),J=d("a-popconfirm"),Ae=d("a-table"),w=d("a-descriptions-item"),Q=d("a-descriptions"),X=d("a-modal"),Se=d("a-textarea");return u(),p("div",Me,[b("div",Pe,[b("div",Ye,[l(he,{layout:"inline",model:n},{default:a(()=>[l(r,{label:e.$t("submittedTasks.search.taskName")},{default:a(()=>[l(h,{value:n.taskName,"onUpdate:value":s[0]||(s[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.channel")},{default:a(()=>[l(D,{value:n.channelId,"onUpdate:value":s[1]||(s[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,O(V.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.submitTime")},{default:a(()=>[l(be,{value:n.submitTimeRange,"onUpdate:value":s[2]||(s[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[l(D,{value:n.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=t=>n.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,O(ae.value,t=>(u(),_(j,{key:t.value,value:t.value},{default:a(()=>[i(o(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.preAuditor")},{default:a(()=>[l(D,{value:n.preWaiterId,"onUpdate:value":s[4]||(s[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:a(()=>[(u(!0),p(g,null,O(Y.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.groupId")},{default:a(()=>[l(D,{value:n.groupId,"onUpdate:value":s[5]||(s[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:K},{default:a(()=>[(u(!0),p(g,null,O(x.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[l(ye,{value:n.completedTaskCount,"onUpdate:value":s[6]||(s[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),l(r,{label:e.$t("member.search.keyword")},{default:a(()=>[l(h,{value:n.keyword,"onUpdate:value":s[7]||(s[7]=t=>n.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),b("div",Be,[b("div",null,[l(S,null,{default:a(()=>[l(R,{type:"primary",onClick:q},{default:a(()=>[i(o(e.$t("common.search")),1)]),_:1}),l(R,{onClick:oe},{default:a(()=>[i(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),b("div",null,[l(S,null,{default:a(()=>[N.value.length?(u(),_(R,{key:0,onClick:fe},{icon:a(()=>[l(ge)]),default:a(()=>[i(" "+o(e.$t("common.export")),1)]),_:1})):k("",!0),l(R,{type:"primary",onClick:G},{default:a(()=>[i(o(e.$t("common.batchResolve")),1)]),_:1}),l(R,{danger:"",onClick:pe},{default:a(()=>[i(o(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(Ae,{columns:se.value,"data-source":N.value,loading:M.value,pagination:T,"row-selection":le,rowKey:"id",onChange:ue},{bodyCell:a(({column:t,record:m})=>[t.key==="taskName"?(u(),_(S,{key:0},{default:a(()=>[l(_e,{src:m.channelIcon,size:"small"},null,8,["src"]),b("span",null,o(m.taskName),1)]),_:2},1024)):k("",!0),t.key==="taskAuditStatus"?(u(),p(g,{key:1},[i(o(je(W).getEnumText("TaskAuditStatus",m.taskAuditStatus)),1)],64)):k("",!0),t.key==="preWaiterName"?(u(),p(g,{key:2},[i(o(m.preWaiterName||"--"),1)],64)):k("",!0),t.key==="preAuditTime"?(u(),p(g,{key:3},[i(o(m.preAuditTime||"--"),1)],64)):k("",!0),t.key==="waiterName"?(u(),p(g,{key:4},[i(o(m.waiterName||"--"),1)],64)):k("",!0),t.key==="confirmAuditTime"?(u(),p(g,{key:5},[i(o(m.auditTime||"--"),1)],64)):k("",!0),t.key==="member"?(u(),p(g,{key:6},[b("div",null,[l(S,null,{default:a(()=>[l(Te,{onClick:C=>ie(m)},{default:a(()=>[i(o(m.nickname),1)]),_:2},1032,["onClick"]),m.isNew?(u(),_(we,{key:0,color:"green"},{default:a(()=>s[11]||(s[11]=[i("new")])),_:1})):k("",!0)]),_:2},1024)]),b("div",null,o(m.account),1),(u(!0),p(g,null,O(m.groups,C=>(u(),p("div",null,[l(S,null,{default:a(()=>[b("span",null,o(C.groupName),1),C.isOwner?(u(),_(Fe,{key:0})):k("",!0)]),_:2},1024)]))),256))],64)):k("",!0),t.key==="action"?(u(),_(S,{key:7},{default:a(()=>[b("a",{onClick:C=>re(m)},o(e.$t("submittedTasks.list.view")),9,Le),m.taskAuditStatus==="pending"?(u(),_(J,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:C=>de(m)},{default:a(()=>[b("a",null,o(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):k("",!0),m.taskAuditStatus==="pending"?(u(),_(J,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:C=>me(m)},{default:a(()=>[b("a",Ve,o(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):k("",!0)]),_:2},1024)):k("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),T.total?(u(),p("div",xe,[l(Q,{column:2},{default:a(()=>[l(w,{label:e.$t("common.totalCount")},{default:a(()=>[i(o(T.total),1)]),_:1},8,["label"]),l(w,{label:e.$t("common.totalAmount")},{default:a(()=>[i(o(z.value),1)]),_:1},8,["label"])]),_:1})])):k("",!0)]),l(X,{open:L.value,"onUpdate:open":s[8]||(s[8]=t=>L.value=t),title:"任务详情",footer:null},{default:a(()=>[l(Q,{column:1},{default:a(()=>[l(w,{label:"任务名称"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.taskName),1)]}),_:1}),l(w,{label:"任务类型"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.taskType),1)]}),_:1}),l(w,{label:"任务描述"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.description),1)]}),_:1}),l(w,{label:"任务奖励"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.reward),1)]}),_:1}),l(w,{label:"创建时间"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(X,{open:$.value,"onUpdate:open":s[10]||(s[10]=t=>$.value=t),title:"拒绝原因",onOk:ce,confirmLoading:P.value},{default:a(()=>[l(Se,{value:A.value,"onUpdate:value":s[9]||(s[9]=t=>A.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Qe=Ce(ze,[["__scopeId","data-v-75da8d86"]]);export{Qe as default};
