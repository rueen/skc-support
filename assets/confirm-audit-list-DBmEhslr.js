import{_ as $e,a as Re,b as Ne,j as ee,r as f,c as te,k as Oe,d as p,e as b,f as l,s as k,w as a,g as d,y as ae,x as je,h as De,l as M,m as y,o as u,F as g,n as O,p as _,i,t as o,q as Me,M as Ye,A as se}from"./index-xPAs-Nek.js";import{d as Ee}from"./download-Tl83RAvl.js";import{d as We,e as Ue}from"./routeParamsEncryption-BKFTaOaF.js";import{G as He}from"./GroupOwner-C8npr1Eo.js";const Fe={class:"task-audit content-container"},Pe={class:"table-container"},xe={class:"table-header"},Be={style:{width:"100%",display:"flex","justify-content":"space-between"}},Le=["onClick"],Ve={class:"danger"},ze={key:0,class:"count-container"},qe={__name:"confirm-audit-list",setup(Ge){const Y=Re(),{t:m}=Ne(),le=ee(()=>Y.loaded?Y.getEnumOptions("TaskAuditStatus"):[]),E=De(),W=je(),U=f(!1),x=f(!1),I=f(!1),H=f(!1),A=f(""),$=f(null),v=f([]),F=f([]),B=()=>{const e=ae().startOf("month").format("YYYY-MM-DD HH:mm:ss"),s=ae().endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,s]},n=te({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:B(),completedTaskCount:void 0,keyword:""}),L=f([]),V=f([]),ne=ee(()=>[{title:m("submittedTasks.list.taskName"),key:"taskName"},{title:m("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:m("submittedTasks.list.memberInfo"),key:"member"},{title:m("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:m("submittedTasks.rejectTimes"),dataIndex:"rejectTimes",key:"rejectTimes"},{title:m("submittedTasks.preAuditor"),key:"preWaiterName"},{title:m("submittedTasks.preAuditTime"),key:"preAuditTime"},{title:m("submittedTasks.confirmAuditor"),key:"waiterName"},{title:m("submittedTasks.confirmAuditTime"),key:"confirmAuditTime"},{title:m("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),R=f([]),z=f(0),T=te({current:1,pageSize:10,total:0}),oe={selectedRowKeys:v,onChange:e=>{v.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},q=f(null),ue=()=>{const e=W.query.filters;if(e){q.value=We(e),Object.assign(n,{taskAuditStatus:null},q.value);const s={...W.query};delete s.filters,E.replace({path:W.path,query:s})}},G=()=>{T.current=1,P()},ie=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:B(),completedTaskCount:void 0,keyword:""}),G()},re=e=>{Object.assign(T,e),P()},de=e=>{E.push(`/member/view/${e.memberId}`)},me=e=>{var h,r;const s=Ue({...n,submitStartTime:(h=n.submitTimeRange)==null?void 0:h[0],submitEndTime:(r=n.submitTimeRange)==null?void 0:r[1],submitTimeRange:void 0});E.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:s}})},ce=async e=>{v.value=[e.id],K()},K=async()=>{if(!v.value.length){y.warning(m("submittedTasks.list.selectTask"));return}const e=await se("taskSubmitted.batchConfirmAuditApprove",{ids:v.value});e.code===0?(y.success(m("submittedTasks.resolveSuccess")),R.value.forEach(s=>{v.value.includes(s.id)&&(s.taskAuditStatus="approved")}),v.value=[]):y.error(e.message)},pe=e=>{v.value=[e.id],A.value="",I.value=!0},ke=async()=>{if(!A.value){y.error("请输入拒绝原因");return}H.value=!0;try{await se("taskSubmitted.batchConfirmAuditReject",{ids:v.value,reason:A.value}),y.success("审核拒绝成功"),I.value=!1,R.value.forEach(e=>{v.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),v.value=[]}catch(e){y.error(e.message)}finally{H.value=!1}},fe=()=>{if(!v.value.length){y.warning("请选择要拒绝的任务");return}A.value="",I.value=!0},ve=async()=>{const e=await M("channel.list");e.code===0&&(L.value=e.data.list)},be=()=>{Ye.confirm({title:m("common.export"),content:m("common.confirmExportContent"),onOk:async()=>{var e,s;try{const h=y.loading(m("common.exporting"),0),r={taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword};await Ee("taskSubmitted.confirmAuditExport",r,`复审列表_${new Date().toLocaleDateString()}.xlsx`),h(),y.success(m("common.exportSuccess"))}catch(h){console.error("导出失败:",h),y.error(m("common.exportFailed"))}}})},J=async(e="")=>{try{const s=await M("group.list",{page:1,pageSize:50,keyword:e});s.code===0&&(V.value=s.data.list||[])}catch{y.error("获取群组列表失败")}},P=async()=>{var e,s;U.value=!0;try{const h={page:T.current,pageSize:T.pageSize,taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword},r=await M("taskSubmitted.confirmAuditList",{...h});r.code===0?(R.value=r.data.list,T.total=r.data.total,z.value=r.data.totalAmount):y.error(r.message)}finally{U.value=!1}},ye=async()=>{if(F.value.length)return;const e=await M("waiter.list",{page:1,pageSize:100});e.code===0&&(F.value=e.data.list||[])};return Oe(()=>{ue(),P(),J(),ve(),ye()}),(e,s)=>{const h=d("a-input"),r=d("a-form-item"),j=d("a-select-option"),D=d("a-select"),he=d("a-range-picker"),ge=d("a-input-number"),_e=d("a-form"),N=d("a-button"),S=d("a-space"),Te=d("DownloadOutlined"),we=d("a-avatar"),Ae=d("a-typography-link"),Se=d("a-tag"),Q=d("a-popconfirm"),Ce=d("a-table"),w=d("a-descriptions-item"),X=d("a-descriptions"),Z=d("a-modal"),Ie=d("a-textarea");return u(),p("div",Fe,[b("div",Pe,[b("div",xe,[l(_e,{layout:"inline",model:n},{default:a(()=>[l(r,{label:e.$t("submittedTasks.search.taskName")},{default:a(()=>[l(h,{value:n.taskName,"onUpdate:value":s[0]||(s[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.channel")},{default:a(()=>[l(D,{value:n.channelId,"onUpdate:value":s[1]||(s[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,O(L.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.submitTime")},{default:a(()=>[l(he,{value:n.submitTimeRange,"onUpdate:value":s[2]||(s[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[l(D,{value:n.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=t=>n.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),p(g,null,O(le.value,t=>(u(),_(j,{key:t.value,value:t.value},{default:a(()=>[i(o(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.preAuditor")},{default:a(()=>[l(D,{value:n.preWaiterId,"onUpdate:value":s[4]||(s[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:a(()=>[(u(!0),p(g,null,O(F.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.groupId")},{default:a(()=>[l(D,{value:n.groupId,"onUpdate:value":s[5]||(s[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:J},{default:a(()=>[(u(!0),p(g,null,O(V.value,t=>(u(),_(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[l(ge,{value:n.completedTaskCount,"onUpdate:value":s[6]||(s[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),l(r,{label:e.$t("member.search.keyword")},{default:a(()=>[l(h,{value:n.keyword,"onUpdate:value":s[7]||(s[7]=t=>n.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),b("div",Be,[b("div",null,[l(S,null,{default:a(()=>[l(N,{type:"primary",onClick:G},{default:a(()=>[i(o(e.$t("common.search")),1)]),_:1}),l(N,{onClick:ie},{default:a(()=>[i(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),b("div",null,[l(S,null,{default:a(()=>[R.value.length?(u(),_(N,{key:0,onClick:be},{icon:a(()=>[l(Te)]),default:a(()=>[i(" "+o(e.$t("common.export")),1)]),_:1})):k("",!0),l(N,{type:"primary",onClick:K},{default:a(()=>[i(o(e.$t("common.batchResolve")),1)]),_:1}),l(N,{danger:"",onClick:fe},{default:a(()=>[i(o(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(Ce,{columns:ne.value,"data-source":R.value,loading:U.value,pagination:T,"row-selection":oe,rowKey:"id",onChange:re},{bodyCell:a(({column:t,record:c})=>[t.key==="taskName"?(u(),_(S,{key:0},{default:a(()=>[l(we,{src:c.channelIcon,size:"small"},null,8,["src"]),b("span",null,o(c.taskName),1)]),_:2},1024)):k("",!0),t.key==="taskAuditStatus"?(u(),p(g,{key:1},[i(o(Me(Y).getEnumText("TaskAuditStatus",c.taskAuditStatus)),1)],64)):k("",!0),t.key==="preWaiterName"?(u(),p(g,{key:2},[i(o(c.preWaiterName||"--"),1)],64)):k("",!0),t.key==="preAuditTime"?(u(),p(g,{key:3},[i(o(c.preAuditTime||"--"),1)],64)):k("",!0),t.key==="waiterName"?(u(),p(g,{key:4},[i(o(c.waiterName||"--"),1)],64)):k("",!0),t.key==="confirmAuditTime"?(u(),p(g,{key:5},[i(o(c.auditTime||"--"),1)],64)):k("",!0),t.key==="member"?(u(),p(g,{key:6},[b("div",null,[l(S,null,{default:a(()=>[l(Ae,{onClick:C=>de(c)},{default:a(()=>[i(o(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(u(),_(Se,{key:0,color:"green"},{default:a(()=>s[11]||(s[11]=[i("new")])),_:1})):k("",!0)]),_:2},1024)]),b("div",null,o(c.account),1),(u(!0),p(g,null,O(c.groups,C=>(u(),p("div",null,[l(S,null,{default:a(()=>[b("span",null,o(C.groupName),1),C.isOwner?(u(),_(He,{key:0})):k("",!0)]),_:2},1024)]))),256))],64)):k("",!0),t.key==="action"?(u(),_(S,{key:7},{default:a(()=>[b("a",{onClick:C=>me(c)},o(e.$t("submittedTasks.list.view")),9,Le),c.taskAuditStatus==="pending"?(u(),_(Q,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:C=>ce(c)},{default:a(()=>[b("a",null,o(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):k("",!0),c.taskAuditStatus==="pending"?(u(),_(Q,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:C=>pe(c)},{default:a(()=>[b("a",Ve,o(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):k("",!0)]),_:2},1024)):k("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),T.total?(u(),p("div",ze,[l(X,{column:2},{default:a(()=>[l(w,{label:e.$t("common.totalCount")},{default:a(()=>[i(o(T.total),1)]),_:1},8,["label"]),l(w,{label:e.$t("common.totalAmount")},{default:a(()=>[i(o(z.value),1)]),_:1},8,["label"])]),_:1})])):k("",!0)]),l(Z,{open:x.value,"onUpdate:open":s[8]||(s[8]=t=>x.value=t),title:"任务详情",footer:null},{default:a(()=>[l(X,{column:1},{default:a(()=>[l(w,{label:"任务名称"},{default:a(()=>{var t;return[i(o((t=$.value)==null?void 0:t.taskName),1)]}),_:1}),l(w,{label:"任务类型"},{default:a(()=>{var t;return[i(o((t=$.value)==null?void 0:t.taskType),1)]}),_:1}),l(w,{label:"任务描述"},{default:a(()=>{var t;return[i(o((t=$.value)==null?void 0:t.description),1)]}),_:1}),l(w,{label:"任务奖励"},{default:a(()=>{var t;return[i(o((t=$.value)==null?void 0:t.reward),1)]}),_:1}),l(w,{label:"创建时间"},{default:a(()=>{var t;return[i(o((t=$.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(Z,{open:I.value,"onUpdate:open":s[10]||(s[10]=t=>I.value=t),title:"拒绝原因",onOk:ke,confirmLoading:H.value},{default:a(()=>[l(Ie,{value:A.value,"onUpdate:value":s[9]||(s[9]=t=>A.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Ze=$e(qe,[["__scopeId","data-v-3d873225"]]);export{Ze as default};
