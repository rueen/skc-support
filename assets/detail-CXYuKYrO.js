import{_ as ie,b as oe,r as g,c as q,j as Z,D as te,k as se,p as H,o as m,w as s,e as L,d as b,s as U,f as l,g as c,i as G,t as f,F as de,l as ae,m as I,B as re,x as ke,y as ee,h as ge,n as _e,z as he,A as ye}from"./index-C7WthnMs.js";import{P as be}from"./PageHeader-DfBZ-JPU.js";import{S as Ie}from"./SelectTask-CGNxR5MH.js";const Te={class:"select-task-group-modal"},$e={class:"filter-form"},Ce={key:0,class:"selected-info"},we={key:1,class:"selected-info"},Ge={__name:"SelectTaskGroup",props:{visible:{type:Boolean,default:!1},selectedId:{type:[Array,Number,String],default:()=>[]},selectedTaskGroupInfo:{type:Object,default:()=>({})},mode:{type:String,default:"multiple",validator:P=>["multiple","single"].includes(P)}},emits:["update:visible","confirm","cancel"],setup(P,{emit:T}){const{t:C}=oe(),o=P,w=T,_=g(!1),M=g(!1),d=g([]),e=g(null),v=q({taskGroupName:"",taskName:""}),V=Z(()=>[{title:C("task.group.name"),dataIndex:"taskGroupName",key:"taskGroupName",width:200},{title:C("task.group.statistics"),key:"statistics",width:120},{title:C("task.group.createTime"),dataIndex:"createTime",key:"createTime",sorter:!0},{title:C("task.group.updateTime"),dataIndex:"updateTime",key:"updateTime",sorter:!0}]),$=g([]),k=q({current:1,pageSize:10,total:0}),z=q({sorterField:void 0,sorterOrder:void 0}),O=Z(()=>o.mode==="single"?{type:"radio",selectedRowKeys:d.value,onChange:(i,t)=>{E(i,t)},getCheckboxProps:i=>({disabled:!1})}:{selectedRowKeys:d.value,onChange:(i,t)=>{K(i)},getCheckboxProps:i=>({disabled:!1})}),E=(i,t)=>{d.value=i||[],e.value=t&&t.length>0?t[0]:null},K=(i,t)=>{const r=$.value.map(h=>h.id),u=d.value.filter(h=>!r.includes(h));d.value=[...u,...i]},D=()=>{k.current=1,B()},W=()=>{v.taskGroupName="",v.taskName="",D()},R=(i,t,r)=>{Object.assign(k,i),Object.assign(z,{sorterField:r.field,sorterOrder:r.order}),B()},J=()=>{o.mode==="single"?w("confirm",{taskGroupId:d.value[0]||null,taskGroup:e.value}):w("confirm",{taskGroupIds:d.value}),F()},F=()=>{w("update:visible",!1),w("cancel")},B=async()=>{_.value=!0;try{const i=await ae("taskGroup.list",{page:k.current,pageSize:k.pageSize,...z,...v});if(i.code===0){if($.value=i.data.list,k.total=i.data.total,o.mode==="single"&&d.value.length>0&&!e.value){const t=d.value[0],r=$.value.find(u=>u.id===t);r&&(e.value=r)}}else I.error(i.message)}finally{_.value=!1}},Y=()=>{if(o.mode==="single"){let i=null;if(Array.isArray(o.selectedId)?i=o.selectedId.length>0?o.selectedId[0]:null:i=o.selectedId,i!=null&&i!==""){d.value=[i];const t=$.value.find(r=>r.id===i);t?e.value=t:e.value=o.selectedTaskGroupInfo}else d.value=[],e.value=null}else o.selectedId&&o.selectedId.length>0?d.value=Array.isArray(o.selectedId)?[...o.selectedId]:[o.selectedId]:d.value=[]};return te(()=>o.visible,i=>{i?(B(),Y()):(d.value=[],o.mode==="single"&&(e.value=null),k.current=1)}),te(()=>o.selectedId,()=>{o.visible&&Y()},{deep:!0}),se(()=>{o.visible&&(B(),Y())}),(i,t)=>{const r=c("a-input"),u=c("a-form-item"),h=c("a-button"),S=c("a-space"),Q=c("a-form"),a=c("a-alert"),n=c("a-table"),N=c("a-modal");return m(),H(N,{open:P.visible,title:i.$t("task.selectTaskGroup.title"),width:900,"confirm-loading":M.value,onOk:J,onCancel:F},{default:s(()=>[L("div",Te,[L("div",$e,[l(Q,{layout:"inline",model:v},{default:s(()=>[l(u,{label:i.$t("task.search.taskGroupName")},{default:s(()=>[l(r,{value:v.taskGroupName,"onUpdate:value":t[0]||(t[0]=y=>v.taskGroupName=y),placeholder:i.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(u,{label:i.$t("task.search.taskName")},{default:s(()=>[l(r,{value:v.taskName,"onUpdate:value":t[1]||(t[1]=y=>v.taskName=y),placeholder:i.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(u,null,{default:s(()=>[l(S,null,{default:s(()=>[l(h,{type:"primary",onClick:D},{default:s(()=>[G(f(i.$t("common.search")),1)]),_:1}),l(h,{onClick:W},{default:s(()=>[G(f(i.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),o.mode==="multiple"?(m(),b("div",Ce,[l(a,{message:i.$t("task.selectTaskGroup.selectedCount",{count:d.value.length}),type:"info","show-icon":""},null,8,["message"])])):U("",!0),o.mode==="single"&&e.value?(m(),b("div",we,[l(a,{message:i.$t("task.selectTaskGroup.selectedTaskGroup",{name:e.value.taskGroupName}),type:"info","show-icon":""},null,8,["message"])])):U("",!0),l(n,{columns:V.value,"data-source":$.value,loading:_.value,pagination:k,"row-selection":O.value,rowKey:"id",onChange:R,size:"middle"},{bodyCell:s(({column:y,record:A})=>[y.key==="statistics"?(m(),b(de,{key:0},[G(f(A.enrolledCount)+"/"+f(A.completedCount),1)],64)):U("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},Se=ie(Ge,[["__scopeId","data-v-a529a67c"]]),Ne={class:"select-article-modal"},Ae={class:"filter-form"},Ue={key:0,class:"selected-info"},Pe={key:1,class:"selected-info"},De={key:0,class:"content-preview"},Ye=["onClick"],Be={__name:"SelectArticle",props:{visible:{type:Boolean,default:!1},selectedId:{type:[Array,Number,String],default:()=>[]},selectedArticleInfo:{type:Object,default:()=>({})},mode:{type:String,default:"multiple",validator:P=>["multiple","single"].includes(P)}},emits:["update:visible","confirm","cancel"],setup(P,{emit:T}){const{t:C}=oe(),o=P,w=T,_=g(!1),M=g(!1),d=g([]),e=g(null),v=q({title:"",location:""}),V=Z(()=>[{title:C("article.title"),dataIndex:"title",key:"title",width:200},{title:C("article.updateTime"),dataIndex:"updateTime",key:"updateTime",width:180},{title:C("article.action"),key:"action",width:100}]),$=g([]),k=q({current:1,pageSize:10,total:0}),z=q({sorterField:void 0,sorterOrder:void 0}),O=Z(()=>o.mode==="single"?{type:"radio",selectedRowKeys:d.value,onChange:(t,r)=>{E(t,r)},getCheckboxProps:t=>({disabled:!1})}:{selectedRowKeys:d.value,onChange:(t,r)=>{K(t)},getCheckboxProps:t=>({disabled:!1})}),E=(t,r)=>{d.value=t||[],e.value=r&&r.length>0?r[0]:null},K=(t,r)=>{const u=$.value.map(S=>S.id),h=d.value.filter(S=>!u.includes(S));d.value=[...h,...t]},D=()=>{k.current=1,Y()},W=()=>{v.title="",v.location="",D()},R=(t,r,u)=>{Object.assign(k,t),Object.assign(z,{sorterField:u.field,sorterOrder:u.order}),Y()},J=t=>{window.open(`${re.h5Url}/article/${t.id}`,"_blank")},F=()=>{o.mode==="single"?w("confirm",{articleId:d.value[0]||null,article:e.value}):w("confirm",{articleIds:d.value}),B()},B=()=>{w("update:visible",!1),w("cancel")},Y=async()=>{_.value=!0;try{const t=await ae("article.list",{page:k.current,pageSize:k.pageSize,...z,...v});if(t.code===0){if($.value=t.data.list,k.total=t.data.total,o.mode==="single"&&d.value.length>0&&!e.value){const r=d.value[0],u=$.value.find(h=>h.id===r);u&&(e.value=u)}}else I.error(t.message)}finally{_.value=!1}},i=()=>{if(o.mode==="single"){let t=null;if(Array.isArray(o.selectedId)?t=o.selectedId.length>0?o.selectedId[0]:null:t=o.selectedId,t!=null&&t!==""){d.value=[t];const r=$.value.find(u=>u.id===t);r?e.value=r:e.value=o.selectedArticleInfo}else d.value=[],e.value=null}else o.selectedId&&o.selectedId.length>0?d.value=Array.isArray(o.selectedId)?[...o.selectedId]:[o.selectedId]:d.value=[]};return te(()=>o.visible,t=>{t?(Y(),i()):(d.value=[],o.mode==="single"&&(e.value=null),k.current=1)}),te(()=>o.selectedId,()=>{o.visible&&i()},{deep:!0}),se(()=>{o.visible&&(Y(),i())}),(t,r)=>{const u=c("a-input"),h=c("a-form-item"),S=c("a-button"),Q=c("a-space"),a=c("a-form"),n=c("a-alert"),N=c("a-table"),y=c("a-modal");return m(),H(y,{open:P.visible,title:t.$t("article.selectArticle.title"),width:900,"confirm-loading":M.value,onOk:F,onCancel:B},{default:s(()=>[L("div",Ne,[L("div",Ae,[l(a,{layout:"inline",model:v},{default:s(()=>[l(h,{label:t.$t("article.title")},{default:s(()=>[l(u,{value:v.title,"onUpdate:value":r[0]||(r[0]=A=>v.title=A),placeholder:t.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(h,{label:t.$t("article.location")},{default:s(()=>[l(u,{value:v.location,"onUpdate:value":r[1]||(r[1]=A=>v.location=A),placeholder:t.$t("common.inputPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(h,null,{default:s(()=>[l(Q,null,{default:s(()=>[l(S,{type:"primary",onClick:D},{default:s(()=>[G(f(t.$t("common.search")),1)]),_:1}),l(S,{onClick:W},{default:s(()=>[G(f(t.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),o.mode==="multiple"?(m(),b("div",Ue,[l(n,{message:t.$t("article.selectArticle.selectedCount",{count:d.value.length}),type:"info","show-icon":""},null,8,["message"])])):U("",!0),o.mode==="single"&&e.value?(m(),b("div",Pe,[l(n,{message:t.$t("article.selectArticle.selectedArticle",{title:e.value.title}),type:"info","show-icon":""},null,8,["message"])])):U("",!0),l(N,{columns:V.value,"data-source":$.value,loading:_.value,pagination:k,"row-selection":O.value,rowKey:"id",onChange:R,size:"middle"},{bodyCell:s(({column:A,record:j})=>[A.key==="content"?(m(),b("div",De,f(j.content.length>50?j.content.substring(0,50)+"...":j.content),1)):U("",!0),A.key==="action"?(m(),b("a",{key:1,onClick:le=>J(j)},f(t.$t("article.preview")),9,Ye)):U("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},Oe=ie(Be,[["__scopeId","data-v-e15b9aed"]]),Re={class:"content-container"},ze={class:"form-container"},qe={key:0},Me={key:0},Fe={key:1},je={key:0},He={key:1},Le={key:0},Ve={key:1},Je={__name:"detail",setup(P){const{t:T}=oe(),C=ke(),o=ge(),w=g(),_=g([]),M={action:re.imageUploadUrl,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}},d=Z(()=>C.name==="AdEdit"),e=q({title:"",location:"home_banner",startTime:void 0,endTime:void 0,content:{adImage:"",linkType:"none",articleId:null,articleName:null,taskId:null,taskName:null,taskGroupId:null,taskGroupName:null}}),v={title:[{required:!0,message:T("ad.detail.validation.titleRequired")}],location:[{required:!0,message:T("ad.detail.validation.locationRequired")}],startTime:[{required:!0,message:T("ad.detail.validation.startTimeRequired")}],endTime:[{required:!0,message:T("ad.detail.validation.endTimeRequired")}]},V=a=>{a.file.status==="removed"&&(e.content.adImage="")},$=a=>{a.code===0?(e.content.adImage=a.data.url,_.value=[{uid:"-1",name:"image.png",status:"done",url:e.content.adImage}],I.success("上传成功")):(I.error(response.message||"上传失败"),_.value=_.value.filter(n=>n.uid!==file.uid))},k=()=>{I.error("上传失败"),_.value=[]},z=a=>a.type.startsWith("image/")?a.size/1024/1024<1?!0:(I.error("图片必须小于 1MB！"),!1):(I.error("只能上传图片文件！"),!1),O=g(!1),E=()=>{O.value=!0},K=({taskId:a,task:n})=>{a&&n&&(e.content.taskId=a,e.content.taskName=n.taskName,O.value=!1)},D=g(!1),W=()=>{D.value=!0},R=g(!1),J=()=>{R.value=!0},F=({taskGroupId:a,taskGroup:n})=>{a&&n&&(e.content.taskGroupId=a,e.content.taskGroupName=n.taskGroupName,R.value=!1)},B=({articleId:a,article:n})=>{a&&n&&(e.content.articleId=a,e.content.articleName=n.title,D.value=!1)},Y=async a=>{try{t.value=!0;const n=await ye("ad.add",a);n.code===0?(I.success(T("common.submitSuccess")),o.back()):I.error(n.message)}catch(n){console.log(n),I.error(T("common.submitFailed"))}finally{t.value=!1}},i=async a=>{try{t.value=!0;const n=await he("ad.edit",{...a},{urlParams:{id:C.params.id}});n.code===0?(I.success(T("common.submitSuccess")),o.back()):I.error(n.message)}catch(n){console.log(n),I.error(T("common.submitFailed"))}finally{t.value=!1}},t=g(!1),r=()=>{w.value.validate().then(async()=>{if(!e.content.adImage){I.error(T("ad.detail.validation.adImageRequired"));return}const a={...e,startTime:e.startTime?ee(e.startTime).format("YYYY-MM-DD HH:mm:ss"):null,endTime:e.endTime?ee(e.endTime).format("YYYY-MM-DD HH:mm:ss"):null};d.value?await i(a):await Y(a)})},u=()=>{o.back()},h=async a=>{try{const n=await ae("ad.detail",{},{urlParams:{id:a}});if(n.code===0){const N=n.data;Object.assign(e,N,{startTime:ee(N.startTime),endTime:ee(N.endTime)}),_.value=[{uid:"-1",name:"image.png",status:"done",url:N.content.adImage}]}}catch(n){console.log(n),I.error(n)}},S=g([]),Q=async()=>{try{const a=await ae("public.location",{});a.code===0&&(S.value=a.data||[])}catch(a){console.log(a)}};return se(()=>{Q(),d.value&&h(C.params.id)}),(a,n)=>{const N=c("a-input"),y=c("a-form-item"),A=c("a-select-option"),j=c("a-select"),le=c("a-date-picker"),ne=c("a-col"),ce=c("a-row"),ue=c("plus-outlined"),me=c("a-upload"),x=c("a-radio"),pe=c("a-radio-group"),X=c("a-button"),fe=c("a-space"),ve=c("a-form");return m(),b("div",Re,[l(be,{title:d.value?a.$t("ad.detail.editTitle"):a.$t("ad.detail.createTitle"),back:!0,class:"page-header"},null,8,["title"]),L("div",ze,[l(ve,{ref_key:"formRef",ref:w,model:e,rules:v,"label-col":{span:5},"wrapper-col":{span:18},layout:"horizontal"},{default:s(()=>[l(y,{label:a.$t("ad.detail.title"),name:"title"},{default:s(()=>[l(N,{value:e.title,"onUpdate:value":n[0]||(n[0]=p=>e.title=p),placeholder:a.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),l(y,{label:a.$t("ad.detail.location"),name:"location"},{default:s(()=>[l(j,{value:e.location,"onUpdate:value":n[1]||(n[1]=p=>e.location=p),placeholder:a.$t("common.selectPlaceholder")},{default:s(()=>[(m(!0),b(de,null,_e(S.value,p=>(m(),H(A,{key:p.code,value:p.code},{default:s(()=>[G(f(p.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(y,{label:a.$t("ad.detail.adTime"),required:""},{default:s(()=>[l(ce,{gutter:8},{default:s(()=>[l(ne,{span:11},{default:s(()=>[l(y,{name:"startTime"},{default:s(()=>[l(le,{value:e.startTime,"onUpdate:value":n[2]||(n[2]=p=>e.startTime=p),"show-time":"",style:{width:"100%"},placeholder:a.$t("ad.detail.startTime"),format:"YYYY-MM-DD HH:mm:ss"},null,8,["value","placeholder"])]),_:1})]),_:1}),l(ne,{span:2,style:{"text-align":"center","line-height":"32px"}},{default:s(()=>n[9]||(n[9]=[L("span",null,"至",-1)])),_:1}),l(ne,{span:11},{default:s(()=>[l(y,{name:"endTime"},{default:s(()=>[l(le,{value:e.endTime,"onUpdate:value":n[3]||(n[3]=p=>e.endTime=p),"show-time":"",style:{width:"100%"},placeholder:a.$t("ad.detail.endTime"),format:"YYYY-MM-DD HH:mm:ss"},null,8,["value","placeholder"])]),_:1})]),_:1})]),_:1})]),_:1},8,["label"]),l(y,{label:a.$t("ad.detail.adImage"),required:""},{default:s(()=>[l(me,{"file-list":_.value,"onUpdate:fileList":n[4]||(n[4]=p=>_.value=p),action:M.action,headers:M.headers,"before-upload":z,onSuccess:$,onError:k,onChange:V,accept:"image/*","list-type":"picture-card","max-count":1},{default:s(()=>[_.value.length?U("",!0):(m(),b("div",qe,[l(ue)]))]),_:1},8,["file-list","action","headers"])]),_:1},8,["label"]),l(y,{label:a.$t("ad.detail.link"),required:""},{default:s(()=>[l(pe,{value:e.content.linkType,"onUpdate:value":n[5]||(n[5]=p=>e.content.linkType=p),name:"linkType"},{default:s(()=>[l(x,{value:"none"},{default:s(()=>[G(f(a.$t("ad.detail.linkType.none")),1)]),_:1}),l(x,{value:"article"},{default:s(()=>[G(f(a.$t("ad.detail.linkType.article")),1)]),_:1}),l(x,{value:"task"},{default:s(()=>[G(f(a.$t("ad.detail.linkType.task")),1)]),_:1}),l(x,{value:"taskGroup"},{default:s(()=>[G(f(a.$t("ad.detail.linkType.taskGroup")),1)]),_:1})]),_:1},8,["value"]),e.content.linkType==="article"?(m(),H(X,{key:0,type:"primary",onClick:W},{default:s(()=>[e.content.articleId!=null?(m(),b("span",Me,f(a.$t("ad.detail.selectArticleBtnText",{name:e.content.articleName})),1)):(m(),b("span",Fe,f(a.$t("ad.detail.selectArticleBtnText1")),1))]),_:1})):U("",!0),e.content.linkType==="task"?(m(),H(X,{key:1,type:"primary",onClick:E},{default:s(()=>[e.content.taskId!=null?(m(),b("span",je,f(a.$t("ad.detail.selectTaskBtnText",{name:e.content.taskName})),1)):(m(),b("span",He,f(a.$t("ad.detail.selectTaskBtnText1")),1))]),_:1})):U("",!0),e.content.linkType==="taskGroup"?(m(),H(X,{key:2,type:"primary",onClick:J},{default:s(()=>[e.content.taskGroupId!=null?(m(),b("span",Le,f(a.$t("ad.detail.selectTaskGroupBtnText",{name:e.content.taskGroupName})),1)):(m(),b("span",Ve,f(a.$t("ad.detail.selectTaskGroupBtnText1")),1))]),_:1})):U("",!0)]),_:1},8,["label"]),l(y,{"wrapper-col":{span:16,offset:4}},{default:s(()=>[l(fe,null,{default:s(()=>[l(X,{type:"primary",onClick:r},{default:s(()=>[G(f(a.$t("common.submit")),1)]),_:1}),l(X,{onClick:u},{default:s(()=>[G(f(a.$t("common.cancel")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),l(Ie,{visible:O.value,"onUpdate:visible":n[6]||(n[6]=p=>O.value=p),selectedId:e.content.taskId,selectedTaskInfo:{taskName:e.content.taskName,taskId:e.content.taskId},mode:"single",onConfirm:K},null,8,["visible","selectedId","selectedTaskInfo"]),l(Se,{visible:R.value,"onUpdate:visible":n[7]||(n[7]=p=>R.value=p),selectedId:e.content.taskGroupId,selectedTaskGroupInfo:{taskGroupName:e.content.taskGroupName,taskGroupId:e.content.taskGroupId},mode:"single",onConfirm:F},null,8,["visible","selectedId","selectedTaskGroupInfo"]),l(Oe,{visible:D.value,"onUpdate:visible":n[8]||(n[8]=p=>D.value=p),selectedId:e.content.articleId,selectedArticleInfo:{title:e.content.articleName,id:e.content.articleId},mode:"single",onConfirm:B},null,8,["visible","selectedId","selectedArticleInfo"])])}}};export{Je as default};
