import{_ as Te,a as _e,b as we,j as V,r as h,c as G,k as Se,d as g,e as k,f as n,w as l,g as i,x as Ae,h as Pe,l as j,m as f,o,F as T,n as I,p as b,i as m,t as r,s as y,q as $e,M as Ce,A as K}from"./index-RFcAcScc.js";import{d as Ie}from"./download-D8JVeGNN.js";import{d as Re,e as Ne}from"./routeParamsEncryption-BKFTaOaF.js";import{G as je}from"./GroupOwner-BBHin5hc.js";const Oe={class:"task-audit content-container"},We={class:"table-container"},De={class:"table-header"},Ee={style:{width:"100%",display:"flex","justify-content":"space-between"}},Ue=["onClick"],Fe={class:"danger"},Me={__name:"pre-audit-list",setup(Ye){const O=_e(),{t:d}=we(),J=V(()=>O.loaded?O.getEnumOptions("TaskPreAuditStatus"):[]),W=Ae(),D=Pe(),E=h(!1),P=h(!1),U=h(!1),_=h(""),p=h([]),Y=h(null),Q=()=>{const e=W.query.filters;if(e){Y.value=Re(e),Object.assign(s,{taskPreAuditStatus:null},Y.value);const t={...W.query};delete t.filters,D.replace({path:W.path,query:t})}},s=G({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),B=h([]),L=h([]),F=h([]),X=V(()=>[{title:d("submittedTasks.list.taskName"),key:"taskName"},{title:d("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:d("submittedTasks.list.memberInfo"),key:"member"},{title:d("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:d("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:d("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),$=h([]),w=G({current:1,pageSize:10,total:0}),Z={selectedRowKeys:p,onChange:e=>{p.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},q=()=>{w.current=1,M()},ee=()=>{Object.assign(s,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),q()},te=e=>{Object.assign(w,e),M()},ae=e=>{D.push(`/member/view/${e.memberId}`)},se=e=>{var v,u;const t=Ne({...s,submitStartTime:(v=s.submitTimeRange)==null?void 0:v[0],submitEndTime:(u=s.submitTimeRange)==null?void 0:u[1],submitTimeRange:void 0});D.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"pre",filters:t}})},le=async e=>{p.value=[e.id],x()},x=async()=>{if(!p.value.length){f.warning(d("submittedTasks.list.selectTask"));return}const e=await K("taskSubmitted.batchPreAuditApprove",{ids:p.value});e.code===0?(f.success(d("submittedTasks.resolveSuccess")),$.value.forEach(t=>{p.value.includes(t.id)&&(t.taskPreAuditStatus="approved")}),p.value=[]):f.error(e.message)},ne=e=>{p.value=[e.id],_.value="",P.value=!0},oe=async()=>{if(!_.value){f.error(d("submittedTasks.rejectReasonRequired"));return}U.value=!0;try{await K("taskSubmitted.batchPreAuditReject",{ids:p.value,reason:_.value}),f.success(d("submittedTasks.rejectSuccess")),P.value=!1,$.value.forEach(e=>{p.value.includes(e.id)&&(e.taskPreAuditStatus="rejected")}),p.value=[]}catch(e){f.error(e.message)}finally{U.value=!1}},ue=()=>{if(!p.value.length){f.warning(d("submittedTasks.list.selectTask"));return}_.value="",P.value=!0},re=async()=>{const e=await j("channel.list");e.code===0&&(B.value=e.data.list)},ie=()=>{Ce.confirm({title:d("common.export"),content:d("common.confirmExportContent"),onOk:async()=>{var e,t;try{const v=f.loading(d("common.exporting"),0),u={taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword};await Ie("taskSubmitted.preAuditExport",u,`初审列表_${new Date().toLocaleDateString()}.xlsx`),v(),f.success(d("common.exportSuccess"))}catch(v){console.error("导出失败:",v),f.error(d("common.exportFailed"))}}})},z=async(e="")=>{try{const t=await j("group.list",{page:1,pageSize:50,keyword:e});t.code===0&&(L.value=t.data.list||[])}catch{f.error("获取群组列表失败")}},M=async()=>{var e,t;E.value=!0;try{const v={page:w.current,pageSize:w.pageSize,taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword},u=await j("taskSubmitted.preAuditList",{...v});u.code===0?($.value=u.data.list,w.total=u.data.total):f.error(u.message)}finally{E.value=!1}},de=async()=>{if(F.value.length)return;const e=await j("waiter.list",{page:1,pageSize:100});if(e.code===0){const t={id:0,username:"无"};F.value=[t,...e.data.list]}};return Se(()=>{Q(),M(),z(),re(),de()}),(e,t)=>{const v=i("a-input"),u=i("a-form-item"),R=i("a-select-option"),N=i("a-select"),ce=i("a-range-picker"),me=i("a-input-number"),pe=i("a-form"),C=i("a-button"),S=i("a-space"),ke=i("DownloadOutlined"),fe=i("a-avatar"),ve=i("a-typography-link"),be=i("a-tag"),H=i("a-popconfirm"),he=i("a-table"),ge=i("a-textarea"),ye=i("a-modal");return o(),g("div",Oe,[k("div",We,[k("div",De,[n(pe,{layout:"inline",model:s},{default:l(()=>[n(u,{label:e.$t("submittedTasks.search.taskName")},{default:l(()=>[n(v,{value:s.taskName,"onUpdate:value":t[0]||(t[0]=a=>s.taskName=a),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.channel")},{default:l(()=>[n(N,{value:s.channelId,"onUpdate:value":t[1]||(t[1]=a=>s.channelId=a),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),g(T,null,I(B.value,a=>(o(),b(R,{key:a.id,value:a.id},{default:l(()=>[m(r(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.submitTime")},{default:l(()=>[n(ce,{value:s.submitTimeRange,"onUpdate:value":t[2]||(t[2]=a=>s.submitTimeRange=a),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:l(()=>[n(N,{value:s.taskPreAuditStatus,"onUpdate:value":t[3]||(t[3]=a=>s.taskPreAuditStatus=a),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),g(T,null,I(J.value,a=>(o(),b(R,{key:a.value,value:a.value},{default:l(()=>[m(r(a.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.preAuditor")},{default:l(()=>[n(N,{value:s.preWaiterId,"onUpdate:value":t[4]||(t[4]=a=>s.preWaiterId=a),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:l(()=>[(o(!0),g(T,null,I(F.value,a=>(o(),b(R,{key:a.id,value:a.id},{default:l(()=>[m(r(a.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.groupId")},{default:l(()=>[n(N,{value:s.groupId,"onUpdate:value":t[5]||(t[5]=a=>s.groupId=a),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:z},{default:l(()=>[(o(!0),g(T,null,I(L.value,a=>(o(),b(R,{key:a.id,value:a.id},{default:l(()=>[m(r(a.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:l(()=>[n(me,{value:s.completedTaskCount,"onUpdate:value":t[6]||(t[6]=a=>s.completedTaskCount=a),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),n(u,{label:e.$t("member.search.keyword")},{default:l(()=>[n(v,{value:s.keyword,"onUpdate:value":t[7]||(t[7]=a=>s.keyword=a),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),k("div",Ee,[k("div",null,[n(S,null,{default:l(()=>[n(C,{type:"primary",onClick:q},{default:l(()=>[m(r(e.$t("common.search")),1)]),_:1}),n(C,{onClick:ee},{default:l(()=>[m(r(e.$t("common.reset")),1)]),_:1})]),_:1})]),k("div",null,[n(S,null,{default:l(()=>[$.value.length?(o(),b(C,{key:0,onClick:ie},{icon:l(()=>[n(ke)]),default:l(()=>[m(" "+r(e.$t("common.export")),1)]),_:1})):y("",!0),n(C,{type:"primary",onClick:x},{default:l(()=>[m(r(e.$t("common.batchResolve")),1)]),_:1}),n(C,{danger:"",onClick:ue},{default:l(()=>[m(r(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(he,{columns:X.value,"data-source":$.value,loading:E.value,pagination:w,"row-selection":Z,rowKey:"id",onChange:te},{bodyCell:l(({column:a,record:c})=>[a.key==="taskName"?(o(),b(S,{key:0},{default:l(()=>[n(fe,{src:c.channelIcon,size:"small"},null,8,["src"]),k("span",null,r(c.taskName),1)]),_:2},1024)):y("",!0),a.key==="taskPreAuditStatus"?(o(),g(T,{key:1},[m(r($e(O).getEnumText("TaskPreAuditStatus",c.taskPreAuditStatus)),1)],64)):y("",!0),a.key==="preWaiterName"?(o(),g(T,{key:2},[m(r(c.preWaiterName||"--"),1)],64)):y("",!0),a.key==="member"?(o(),g(T,{key:3},[k("div",null,[n(S,null,{default:l(()=>[n(ve,{onClick:A=>ae(c)},{default:l(()=>[m(r(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(o(),b(be,{key:0,color:"green"},{default:l(()=>t[10]||(t[10]=[m("new")])),_:1})):y("",!0)]),_:2},1024)]),k("div",null,r(c.account),1),(o(!0),g(T,null,I(c.groups,A=>(o(),g("div",null,[n(S,null,{default:l(()=>[k("span",null,r(A.groupName),1),A.isOwner?(o(),b(je,{key:0})):y("",!0)]),_:2},1024)]))),256))],64)):y("",!0),a.key==="action"?(o(),b(S,{key:4},{default:l(()=>[k("a",{onClick:A=>se(c)},r(e.$t("submittedTasks.list.view")),9,Ue),c.taskPreAuditStatus==="pending"?(o(),b(H,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:A=>le(c)},{default:l(()=>[k("a",null,r(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):y("",!0),c.taskPreAuditStatus==="pending"?(o(),b(H,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:A=>ne(c)},{default:l(()=>[k("a",Fe,r(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):y("",!0)]),_:2},1024)):y("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),n(ye,{open:P.value,"onUpdate:open":t[9]||(t[9]=a=>P.value=a),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:oe,confirmLoading:U.value},{default:l(()=>[n(ge,{value:_.value,"onUpdate:value":t[8]||(t[8]=a=>_.value=a),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},ze=Te(Me,[["__scopeId","data-v-a6af8b0c"]]);export{ze as default};
