import{i as d,_ as ee,j as te,r as P,a as B,k as ae,b as N,d as S,c as r,w as n,e as p,f as ne,o as f,F as E,l as F,m as b,h as g,t as U,g as w,D as oe,P as se,n as R,M as le}from"./index-Bc2y6Xff.js";import{T as L,g as re,a as ce,b as ie}from"./enums-Vx4wKXVy.js";import{c as A,a as de,g as M,d as ue}from"./request-CGi-tdZv.js";const pe=(k,h={},x="",m={})=>{const o=de.create({baseURL:A.baseUrl,timeout:6e4,responseType:"blob"});return o.interceptors.request.use(s=>{const e=localStorage.getItem("token");return e&&(s.headers.Authorization=`Bearer ${e}`),s},s=>(console.error("下载请求错误:",s),Promise.reject(s))),o({url:k,method:"get",params:h,...m}).then(s=>{let e=x;if(!e){const _=s.headers["content-disposition"];if(_){const v=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(_);if(v&&v[1]){e=v[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(D){console.error("文件名解码失败:",D)}}}if(!e){const u=s.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const i=new Blob([s.data]),l=document.createElement("a");return l.href=URL.createObjectURL(i),l.download=e,document.body.appendChild(l),l.click(),URL.revokeObjectURL(l.href),document.body.removeChild(l),{success:!0,filename:e}}).catch(s=>{let e="下载失败";if(s.response)if(s.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const i=new FileReader;i.onload=()=>{try{e=JSON.parse(i.result).message||"下载失败",d.error(e)}catch{d.error("下载失败")}},i.readAsText(s.response.data)}catch{d.error("下载失败")}else d.error(e);return Promise.reject(s)})},me=(k,h={},x="",m={})=>{const[o,s]=k.split("."),e=A.api[o]&&A.api[o][s];if(!e)return console.error(`API ${k} 不存在`),d.error(`API ${k} 不存在`),Promise.reject(new Error(`API ${k} 不存在`));let i=e;return m.urlParams&&(i=i.replace(/:([^/]+)/g,(l,_)=>{const u=m.urlParams[_];return u===void 0?(console.warn(`URL 参数 ${_} 未提供`),l):u})),pe(i,h,x,m)},fe={class:"task content-container"},_e={class:"table-container"},ke={class:"table-header"},ge={class:"left"},he={class:"right"},ve=["onClick"],ye={__name:"list",setup(k){const h=ne(),{locale:x}=te(),m=P(!1),o=B({taskName:"",channelId:void 0,taskStatus:void 0}),s=P([]),e=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"action",fixed:"right",width:180}],i=P([]),l=B({current:1,pageSize:10,total:0}),_=t=>re(ce,t,x.value),u=t=>ie[t],v=()=>{l.current=1,T()},D=()=>{o.taskName="",o.channelId=void 0,o.taskStatus=void 0,v()},z=t=>{Object.assign(l,t),T()},V=()=>{h.push("/task/create")},q=t=>{h.push(`/task/edit/${t.id}`)},J=async t=>{try{const a=await ue("task.delete",{},{urlParams:{id:t.id}});a.code===0?(d.success("删除成功"),T()):d.error(a.message)}catch{d.error("删除失败")}},G=()=>{le.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const t=d.loading("正在导出数据，请稍候...",0),a={taskName:o.taskName,channelId:o.channelId,taskStatus:o.taskStatus};await me("task.export",a,`任务列表_${new Date().toLocaleDateString()}.xlsx`),t(),d.success("导出成功")}catch(t){console.error("导出失败:",t),d.error("导出失败，请稍后重试")}}})},T=async()=>{m.value=!0;try{const t=await M("task.list",{page:l.current,pageSize:l.pageSize,...o});t.code===0?(i.value=t.data.list,l.total=t.data.total):d.error(t.message)}finally{m.value=!1}},H=async()=>{const t=await M("channel.list");t.code===0&&(s.value=t.data.list)};return ae(()=>{T(),H()}),(t,a)=>{const K=p("a-input"),C=p("a-form-item"),$=p("a-select-option"),j=p("a-select"),I=p("a-button"),O=p("a-space"),Q=p("a-form"),W=p("a-tag"),X=p("a-popconfirm"),Y=p("a-table");return f(),N("div",fe,[S("div",_e,[S("div",ke,[S("div",ge,[r(Q,{layout:"inline",model:o},{default:n(()=>[r(C,{label:"任务名称"},{default:n(()=>[r(K,{value:o.taskName,"onUpdate:value":a[0]||(a[0]=c=>o.taskName=c),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),r(C,{label:"平台渠道"},{default:n(()=>[r(j,{value:o.channelId,"onUpdate:value":a[1]||(a[1]=c=>o.channelId=c),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:n(()=>[(f(!0),N(E,null,F(s.value,c=>(f(),b($,{key:c.id,value:c.id},{default:n(()=>[g(U(c.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(C,{label:"任务状态"},{default:n(()=>[r(j,{value:o.taskStatus,"onUpdate:value":a[2]||(a[2]=c=>o.taskStatus=c),placeholder:"请选择状态",style:{width:"120px"},"allow-clear":""},{default:n(()=>[(f(!0),N(E,null,F(Object.values(w(L)),c=>(f(),b($,{key:c,value:c},{default:n(()=>[g(U(_(c)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),r(C,null,{default:n(()=>[r(O,null,{default:n(()=>[r(I,{type:"primary",onClick:v},{default:n(()=>a[3]||(a[3]=[g("查询")])),_:1}),r(I,{onClick:D},{default:n(()=>a[4]||(a[4]=[g("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),S("div",he,[r(O,null,{default:n(()=>[r(I,{onClick:G},{icon:n(()=>[r(w(oe))]),default:n(()=>[a[5]||(a[5]=g(" 导出 "))]),_:1}),r(I,{type:"primary",onClick:V},{icon:n(()=>[r(w(se))]),default:n(()=>[a[6]||(a[6]=g(" 新建任务 "))]),_:1})]),_:1})])]),r(Y,{columns:e,"data-source":i.value,loading:m.value,pagination:l,onChange:z},{bodyCell:n(({column:c,record:y})=>[c.key==="taskStatus"?(f(),b(W,{key:0,color:u(y.taskStatus)},{default:n(()=>[g(U(_(y.taskStatus)),1)]),_:2},1032,["color"])):R("",!0),c.key==="action"?(f(),b(O,{key:1},{default:n(()=>[y.taskStatus===w(L).NOT_STARTED?(f(),N("a",{key:0,onClick:Z=>q(y)},"编辑",8,ve)):R("",!0),y.taskStatus===w(L).NOT_STARTED?(f(),b(X,{key:1,title:"确定要删除该任务吗？",onConfirm:Z=>J(y)},{default:n(()=>a[7]||(a[7]=[S("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])):R("",!0)]),_:2},1024)):R("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},we=ee(ye,[["__scopeId","data-v-fb46a88f"]]);export{we as default};
