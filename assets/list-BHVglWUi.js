import{i as E,j as m,k as X,_ as Y,r as P,l as Z,a as j,m as ee,n as te,b as C,d as y,c as l,w as s,e as f,p as A,f as ae,o as h,F as T,q as B,s as O,h as v,t as U,g as D,D as ne,P as se,v as F,M as oe,x as le}from"./index-CBL5KShI.js";const re=(_,g={},k="",p={})=>{const a=X.create({baseURL:E.baseUrl,timeout:6e4,responseType:"blob"});return a.interceptors.request.use(o=>{const e=localStorage.getItem("token");return e&&(o.headers.Authorization=`Bearer ${e}`),o},o=>(console.error("下载请求错误:",o),Promise.reject(o))),a({url:_,method:"get",params:g,...p}).then(o=>{let e=k;if(!e){const i=o.headers["content-disposition"];if(i){const x=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(i);if(x&&x[1]){e=x[1].replace(/['"]/g,"");try{e=decodeURIComponent(e)}catch(I){console.error("文件名解码失败:",I)}}}if(!e){const u=o.headers["content-type"];u?u.includes("excel")||u.includes("spreadsheetml")?e="export.xlsx":u.includes("csv")?e="export.csv":u.includes("pdf")?e="export.pdf":e="export.file":e="export.file"}}const d=new Blob([o.data]),c=document.createElement("a");return c.href=URL.createObjectURL(d),c.download=e,document.body.appendChild(c),c.click(),URL.revokeObjectURL(c.href),document.body.removeChild(c),{success:!0,filename:e}}).catch(o=>{let e="下载失败";if(o.response)if(o.response.status===401)e="登录已过期，请重新登录",localStorage.removeItem("token"),window.location.href="/login";else try{const d=new FileReader;d.onload=()=>{try{e=JSON.parse(d.result).message||"下载失败",m.error(e)}catch{m.error("下载失败")}},d.readAsText(o.response.data)}catch{m.error("下载失败")}else m.error(e);return Promise.reject(o)})},ce=(_,g={},k="",p={})=>{const[a,o]=_.split("."),e=E.api[a]&&E.api[a][o];if(!e)return console.error(`API ${_} 不存在`),m.error(`API ${_} 不存在`),Promise.reject(new Error(`API ${_} 不存在`));let d=e;return p.urlParams&&(d=d.replace(/:([^/]+)/g,(c,i)=>{const u=p.urlParams[i];return u===void 0?(console.warn(`URL 参数 ${i} 未提供`),c):u})),re(d,g,k,p)},de={class:"task content-container"},ie={class:"table-container"},ue={class:"table-header"},me={class:"left"},pe={class:"right"},fe=["onClick"],_e={__name:"list",setup(_){const g=ae(),k=P(!1),p=Z(),a=j({taskName:"",channelId:void 0,taskStatus:void 0}),o=P([]),e=ee(()=>p.loaded?p.getEnumOptions("TaskStatus"):[]),d=[{title:"任务名称",dataIndex:"taskName",key:"taskName"},{title:"平台渠道",dataIndex:"channelName",key:"channelName"},{title:"任务状态",dataIndex:"taskStatus",key:"taskStatus",customRender:({text:n})=>p.getEnumText("TaskStatus",n)},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"action",fixed:"right",width:180}],c=P([]),i=j({current:1,pageSize:10,total:0}),u=()=>{i.current=1,S()},x=()=>{a.taskName="",a.channelId=void 0,a.taskStatus=void 0,u()},I=n=>{Object.assign(i,n),S()},M=()=>{g.push("/task/create")},z=n=>{g.push(`/task/edit/${n.id}`)},V=async n=>{try{const t=await le("task.delete",{},{urlParams:{id:n.id}});t.code===0?(m.success("删除成功"),S()):m.error(t.message)}catch{m.error("删除失败")}},q=()=>{oe.confirm({title:"确认导出",content:"确定要导出当前筛选条件下的所有任务数据吗？",onOk:async()=>{try{const n=m.loading("正在导出数据，请稍候...",0),t={taskName:a.taskName,channelId:a.channelId,taskStatus:a.taskStatus};await ce("task.export",t,`任务列表_${new Date().toLocaleDateString()}.xlsx`),n(),m.success("导出成功")}catch(n){console.error("导出失败:",n),m.error("导出失败，请稍后重试")}}})},S=async()=>{k.value=!0;try{const n=await A("task.list",{page:i.current,pageSize:i.pageSize,...a});n.code===0?(c.value=n.data.list,i.total=n.data.total):m.error(n.message)}finally{k.value=!1}},J=async()=>{const n=await A("channel.list");n.code===0&&(o.value=n.data.list)};return te(async()=>{S(),J()}),(n,t)=>{const G=f("a-input"),b=f("a-form-item"),$=f("a-select-option"),L=f("a-select"),w=f("a-button"),R=f("a-space"),H=f("a-form"),K=f("a-popconfirm"),Q=f("a-table");return h(),C("div",de,[y("div",ie,[y("div",ue,[y("div",me,[l(H,{layout:"inline",model:a},{default:s(()=>[l(b,{label:"任务名称"},{default:s(()=>[l(G,{value:a.taskName,"onUpdate:value":t[0]||(t[0]=r=>a.taskName=r),placeholder:"请输入任务名称","allow-clear":""},null,8,["value"])]),_:1}),l(b,{label:"平台渠道"},{default:s(()=>[l(L,{value:a.channelId,"onUpdate:value":t[1]||(t[1]=r=>a.channelId=r),placeholder:"请选择平台渠道",style:{width:"120px"},"allow-clear":""},{default:s(()=>[(h(!0),C(T,null,B(o.value,r=>(h(),O($,{key:r.id,value:r.id},{default:s(()=>[v(U(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(b,{label:"任务状态"},{default:s(()=>[l(L,{value:a.taskStatus,"onUpdate:value":t[2]||(t[2]=r=>a.taskStatus=r),placeholder:"请选择任务状态",allowClear:""},{default:s(()=>[(h(!0),C(T,null,B(e.value,r=>(h(),O($,{key:r.value,value:r.value},{default:s(()=>[v(U(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(b,null,{default:s(()=>[l(R,null,{default:s(()=>[l(w,{type:"primary",onClick:u},{default:s(()=>t[3]||(t[3]=[v("查询")])),_:1}),l(w,{onClick:x},{default:s(()=>t[4]||(t[4]=[v("重置")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),y("div",pe,[l(R,null,{default:s(()=>[l(w,{onClick:q},{icon:s(()=>[l(D(ne))]),default:s(()=>[t[5]||(t[5]=v(" 导出 "))]),_:1}),l(w,{type:"primary",onClick:M},{icon:s(()=>[l(D(se))]),default:s(()=>[t[6]||(t[6]=v(" 新建任务 "))]),_:1})]),_:1})])]),l(Q,{columns:d,"data-source":c.value,loading:k.value,pagination:i,onChange:I},{bodyCell:s(({column:r,record:N})=>[r.key==="taskStatus"?(h(),C(T,{key:0},[v(U(D(p).getEnumText("TaskStatus",N.taskStatus)),1)],64)):F("",!0),r.key==="action"?(h(),O(R,{key:1},{default:s(()=>[y("a",{onClick:W=>z(N)},"编辑",8,fe),l(K,{title:"确定要删除该任务吗？",onConfirm:W=>V(N)},{default:s(()=>t[7]||(t[7]=[y("a",{class:"danger"},"删除",-1)])),_:2},1032,["onConfirm"])]),_:2},1024)):F("",!0)]),_:1},8,["data-source","loading","pagination"])])])}}},he=Y(_e,[["__scopeId","data-v-37f556f8"]]);export{he as default};
