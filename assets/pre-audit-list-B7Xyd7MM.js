import{_ as ge,a as he,b as _e,j as H,r as g,c as V,k as ye,d as h,e as k,f as l,w as s,g as u,l as R,m as v,h as Te,o,F as y,n as N,p as f,i as m,t as i,s as b,q as we,M as Se,A as F}from"./index-CM_LUiVE.js";import{d as Ae}from"./download-DgaUep0p.js";import{G as Ce}from"./GroupOwner-CeMIcTxz.js";const Ie={class:"task-audit content-container"},$e={class:"table-container"},Pe={class:"table-header"},Re={style:{width:"100%",display:"flex","justify-content":"space-between"}},Ne=["onClick"],je={class:"danger"},Oe={__name:"pre-audit-list",setup(We){const j=he(),{t:r}=_e(),G=H(()=>j.loaded?j.getEnumOptions("TaskPreAuditStatus"):[]),M=Te(),O=g(!1),A=g(!1),U=g(!1),T=g(""),p=g([]),n=V({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),Y=g([]),B=g([]),W=g([]),q=H(()=>[{title:r("submittedTasks.list.taskName"),key:"taskName"},{title:r("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:r("submittedTasks.list.memberInfo"),key:"member"},{title:r("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:r("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:r("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),C=g([]),w=V({current:1,pageSize:10,total:0}),K={selectedRowKeys:p,onChange:e=>{p.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},L=()=>{w.current=1,D()},J=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),L()},Q=e=>{Object.assign(w,e),D()},X=e=>{M.push(`/member/view/${e.memberId}`)},Z=e=>{M.push(`/submitted-tasks/detail/${e.id}?type=pre`)},ee=async e=>{p.value=[e.id],x()},x=async()=>{if(!p.value.length){v.warning(r("submittedTasks.list.selectTask"));return}const e=await F("taskSubmitted.batchPreAuditApprove",{ids:p.value});e.code===0?(v.success(r("submittedTasks.resolveSuccess")),C.value.forEach(a=>{p.value.includes(a.id)&&(a.taskPreAuditStatus="approved")}),p.value=[]):v.error(e.message)},te=e=>{p.value=[e.id],T.value="",A.value=!0},ae=async()=>{if(!T.value){v.error(r("submittedTasks.rejectReasonRequired"));return}U.value=!0;const e=await F("taskSubmitted.batchPreAuditReject",{ids:p.value,reason:T.value});e.code===0?(v.success(r("submittedTasks.rejectSuccess")),A.value=!1,C.value.forEach(a=>{p.value.includes(a.id)&&(a.taskPreAuditStatus="rejected")}),p.value=[]):v.error(e.message)},se=()=>{if(!p.value.length){v.warning(r("submittedTasks.list.selectTask"));return}T.value="",A.value=!0},ne=async()=>{const e=await R("channel.list");e.code===0&&(Y.value=e.data.list)},le=()=>{Se.confirm({title:r("common.export"),content:r("common.confirmExportContent"),onOk:async()=>{var e,a;try{const _=v.loading(r("common.exporting"),0),d={taskName:n.taskName,channelId:n.channelId,taskPreAuditStatus:n.taskPreAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=n.submitTimeRange)==null?void 0:a[1],completedTaskCount:n.completedTaskCount};await Ae("taskSubmitted.preAuditExport",d,`初审列表_${new Date().toLocaleDateString()}.xlsx`),_(),v.success(r("common.exportSuccess"))}catch(_){console.error("导出失败:",_),v.error(r("common.exportFailed"))}}})},oe=async(e="")=>{try{const a=await R("group.list",{params:{page:1,pageSize:50,keyword:e}});a.code===0&&(B.value=a.data.list||[])}catch{v.error("获取群组列表失败")}},D=async()=>{var e,a;O.value=!0;try{const _={page:w.current,pageSize:w.pageSize,taskName:n.taskName,channelId:n.channelId,taskPreAuditStatus:n.taskPreAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(a=n.submitTimeRange)==null?void 0:a[1],completedTaskCount:n.completedTaskCount},d=await R("taskSubmitted.preAuditList",{..._});d.code===0?(C.value=d.data.list,w.total=d.data.total):v.error(d.message)}finally{O.value=!1}},ue=async()=>{if(W.value.length)return;const e=await R("waiter.list",{page:1,pageSize:100});if(e.code===0){const a={id:0,username:"无"};W.value=[a,...e.data.list]}};return ye(()=>{D(),oe(),ne(),ue()}),(e,a)=>{const _=u("a-input"),d=u("a-form-item"),$=u("a-select-option"),P=u("a-select"),ie=u("a-range-picker"),re=u("a-input-number"),de=u("a-form"),I=u("a-button"),S=u("a-space"),ce=u("DownloadOutlined"),me=u("a-avatar"),pe=u("a-typography-link"),ke=u("a-tag"),z=u("a-popconfirm"),ve=u("a-table"),fe=u("a-textarea"),be=u("a-modal");return o(),h("div",Ie,[k("div",$e,[k("div",Pe,[l(de,{layout:"inline",model:n},{default:s(()=>[l(d,{label:e.$t("submittedTasks.search.taskName")},{default:s(()=>[l(_,{value:n.taskName,"onUpdate:value":a[0]||(a[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.channel")},{default:s(()=>[l(P,{value:n.channelId,"onUpdate:value":a[1]||(a[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(o(!0),h(y,null,N(Y.value,t=>(o(),f($,{key:t.id,value:t.id},{default:s(()=>[m(i(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.submitTime")},{default:s(()=>[l(ie,{value:n.submitTimeRange,"onUpdate:value":a[2]||(a[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:s(()=>[l(P,{value:n.taskPreAuditStatus,"onUpdate:value":a[3]||(a[3]=t=>n.taskPreAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:s(()=>[(o(!0),h(y,null,N(G.value,t=>(o(),f($,{key:t.value,value:t.value},{default:s(()=>[m(i(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.preAuditor")},{default:s(()=>[l(P,{value:n.preWaiterId,"onUpdate:value":a[4]||(a[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:s(()=>[(o(!0),h(y,null,N(W.value,t=>(o(),f($,{key:t.id,value:t.id},{default:s(()=>[m(i(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.groupId")},{default:s(()=>[l(P,{value:n.groupId,"onUpdate:value":a[5]||(a[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":""},{default:s(()=>[(o(!0),h(y,null,N(B.value,t=>(o(),f($,{key:t.id,value:t.id},{default:s(()=>[m(i(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(d,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:s(()=>[l(re,{value:n.completedTaskCount,"onUpdate:value":a[6]||(a[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"])]),_:1},8,["model"]),k("div",Re,[k("div",null,[l(S,null,{default:s(()=>[l(I,{type:"primary",onClick:L},{default:s(()=>[m(i(e.$t("common.search")),1)]),_:1}),l(I,{onClick:J},{default:s(()=>[m(i(e.$t("common.reset")),1)]),_:1})]),_:1})]),k("div",null,[l(S,null,{default:s(()=>[C.value.length?(o(),f(I,{key:0,onClick:le},{icon:s(()=>[l(ce)]),default:s(()=>[m(" "+i(e.$t("common.export")),1)]),_:1})):b("",!0),l(I,{type:"primary",onClick:x},{default:s(()=>[m(i(e.$t("common.batchResolve")),1)]),_:1}),l(I,{danger:"",onClick:se},{default:s(()=>[m(i(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(ve,{columns:q.value,"data-source":C.value,loading:O.value,pagination:w,"row-selection":K,rowKey:"id",onChange:Q},{bodyCell:s(({column:t,record:c})=>[t.key==="taskName"?(o(),f(S,{key:0},{default:s(()=>[l(me,{src:c.channelIcon,size:"small"},null,8,["src"]),k("span",null,i(c.taskName),1)]),_:2},1024)):b("",!0),t.key==="taskPreAuditStatus"?(o(),h(y,{key:1},[m(i(we(j).getEnumText("TaskPreAuditStatus",c.taskPreAuditStatus)),1)],64)):b("",!0),t.key==="preWaiterName"?(o(),h(y,{key:2},[m(i(c.preWaiterName||"--"),1)],64)):b("",!0),t.key==="member"?(o(),h(y,{key:3},[k("div",null,[l(S,null,{default:s(()=>[l(pe,{onClick:E=>X(c)},{default:s(()=>[m(i(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(o(),f(ke,{key:0,color:"green"},{default:s(()=>a[9]||(a[9]=[m("new")])),_:1})):b("",!0)]),_:2},1024)]),k("div",null,[l(S,{class:"group-name"},{default:s(()=>[k("span",null,i(c.groupName),1),c.isOwner?(o(),f(Ce,{key:0})):b("",!0)]),_:2},1024)])],64)):b("",!0),t.key==="action"?(o(),f(S,{key:4},{default:s(()=>[k("a",{onClick:E=>Z(c)},i(e.$t("submittedTasks.list.view")),9,Ne),c.taskPreAuditStatus==="pending"?(o(),f(z,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:E=>ee(c)},{default:s(()=>[k("a",null,i(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):b("",!0),c.taskPreAuditStatus==="pending"?(o(),f(z,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:E=>te(c)},{default:s(()=>[k("a",je,i(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):b("",!0)]),_:2},1024)):b("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),l(be,{open:A.value,"onUpdate:open":a[8]||(a[8]=t=>A.value=t),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:ae,confirmLoading:U.value},{default:s(()=>[l(fe,{value:T.value,"onUpdate:value":a[7]||(a[7]=t=>T.value=t),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},Ue=ge(Oe,[["__scopeId","data-v-72b6081d"]]);export{Ue as default};
