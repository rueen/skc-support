import{_ as Te,a as we,b as Se,j as K,r as v,c as q,k as Ce,d as g,e as k,f as n,w as a,g as i,l as j,m as f,h as Ae,o,F as h,n as x,p as b,i as d,t as u,s as _,q as Ie,M as Ne,A as J}from"./index-CM_LUiVE.js";import{d as $e}from"./download-DgaUep0p.js";import{G as Re}from"./GroupOwner-CeMIcTxz.js";const Oe={class:"task-audit content-container"},je={class:"table-container"},xe={class:"table-header"},De={style:{width:"100%",display:"flex","justify-content":"space-between"}},We=["onClick"],Ee={__name:"confirm-audit-list",setup(Ue){const D=we(),{t:c}=Se(),Q=K(()=>D.loaded?D.getEnumOptions("TaskAuditStatus"):[]),B=Ae(),W=v(!1),L=v(!1),C=v(!1),E=v(!1),T=v(""),A=v(null),p=v([]),U=v([]),l=q({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),V=v([]),z=v([]),X=K(()=>[{title:c("submittedTasks.list.taskName"),key:"taskName"},{title:c("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:c("submittedTasks.list.memberInfo"),key:"member"},{title:c("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:c("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:c("submittedTasks.list.confirmAuditor"),key:"waiterName"},{title:c("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),I=v([]),w=q({current:1,pageSize:10,total:0}),Z={selectedRowKeys:p,onChange:t=>{p.value=t},getCheckboxProps:t=>({disabled:t.taskAuditStatus!=="pending"})},H=()=>{w.current=1,M()},ee=()=>{Object.assign(l,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0}),H()},te=t=>{Object.assign(w,t),M()},ae=t=>{B.push(`/member/view/${t.memberId}`)},se=t=>{B.push(`/submitted-tasks/detail/${t.id}?type=confirm`)},ne=async t=>{p.value=[t.id],P()},P=async()=>{if(!p.value.length){f.warning(c("submittedTasks.list.selectTask"));return}const t=await J("taskSubmitted.batchConfirmAuditApprove",{ids:p.value});t.code===0?(f.success(c("submittedTasks.resolveSuccess")),I.value.forEach(s=>{p.value.includes(s.id)&&(s.taskAuditStatus="approved")}),p.value=[]):f.error(t.message)},le=t=>{p.value=[t.id],T.value="",C.value=!0},oe=async()=>{if(!T.value){f.error("请输入拒绝原因");return}E.value=!0;try{await J("taskSubmitted.batchConfirmAuditReject",{ids:p.value,reason:T.value}),f.success("审核拒绝成功"),C.value=!1,I.value.forEach(t=>{p.value.includes(t.id)&&(t.taskAuditStatus="rejected")}),p.value=[]}catch(t){f.error(t.message)}finally{E.value=!1}},ue=()=>{if(!p.value.length){f.warning("请选择要拒绝的任务");return}T.value="",C.value=!0},ie=async()=>{const t=await j("channel.list");t.code===0&&(V.value=t.data.list)},de=()=>{Ne.confirm({title:c("common.export"),content:c("common.confirmExportContent"),onOk:async()=>{var t,s;try{const y=f.loading(c("common.exporting"),0),m={taskName:l.taskName,channelId:l.channelId,taskAuditStatus:l.taskAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(t=l.submitTimeRange)==null?void 0:t[0],submitEndTime:(s=l.submitTimeRange)==null?void 0:s[1],completedTaskCount:l.completedTaskCount};await $e("taskSubmitted.confirmAuditExport",m,`复审列表_${new Date().toLocaleDateString()}.xlsx`),y(),f.success(c("common.exportSuccess"))}catch(y){console.error("导出失败:",y),f.error(c("common.exportFailed"))}}})},re=async(t="")=>{try{const s=await j("group.list",{params:{page:1,pageSize:50,keyword:t}});s.code===0&&(z.value=s.data.list||[])}catch{f.error("获取群组列表失败")}},M=async()=>{var t,s;W.value=!0;try{const y={page:w.current,pageSize:w.pageSize,taskName:l.taskName,channelId:l.channelId,taskAuditStatus:l.taskAuditStatus,preWaiterId:l.preWaiterId,groupId:l.groupId,submitStartTime:(t=l.submitTimeRange)==null?void 0:t[0],submitEndTime:(s=l.submitTimeRange)==null?void 0:s[1],completedTaskCount:l.completedTaskCount},m=await j("taskSubmitted.confirmAuditList",{...y});m.code===0?(I.value=m.data.list,w.total=m.data.total):f.error(m.message)}finally{W.value=!1}},ce=async()=>{if(U.value.length)return;const t=await j("waiter.list",{page:1,pageSize:100});t.code===0&&(U.value=t.data.list||[])};return Ce(()=>{M(),re(),ie(),ce()}),(t,s)=>{const y=i("a-input"),m=i("a-form-item"),R=i("a-select-option"),O=i("a-select"),me=i("a-range-picker"),pe=i("a-input-number"),ke=i("a-form"),N=i("a-button"),S=i("a-space"),fe=i("DownloadOutlined"),ve=i("a-avatar"),be=i("a-typography-link"),_e=i("a-tag"),F=i("a-popconfirm"),ge=i("a-table"),$=i("a-descriptions-item"),he=i("a-descriptions"),G=i("a-modal"),ye=i("a-textarea");return o(),g("div",Oe,[k("div",je,[k("div",xe,[n(ke,{layout:"inline",model:l},{default:a(()=>[n(m,{label:t.$t("submittedTasks.search.taskName")},{default:a(()=>[n(y,{value:l.taskName,"onUpdate:value":s[0]||(s[0]=e=>l.taskName=e),placeholder:t.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.channel")},{default:a(()=>[n(O,{value:l.channelId,"onUpdate:value":s[1]||(s[1]=e=>l.channelId=e),placeholder:t.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(o(!0),g(h,null,x(V.value,e=>(o(),b(R,{key:e.id,value:e.id},{default:a(()=>[d(u(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.submitTime")},{default:a(()=>[n(me,{value:l.submitTimeRange,"onUpdate:value":s[2]||(s[2]=e=>l.submitTimeRange=e),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[n(O,{value:l.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=e=>l.taskAuditStatus=e),placeholder:t.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(o(!0),g(h,null,x(Q.value,e=>(o(),b(R,{key:e.value,value:e.value},{default:a(()=>[d(u(e.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.preAuditor")},{default:a(()=>[n(O,{value:l.preWaiterId,"onUpdate:value":s[4]||(s[4]=e=>l.preWaiterId=e),placeholder:t.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:a(()=>[(o(!0),g(h,null,x(U.value,e=>(o(),b(R,{key:e.id,value:e.id},{default:a(()=>[d(u(e.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.groupId")},{default:a(()=>[n(O,{value:l.groupId,"onUpdate:value":s[5]||(s[5]=e=>l.groupId=e),placeholder:t.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":""},{default:a(()=>[(o(!0),g(h,null,x(z.value,e=>(o(),b(R,{key:e.id,value:e.id},{default:a(()=>[d(u(e.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(m,{label:t.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[n(pe,{value:l.completedTaskCount,"onUpdate:value":s[6]||(s[6]=e=>l.completedTaskCount=e),min:0,max:9999,"addon-after":t.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"])]),_:1},8,["model"]),k("div",De,[k("div",null,[n(S,null,{default:a(()=>[n(N,{type:"primary",onClick:H},{default:a(()=>[d(u(t.$t("common.search")),1)]),_:1}),n(N,{onClick:ee},{default:a(()=>[d(u(t.$t("common.reset")),1)]),_:1})]),_:1})]),k("div",null,[n(S,null,{default:a(()=>[I.value.length?(o(),b(N,{key:0,onClick:de},{icon:a(()=>[n(fe)]),default:a(()=>[d(" "+u(t.$t("common.export")),1)]),_:1})):_("",!0),n(N,{type:"primary",onClick:P},{default:a(()=>[d(u(t.$t("common.batchResolve")),1)]),_:1}),n(N,{danger:"",onClick:ue},{default:a(()=>[d(u(t.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(ge,{columns:X.value,"data-source":I.value,loading:W.value,pagination:w,"row-selection":Z,rowKey:"id",onChange:te},{bodyCell:a(({column:e,record:r})=>[e.key==="taskName"?(o(),b(S,{key:0},{default:a(()=>[n(ve,{src:r.channelIcon,size:"small"},null,8,["src"]),k("span",null,u(r.taskName),1)]),_:2},1024)):_("",!0),e.key==="taskAuditStatus"?(o(),g(h,{key:1},[d(u(Ie(D).getEnumText("TaskAuditStatus",r.taskAuditStatus)),1)],64)):_("",!0),e.key==="preWaiterName"?(o(),g(h,{key:2},[d(u(r.preWaiterName||"--"),1)],64)):_("",!0),e.key==="waiterName"?(o(),g(h,{key:3},[d(u(r.waiterName||"--"),1)],64)):_("",!0),e.key==="member"?(o(),g(h,{key:4},[k("div",null,[n(S,null,{default:a(()=>[n(be,{onClick:Y=>ae(r)},{default:a(()=>[d(u(r.nickname),1)]),_:2},1032,["onClick"]),r.isNew?(o(),b(_e,{key:0,color:"green"},{default:a(()=>s[10]||(s[10]=[d("new")])),_:1})):_("",!0)]),_:2},1024)]),k("div",null,[n(S,{class:"group-name"},{default:a(()=>[k("span",null,u(r.groupName),1),r.isOwner?(o(),b(Re,{key:0})):_("",!0)]),_:2},1024)])],64)):_("",!0),e.key==="action"?(o(),b(S,{key:5},{default:a(()=>[k("a",{onClick:Y=>se(r)},"查看",8,We),r.taskAuditStatus==="pending"?(o(),b(F,{key:0,title:"确定要通过该任务吗？",onConfirm:Y=>ne(r)},{default:a(()=>s[11]||(s[11]=[k("a",null,"通过",-1)])),_:2},1032,["onConfirm"])):_("",!0),r.taskAuditStatus==="pending"?(o(),b(F,{key:1,title:"确定要拒绝该任务吗？",onConfirm:Y=>le(r)},{default:a(()=>s[12]||(s[12]=[k("a",{class:"danger"},"拒绝",-1)])),_:2},1032,["onConfirm"])):_("",!0)]),_:2},1024)):_("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),n(G,{open:L.value,"onUpdate:open":s[7]||(s[7]=e=>L.value=e),title:"任务详情",footer:null},{default:a(()=>[n(he,{column:1},{default:a(()=>[n($,{label:"任务名称"},{default:a(()=>{var e;return[d(u((e=A.value)==null?void 0:e.taskName),1)]}),_:1}),n($,{label:"任务类型"},{default:a(()=>{var e;return[d(u((e=A.value)==null?void 0:e.taskType),1)]}),_:1}),n($,{label:"任务描述"},{default:a(()=>{var e;return[d(u((e=A.value)==null?void 0:e.description),1)]}),_:1}),n($,{label:"任务奖励"},{default:a(()=>{var e;return[d(u((e=A.value)==null?void 0:e.reward),1)]}),_:1}),n($,{label:"创建时间"},{default:a(()=>{var e;return[d(u((e=A.value)==null?void 0:e.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),n(G,{open:C.value,"onUpdate:open":s[9]||(s[9]=e=>C.value=e),title:"拒绝原因",onOk:oe,confirmLoading:E.value},{default:a(()=>[n(ye,{value:T.value,"onUpdate:value":s[8]||(s[8]=e=>T.value=e),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Le=Te(Ee,[["__scopeId","data-v-5bb09d4e"]]);export{Le as default};
