import{_ as le,a as ne,b as oe,r as f,c as H,j as q,B as te,k as re,q as O,o as m,w as s,e as C,f as t,g as n,d as z,p as se,F as M,i as g,t as c,v as E,s as ie,l as J,m as h,n as ce,h as de,z as me,A as pe}from"./index-D-6dhutF.js";import{P as ke}from"./PageHeader-_I5KT-O-.js";const fe={class:"select-task-modal"},ve={class:"filter-form"},_e={class:"selected-info"},he={key:1},ge={__name:"SelectTask",props:{visible:{type:Boolean,default:!1},selectedId:{type:Array,default:()=>[]}},emits:["update:visible","confirm","cancel"],setup(Q,{emit:d}){const $=ne(),{t:b}=oe(),p=Q,N=d,S=f(!1),D=f(!1),o=f([]),i=H({taskName:"",channelId:void 0,taskStatus:void 0}),I=f([]),W=q(()=>$.loaded?$.getEnumOptions("TaskStatus"):[]),v=q(()=>[{title:b("task.list.name"),key:"taskName",width:200},{title:b("task.list.status"),key:"taskStatus",width:100},{title:b("task.list.startTime"),dataIndex:"startTime",key:"startTime",sorter:!0},{title:b("task.list.endTime"),dataIndex:"endTime",key:"endTime",sorter:!0}]),F=f([]),y=H({current:1,pageSize:10,total:0}),V=H({sorterField:void 0,sorterOrder:void 0}),j=q(()=>({selectedRowKeys:o.value,onChange:(a,u)=>{X(a)},getCheckboxProps:a=>({disabled:!1})})),X=(a,u)=>{const T=F.value.map(w=>w.id),_=o.value.filter(w=>!T.includes(w));o.value=[..._,...a]},L=()=>{y.current=1,G()},Y=()=>{i.taskName="",i.channelId=void 0,i.taskStatus=void 0,L()},R=(a,u,T)=>{Object.assign(y,a),Object.assign(V,{sorterField:T.field,sorterOrder:T.order}),G()},Z=()=>{N("confirm",{taskIds:o.value}),x()},x=()=>{N("update:visible",!1),N("cancel")},G=async()=>{S.value=!0;try{const a=await J("task.list",{page:y.current,pageSize:y.pageSize,...V,...i});a.code===0?(F.value=a.data.list,y.total=a.data.total):h.error(a.message)}finally{S.value=!1}},e=async()=>{const a=await J("channel.list");a.code===0&&(I.value=a.data.list)},l=()=>{p.selectedId&&p.selectedId.length>0&&(o.value=[...p.selectedId])};return te(()=>p.visible,a=>{a?(G(),I.value.length||e(),l()):(o.value=[],y.current=1)}),te(()=>p.selectedId,()=>{p.visible&&l()},{deep:!0}),re(()=>{p.visible&&(G(),e(),l())}),(a,u)=>{const T=n("a-input"),_=n("a-form-item"),w=n("a-select-option"),B=n("a-select"),A=n("a-button"),K=n("a-space"),ee=n("a-form"),k=n("a-alert"),P=n("a-avatar"),ae=n("a-table"),ue=n("a-modal");return m(),O(ue,{open:Q.visible,title:a.$t("task.selectTask.title"),width:900,"confirm-loading":D.value,onOk:Z,onCancel:x},{default:s(()=>[C("div",fe,[C("div",ve,[t(ee,{layout:"inline",model:i},{default:s(()=>[t(_,{label:a.$t("task.search.taskName")},{default:s(()=>[t(T,{value:i.taskName,"onUpdate:value":u[0]||(u[0]=r=>i.taskName=r),placeholder:a.$t("common.inputPlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),t(_,{label:a.$t("task.search.channelId")},{default:s(()=>[t(B,{value:i.channelId,"onUpdate:value":u[1]||(u[1]=r=>i.channelId=r),placeholder:a.$t("common.selectPlaceholder"),style:{width:"120px"},"allow-clear":""},{default:s(()=>[(m(!0),z(M,null,se(I.value,r=>(m(),O(w,{key:r.id,value:r.id},{default:s(()=>[g(c(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),t(_,{label:a.$t("task.search.taskStatus")},{default:s(()=>[t(B,{value:i.taskStatus,"onUpdate:value":u[2]||(u[2]=r=>i.taskStatus=r),placeholder:a.$t("common.selectPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:s(()=>[(m(!0),z(M,null,se(W.value,r=>(m(),O(w,{key:r.value,value:r.value},{default:s(()=>[g(c(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),t(_,null,{default:s(()=>[t(K,null,{default:s(()=>[t(A,{type:"primary",onClick:L},{default:s(()=>[g(c(a.$t("common.search")),1)]),_:1}),t(A,{onClick:Y},{default:s(()=>[g(c(a.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),C("div",_e,[t(k,{message:a.$t("task.selectTask.selectedCount",{count:o.value.length}),type:"info","show-icon":""},null,8,["message"])]),t(ae,{columns:v.value,"data-source":F.value,loading:S.value,pagination:y,"row-selection":j.value,rowKey:"id",onChange:R,size:"middle"},{bodyCell:s(({column:r,record:U})=>[r.key==="taskName"?(m(),O(K,{key:0},{default:s(()=>[t(P,{src:U.channelIcon,size:"small"},null,8,["src"]),C("span",null,c(U.taskName),1)]),_:2},1024)):E("",!0),r.key==="taskTime"?(m(),z("div",he,c(U.startTime)+" - "+c(U.endTime),1)):E("",!0),r.key==="taskStatus"?(m(),z(M,{key:2},[g(c(ie($).getEnumText("TaskStatus",U.taskStatus)),1)],64)):E("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection"])])]),_:1},8,["open","title","confirm-loading"])}}},ye=le(ge,[["__scopeId","data-v-16074623"]]),be={class:"task-form content-container"},Te={class:"danger"},we={__name:"detail",setup(Q){const{t:d}=oe(),$=ne(),b=ce(),p=de(),N=f(),S=q(()=>b.name==="TaskGroupEdit"),D=f(!1),o=f([]),i=f([]),I=f(!1),W=q(()=>[{title:"index",key:"index",width:60,customRender:({index:e})=>e+1},{title:d("task.list.name"),key:"taskName"},{title:d("task.list.status"),dataIndex:"taskStatus",key:"taskStatus",customRender:({text:e})=>$.getEnumText("TaskStatus",e)},{title:d("task.list.startTime"),dataIndex:"startTime",key:"startTime"},{title:d("task.list.endTime"),dataIndex:"endTime",key:"endTime"},{title:d("task.list.action"),key:"action",fixed:"right",width:180}]),v=H({taskGroupName:"",taskGroupReward:0}),F={taskGroupName:[{required:!0,message:d("task.group.validation.taskGroupNameRequired")}],taskGroupReward:[{required:!0,message:d("task.group.validation.taskGroupRewardRequired")}]},y=()=>{D.value=!0},V=({taskIds:e})=>{o.value=e,j()},j=async()=>{if(!(!o.value||!o.value.length))try{I.value=!0;const e=await J("task.list",{page:1,pageSize:100,sorterField:"startTime",sorterOrder:"ascend",taskIds:o.value});e.code===0?i.value=e.data.list:h.error(e.message)}catch(e){h.error(e)}finally{I.value=!1}},X=e=>{i.value=i.value.filter(l=>l.id!==e.id),o.value=o.value.filter(l=>l!==e.id)},L=async()=>{try{R.value=!0;const e={...v,relatedTasks:o.value},l=await pe("taskGroup.add",e);l.code===0?(h.success(d("common.submitSuccess")),p.back()):h.error(l.message)}catch{h.error(d("common.submitFailed"))}finally{R.value=!1}},Y=async()=>{try{R.value=!0;const e={...v},l=await me("taskGroup.edit",{...e,relatedTasks:o.value},{urlParams:{id:b.params.id}});l.code===0?(h.success(d("common.submitSuccess")),p.back()):h.error(l.message)}catch{h.error(d("common.submitFailed"))}finally{R.value=!1}},R=f(!1),Z=()=>{N.value.validate().then(async()=>{S.value?await Y():await L()})},x=()=>{p.back()},G=async e=>{try{const l=await J("taskGroup.detail",{},{urlParams:{id:e}});if(l.code===0){const a=l.data;Object.assign(v,{taskGroupName:a.taskGroupName,taskGroupReward:a.taskGroupReward}),o.value=a.relatedTasks,j()}}catch(l){h.error(l)}};return re(()=>{S.value&&G(b.params.id)}),(e,l)=>{const a=n("a-input"),u=n("a-form-item"),T=n("a-input-number"),_=n("a-button"),w=n("a-avatar"),B=n("a-space"),A=n("a-popconfirm"),K=n("a-table"),ee=n("a-form");return m(),z("div",be,[t(ke,{title:S.value?e.$t("task.group.editTitle"):e.$t("task.group.createTitle"),back:!0,class:"page-header"},null,8,["title"]),C("div",null,[t(ee,{ref_key:"formRef",ref:N,model:v,rules:F,"label-col":{span:3},"wrapper-col":{span:19},layout:"horizontal"},{default:s(()=>[t(u,{label:e.$t("task.group.name")},{default:s(()=>[t(a,{value:v.taskGroupName,"onUpdate:value":l[0]||(l[0]=k=>v.taskGroupName=k),placeholder:e.$t("common.inputPlaceholder"),style:{width:"300px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),t(u,{label:e.$t("task.group.reward")},{default:s(()=>[t(T,{value:v.taskGroupReward,"onUpdate:value":l[1]||(l[1]=k=>v.taskGroupReward=k),min:0,precision:2,step:1,placeholder:e.$t("common.inputPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(u,{label:e.$t("task.group.relatedTask")},{default:s(()=>[C("div",null,[t(_,{type:"primary",onClick:y},{default:s(()=>[g(c(e.$t("task.group.selectTaskBtnText",{count:o.value.length})),1)]),_:1}),t(K,{columns:W.value,"data-source":i.value,loading:I.value,pagination:!1,style:{"margin-top":"10px"}},{bodyCell:s(({column:k,record:P})=>[k.key==="taskName"?(m(),O(B,{key:0},{default:s(()=>[t(w,{src:P.channelIcon},null,8,["src"]),g(" "+c(P.taskName),1)]),_:2},1024)):E("",!0),k.key==="taskStatus"?(m(),z(M,{key:1},[g(c(ie($).getEnumText("TaskStatus",P.taskStatus)),1)],64)):E("",!0),k.key==="action"?(m(),O(A,{key:2,title:e.$t("common.deleteConfirm"),onConfirm:ae=>X(P)},{default:s(()=>[C("a",Te,c(e.$t("common.delete")),1)]),_:2},1032,["title","onConfirm"])):E("",!0)]),_:1},8,["columns","data-source","loading"])])]),_:1},8,["label"]),t(u,{"wrapper-col":{span:16,offset:3}},{default:s(()=>[t(B,null,{default:s(()=>[t(_,{type:"primary",onClick:Z},{default:s(()=>[g(c(e.$t("common.submit")),1)]),_:1}),t(_,{onClick:x},{default:s(()=>[g(c(e.$t("common.cancel")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),t(ye,{visible:D.value,"onUpdate:visible":l[2]||(l[2]=k=>D.value=k),selectedId:o.value,onConfirm:V},null,8,["visible","selectedId"])])}}},Ce=le(we,[["__scopeId","data-v-b8187e07"]]);export{Ce as default};
