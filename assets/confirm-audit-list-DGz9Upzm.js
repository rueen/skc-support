import{_ as Ce,a as $e,b as Ie,j as Z,r as p,c as ee,k as Ne,d as f,e as v,f as l,s as b,w as a,g as d,x as Re,h as Oe,l as E,m as h,o as u,F as _,n as O,p as g,i,t as o,q as je,M as De,A as te}from"./index-_KmhQP4-.js";import{d as Ee}from"./download-C8EdTole.js";import{d as We,e as Ue}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Fe}from"./GroupOwner-CG1DvtRA.js";const Me={class:"task-audit content-container"},Pe={class:"table-container"},Ye={class:"table-header"},Be={style:{width:"100%",display:"flex","justify-content":"space-between"}},Le=["onClick"],Ve={class:"danger"},xe={key:0,class:"count-container"},ze={__name:"confirm-audit-list",setup(He){const W=$e(),{t:m}=Ie(),ae=Z(()=>W.loaded?W.getEnumOptions("TaskAuditStatus"):[]),U=Oe(),F=Re(),M=p(!1),L=p(!1),$=p(!1),P=p(!1),S=p(""),I=p(null),k=p([]),Y=p([]),n=ee({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),V=p([]),x=p([]),se=Z(()=>[{title:m("submittedTasks.list.taskName"),key:"taskName"},{title:m("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:m("submittedTasks.list.memberInfo"),key:"member"},{title:m("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:m("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:m("submittedTasks.list.confirmAuditor"),key:"waiterName"},{title:m("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),N=p([]),z=p(0),w=ee({current:1,pageSize:10,total:0}),le={selectedRowKeys:k,onChange:e=>{k.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},H=p(null),ne=()=>{const e=F.query.filters;if(e){H.value=We(e),Object.assign(n,{taskAuditStatus:null},H.value);const s={...F.query};delete s.filters,U.replace({path:F.path,query:s})}},q=()=>{w.current=1,B()},oe=()=>{Object.assign(n,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),q()},ue=e=>{Object.assign(w,e),B()},ie=e=>{U.push(`/member/view/${e.memberId}`)},re=e=>{var y,r;const s=Ue({...n,submitStartTime:(y=n.submitTimeRange)==null?void 0:y[0],submitEndTime:(r=n.submitTimeRange)==null?void 0:r[1],submitTimeRange:void 0});U.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:s}})},de=async e=>{k.value=[e.id],G()},G=async()=>{if(!k.value.length){h.warning(m("submittedTasks.list.selectTask"));return}const e=await te("taskSubmitted.batchConfirmAuditApprove",{ids:k.value});e.code===0?(h.success(m("submittedTasks.resolveSuccess")),N.value.forEach(s=>{k.value.includes(s.id)&&(s.taskAuditStatus="approved")}),k.value=[]):h.error(e.message)},ce=e=>{k.value=[e.id],S.value="",$.value=!0},me=async()=>{if(!S.value){h.error("请输入拒绝原因");return}P.value=!0;try{await te("taskSubmitted.batchConfirmAuditReject",{ids:k.value,reason:S.value}),h.success("审核拒绝成功"),$.value=!1,N.value.forEach(e=>{k.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),k.value=[]}catch(e){h.error(e.message)}finally{P.value=!1}},pe=()=>{if(!k.value.length){h.warning("请选择要拒绝的任务");return}S.value="",$.value=!0},ke=async()=>{const e=await E("channel.list");e.code===0&&(V.value=e.data.list)},fe=()=>{De.confirm({title:m("common.export"),content:m("common.confirmExportContent"),onOk:async()=>{var e,s;try{const y=h.loading(m("common.exporting"),0),r={taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword};await Ee("taskSubmitted.confirmAuditExport",r,`复审列表_${new Date().toLocaleDateString()}.xlsx`),y(),h.success(m("common.exportSuccess"))}catch(y){console.error("导出失败:",y),h.error(m("common.exportFailed"))}}})},K=async(e="")=>{try{const s=await E("group.list",{page:1,pageSize:50,keyword:e});s.code===0&&(x.value=s.data.list||[])}catch{h.error("获取群组列表失败")}},B=async()=>{var e,s;M.value=!0;try{const y={page:w.current,pageSize:w.pageSize,taskName:n.taskName,channelId:n.channelId,taskAuditStatus:n.taskAuditStatus,preWaiterId:n.preWaiterId,groupId:n.groupId,submitStartTime:(e=n.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=n.submitTimeRange)==null?void 0:s[1],completedTaskCount:n.completedTaskCount,keyword:n.keyword},r=await E("taskSubmitted.confirmAuditList",{...y});r.code===0?(N.value=r.data.list,w.total=r.data.total,z.value=r.data.totalAmount):h.error(r.message)}finally{M.value=!1}},ve=async()=>{if(Y.value.length)return;const e=await E("waiter.list",{page:1,pageSize:100});e.code===0&&(Y.value=e.data.list||[])};return Ne(()=>{ne(),B(),K(),ke(),ve()}),(e,s)=>{const y=d("a-input"),r=d("a-form-item"),j=d("a-select-option"),D=d("a-select"),be=d("a-range-picker"),he=d("a-input-number"),ye=d("a-form"),R=d("a-button"),A=d("a-space"),ge=d("DownloadOutlined"),_e=d("a-avatar"),we=d("a-typography-link"),Te=d("a-tag"),J=d("a-popconfirm"),Se=d("a-table"),T=d("a-descriptions-item"),Q=d("a-descriptions"),X=d("a-modal"),Ae=d("a-textarea");return u(),f("div",Me,[v("div",Pe,[v("div",Ye,[l(ye,{layout:"inline",model:n},{default:a(()=>[l(r,{label:e.$t("submittedTasks.search.taskName")},{default:a(()=>[l(y,{value:n.taskName,"onUpdate:value":s[0]||(s[0]=t=>n.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.channel")},{default:a(()=>[l(D,{value:n.channelId,"onUpdate:value":s[1]||(s[1]=t=>n.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),f(_,null,O(V.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.submitTime")},{default:a(()=>[l(be,{value:n.submitTimeRange,"onUpdate:value":s[2]||(s[2]=t=>n.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[l(D,{value:n.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=t=>n.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:a(()=>[(u(!0),f(_,null,O(ae.value,t=>(u(),g(j,{key:t.value,value:t.value},{default:a(()=>[i(o(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.preAuditor")},{default:a(()=>[l(D,{value:n.preWaiterId,"onUpdate:value":s[4]||(s[4]=t=>n.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:a(()=>[(u(!0),f(_,null,O(Y.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.groupId")},{default:a(()=>[l(D,{value:n.groupId,"onUpdate:value":s[5]||(s[5]=t=>n.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),style:{width:"120px"},"allow-clear":"","show-search":"","filter-option":!1,onSearch:K},{default:a(()=>[(u(!0),f(_,null,O(x.value,t=>(u(),g(j,{key:t.id,value:t.id},{default:a(()=>[i(o(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(r,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[l(he,{value:n.completedTaskCount,"onUpdate:value":s[6]||(s[6]=t=>n.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),l(r,{label:e.$t("member.search.keyword")},{default:a(()=>[l(y,{value:n.keyword,"onUpdate:value":s[7]||(s[7]=t=>n.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),v("div",Be,[v("div",null,[l(A,null,{default:a(()=>[l(R,{type:"primary",onClick:q},{default:a(()=>[i(o(e.$t("common.search")),1)]),_:1}),l(R,{onClick:oe},{default:a(()=>[i(o(e.$t("common.reset")),1)]),_:1})]),_:1})]),v("div",null,[l(A,null,{default:a(()=>[N.value.length?(u(),g(R,{key:0,onClick:fe},{icon:a(()=>[l(ge)]),default:a(()=>[i(" "+o(e.$t("common.export")),1)]),_:1})):b("",!0),l(R,{type:"primary",onClick:G},{default:a(()=>[i(o(e.$t("common.batchResolve")),1)]),_:1}),l(R,{danger:"",onClick:pe},{default:a(()=>[i(o(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),l(Se,{columns:se.value,"data-source":N.value,loading:M.value,pagination:w,"row-selection":le,rowKey:"id",onChange:ue},{bodyCell:a(({column:t,record:c})=>[t.key==="taskName"?(u(),g(A,{key:0},{default:a(()=>[l(_e,{src:c.channelIcon,size:"small"},null,8,["src"]),v("span",null,o(c.taskName),1)]),_:2},1024)):b("",!0),t.key==="taskAuditStatus"?(u(),f(_,{key:1},[i(o(je(W).getEnumText("TaskAuditStatus",c.taskAuditStatus)),1)],64)):b("",!0),t.key==="preWaiterName"?(u(),f(_,{key:2},[i(o(c.preWaiterName||"--"),1)],64)):b("",!0),t.key==="waiterName"?(u(),f(_,{key:3},[i(o(c.waiterName||"--"),1)],64)):b("",!0),t.key==="member"?(u(),f(_,{key:4},[v("div",null,[l(A,null,{default:a(()=>[l(we,{onClick:C=>ie(c)},{default:a(()=>[i(o(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(u(),g(Te,{key:0,color:"green"},{default:a(()=>s[11]||(s[11]=[i("new")])),_:1})):b("",!0)]),_:2},1024)]),v("div",null,o(c.account),1),(u(!0),f(_,null,O(c.groups,C=>(u(),f("div",null,[l(A,null,{default:a(()=>[v("span",null,o(C.groupName),1),C.isOwner?(u(),g(Fe,{key:0})):b("",!0)]),_:2},1024)]))),256))],64)):b("",!0),t.key==="action"?(u(),g(A,{key:5},{default:a(()=>[v("a",{onClick:C=>re(c)},o(e.$t("submittedTasks.list.view")),9,Le),c.taskAuditStatus==="pending"?(u(),g(J,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:C=>de(c)},{default:a(()=>[v("a",null,o(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):b("",!0),c.taskAuditStatus==="pending"?(u(),g(J,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:C=>ce(c)},{default:a(()=>[v("a",Ve,o(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):b("",!0)]),_:2},1024)):b("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),w.total?(u(),f("div",xe,[l(Q,{column:2},{default:a(()=>[l(T,{label:e.$t("common.totalCount")},{default:a(()=>[i(o(w.total),1)]),_:1},8,["label"]),l(T,{label:e.$t("common.totalAmount")},{default:a(()=>[i(o(z.value),1)]),_:1},8,["label"])]),_:1})])):b("",!0)]),l(X,{open:L.value,"onUpdate:open":s[8]||(s[8]=t=>L.value=t),title:"任务详情",footer:null},{default:a(()=>[l(Q,{column:1},{default:a(()=>[l(T,{label:"任务名称"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.taskName),1)]}),_:1}),l(T,{label:"任务类型"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.taskType),1)]}),_:1}),l(T,{label:"任务描述"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.description),1)]}),_:1}),l(T,{label:"任务奖励"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.reward),1)]}),_:1}),l(T,{label:"创建时间"},{default:a(()=>{var t;return[i(o((t=I.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(X,{open:$.value,"onUpdate:open":s[10]||(s[10]=t=>$.value=t),title:"拒绝原因",onOk:me,confirmLoading:P.value},{default:a(()=>[l(Ae,{value:S.value,"onUpdate:value":s[9]||(s[9]=t=>S.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},Qe=Ce(ze,[["__scopeId","data-v-0df3bf42"]]);export{Qe as default};
