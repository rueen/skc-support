import{_ as Te,a as _e,b as we,j as V,r as h,c as x,k as Se,d as y,e as m,f as n,w as l,g as i,x as Ae,h as Pe,l as R,m as v,o,F as T,n as N,p as b,i as p,t as r,s as g,q as $e,M as Ce,A as G}from"./index-BsNCkEur.js";import{d as Ie}from"./download-CTrUe9dE.js";import{d as Re,e as Ne}from"./routeParamsEncryption-BKFTaOaF.js";import{G as je}from"./GroupOwner-CGVkAdYp.js";const Oe={class:"task-audit content-container"},We={class:"table-container"},De={class:"table-header"},Ee={style:{width:"100%",display:"flex","justify-content":"space-between"}},Ue=["onClick"],Fe={class:"danger"},Me={__name:"pre-audit-list",setup(Ye){const j=_e(),{t:d}=we(),K=V(()=>j.loaded?j.getEnumOptions("TaskPreAuditStatus"):[]),O=Ae(),W=Pe(),D=h(!1),A=h(!1),E=h(!1),_=h(""),k=h([]),Y=h(null),J=()=>{const e=O.query.filters;if(e){Y.value=Re(e),Object.assign(s,{taskPreAuditStatus:null},Y.value);const t={...O.query};delete t.filters,W.replace({path:O.path,query:t})}},s=x({taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),B=h([]),L=h([]),U=h([]),Q=V(()=>[{title:d("submittedTasks.list.taskName"),key:"taskName"},{title:d("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:d("submittedTasks.list.memberInfo"),key:"member"},{title:d("submittedTasks.list.status"),dataIndex:"taskPreAuditStatus",key:"taskPreAuditStatus"},{title:d("submittedTasks.list.preAuditor"),key:"preWaiterName"},{title:d("submittedTasks.list.action"),key:"action",fixed:"right",width:180}]),P=h([]),w=x({current:1,pageSize:10,total:0}),X={selectedRowKeys:k,onChange:e=>{k.value=e},getCheckboxProps:e=>({disabled:e.taskPreAuditStatus!=="pending"})},q=()=>{w.current=1,F()},Z=()=>{Object.assign(s,{taskName:"",channelId:void 0,taskPreAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:""}),q()},ee=e=>{Object.assign(w,e),F()},te=e=>{W.push(`/member/view/${e.memberId}`)},ae=e=>{var f,u;const t=Ne({...s,submitStartTime:(f=s.submitTimeRange)==null?void 0:f[0],submitEndTime:(u=s.submitTimeRange)==null?void 0:u[1],submitTimeRange:void 0});W.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"pre",filters:t}})},se=async e=>{k.value=[e.id],z()},z=async()=>{if(!k.value.length){v.warning(d("submittedTasks.list.selectTask"));return}const e=await G("taskSubmitted.batchPreAuditApprove",{ids:k.value});e.code===0?(v.success(d("submittedTasks.resolveSuccess")),P.value.forEach(t=>{k.value.includes(t.id)&&(t.taskPreAuditStatus="approved")}),k.value=[]):v.error(e.message)},le=e=>{k.value=[e.id],_.value="",A.value=!0},ne=async()=>{if(!_.value){v.error(d("submittedTasks.rejectReasonRequired"));return}E.value=!0;try{await G("taskSubmitted.batchPreAuditReject",{ids:k.value,reason:_.value}),v.success(d("submittedTasks.rejectSuccess")),A.value=!1,P.value.forEach(e=>{k.value.includes(e.id)&&(e.taskPreAuditStatus="rejected")}),k.value=[]}catch(e){v.error(e.message)}finally{E.value=!1}},oe=()=>{if(!k.value.length){v.warning(d("submittedTasks.list.selectTask"));return}_.value="",A.value=!0},ue=async()=>{const e=await R("channel.list");e.code===0&&(B.value=e.data.list)},re=()=>{Ce.confirm({title:d("common.export"),content:d("common.confirmExportContent"),onOk:async()=>{var e,t;try{const f=v.loading(d("common.exporting"),0),u={taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword};await Ie("taskSubmitted.preAuditExport",u,`初审列表_${new Date().toLocaleDateString()}.xlsx`),f(),v.success(d("common.exportSuccess"))}catch(f){console.error("导出失败:",f),v.error(d("common.exportFailed"))}}})},ie=async(e="")=>{try{const t=await R("group.list",{params:{page:1,pageSize:50,keyword:e}});t.code===0&&(L.value=t.data.list||[])}catch{v.error("获取群组列表失败")}},F=async()=>{var e,t;D.value=!0;try{const f={page:w.current,pageSize:w.pageSize,taskName:s.taskName,channelId:s.channelId,taskPreAuditStatus:s.taskPreAuditStatus,preWaiterId:s.preWaiterId,groupId:s.groupId,submitStartTime:(e=s.submitTimeRange)==null?void 0:e[0],submitEndTime:(t=s.submitTimeRange)==null?void 0:t[1],completedTaskCount:s.completedTaskCount,keyword:s.keyword},u=await R("taskSubmitted.preAuditList",{...f});u.code===0?(P.value=u.data.list,w.total=u.data.total):v.error(u.message)}finally{D.value=!1}},de=async()=>{if(U.value.length)return;const e=await R("waiter.list",{page:1,pageSize:100});if(e.code===0){const t={id:0,username:"无"};U.value=[t,...e.data.list]}};return Se(()=>{J(),F(),ie(),ue(),de()}),(e,t)=>{const f=i("a-input"),u=i("a-form-item"),C=i("a-select-option"),I=i("a-select"),ce=i("a-range-picker"),me=i("a-input-number"),pe=i("a-form"),$=i("a-button"),S=i("a-space"),ke=i("DownloadOutlined"),ve=i("a-avatar"),fe=i("a-typography-link"),be=i("a-tag"),H=i("a-popconfirm"),he=i("a-table"),ge=i("a-textarea"),ye=i("a-modal");return o(),y("div",Oe,[m("div",We,[m("div",De,[n(pe,{layout:"inline",model:s},{default:l(()=>[n(u,{label:e.$t("submittedTasks.search.taskName")},{default:l(()=>[n(f,{value:s.taskName,"onUpdate:value":t[0]||(t[0]=a=>s.taskName=a),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":"",style:{width:"140px"}},null,8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.channel")},{default:l(()=>[n(I,{value:s.channelId,"onUpdate:value":t[1]||(t[1]=a=>s.channelId=a),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),y(T,null,N(B.value,a=>(o(),b(C,{key:a.id,value:a.id},{default:l(()=>[p(r(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.submitTime")},{default:l(()=>[n(ce,{value:s.submitTimeRange,"onUpdate:value":t[2]||(t[2]=a=>s.submitTimeRange=a),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"280px"}},null,8,["value"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.taskPreAuditStatus")},{default:l(()=>[n(I,{value:s.taskPreAuditStatus,"onUpdate:value":t[3]||(t[3]=a=>s.taskPreAuditStatus=a),placeholder:e.$t("submittedTasks.search.taskPreAuditStatusPlaceholder"),"allow-clear":"",style:{width:"140px"}},{default:l(()=>[(o(!0),y(T,null,N(K.value,a=>(o(),b(C,{key:a.value,value:a.value},{default:l(()=>[p(r(a.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.preAuditor")},{default:l(()=>[n(I,{value:s.preWaiterId,"onUpdate:value":t[4]||(t[4]=a=>s.preWaiterId=a),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":"",style:{width:"120px"}},{default:l(()=>[(o(!0),y(T,null,N(U.value,a=>(o(),b(C,{key:a.id,value:a.id},{default:l(()=>[p(r(a.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.groupId")},{default:l(()=>[n(I,{value:s.groupId,"onUpdate:value":t[5]||(t[5]=a=>s.groupId=a),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":""},{default:l(()=>[(o(!0),y(T,null,N(L.value,a=>(o(),b(C,{key:a.id,value:a.id},{default:l(()=>[p(r(a.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),n(u,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:l(()=>[n(me,{value:s.completedTaskCount,"onUpdate:value":t[6]||(t[6]=a=>s.completedTaskCount=a),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times"),style:{width:"100px!important"}},null,8,["value","addon-after"])]),_:1},8,["label"]),n(u,{label:e.$t("member.search.keyword")},{default:l(()=>[n(f,{value:s.keyword,"onUpdate:value":t[7]||(t[7]=a=>s.keyword=a),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),m("div",Ee,[m("div",null,[n(S,null,{default:l(()=>[n($,{type:"primary",onClick:q},{default:l(()=>[p(r(e.$t("common.search")),1)]),_:1}),n($,{onClick:Z},{default:l(()=>[p(r(e.$t("common.reset")),1)]),_:1})]),_:1})]),m("div",null,[n(S,null,{default:l(()=>[P.value.length?(o(),b($,{key:0,onClick:re},{icon:l(()=>[n(ke)]),default:l(()=>[p(" "+r(e.$t("common.export")),1)]),_:1})):g("",!0),n($,{type:"primary",onClick:z},{default:l(()=>[p(r(e.$t("common.batchResolve")),1)]),_:1}),n($,{danger:"",onClick:oe},{default:l(()=>[p(r(e.$t("common.batchReject")),1)]),_:1})]),_:1})])])]),n(he,{columns:Q.value,"data-source":P.value,loading:D.value,pagination:w,"row-selection":X,rowKey:"id",onChange:ee},{bodyCell:l(({column:a,record:c})=>[a.key==="taskName"?(o(),b(S,{key:0},{default:l(()=>[n(ve,{src:c.channelIcon,size:"small"},null,8,["src"]),m("span",null,r(c.taskName),1)]),_:2},1024)):g("",!0),a.key==="taskPreAuditStatus"?(o(),y(T,{key:1},[p(r($e(j).getEnumText("TaskPreAuditStatus",c.taskPreAuditStatus)),1)],64)):g("",!0),a.key==="preWaiterName"?(o(),y(T,{key:2},[p(r(c.preWaiterName||"--"),1)],64)):g("",!0),a.key==="member"?(o(),y(T,{key:3},[m("div",null,[n(S,null,{default:l(()=>[n(fe,{onClick:M=>te(c)},{default:l(()=>[p(r(c.nickname),1)]),_:2},1032,["onClick"]),c.isNew?(o(),b(be,{key:0,color:"green"},{default:l(()=>t[10]||(t[10]=[p("new")])),_:1})):g("",!0)]),_:2},1024)]),m("div",null,r(c.account),1),m("div",null,[n(S,{class:"group-name"},{default:l(()=>[m("span",null,r(c.groupName),1),c.isOwner?(o(),b(je,{key:0})):g("",!0)]),_:2},1024)])],64)):g("",!0),a.key==="action"?(o(),b(S,{key:4},{default:l(()=>[m("a",{onClick:M=>ae(c)},r(e.$t("submittedTasks.list.view")),9,Ue),c.taskPreAuditStatus==="pending"?(o(),b(H,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:M=>se(c)},{default:l(()=>[m("a",null,r(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):g("",!0),c.taskPreAuditStatus==="pending"?(o(),b(H,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:M=>le(c)},{default:l(()=>[m("a",Fe,r(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):g("",!0)]),_:2},1024)):g("",!0)]),_:1},8,["columns","data-source","loading","pagination"])]),n(ye,{open:A.value,"onUpdate:open":t[9]||(t[9]=a=>A.value=a),title:e.$t("submittedTasks.rejectReasonTitle"),onOk:ne,confirmLoading:E.value},{default:l(()=>[n(ge,{value:_.value,"onUpdate:value":t[8]||(t[8]=a=>_.value=a),placeholder:e.$t("submittedTasks.rejectReasonPlaceholder"),rows:4},null,8,["value","placeholder"])]),_:1},8,["open","title","confirmLoading"])])}}},He=Te(Me,[["__scopeId","data-v-01afe339"]]);export{He as default};
