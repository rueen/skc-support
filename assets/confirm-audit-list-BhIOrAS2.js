import{_ as $e,a as Ne,c as Re,d as se,r as v,e as Y,o as Oe,f as k,g as _,h as l,x as f,w as a,i as c,z as je,j as Ge,p as D,q as g,k as u,F as y,m as $,n as b,l as r,t as n,v as De,M as Ee,C as le}from"./index-ZJN4DWfS.js";import{d as Ue}from"./download-C9R9QA1L.js";import{d as We,e as Fe}from"./routeParamsEncryption-BKFTaOaF.js";import{G as Me}from"./GroupOwner-D9pEOEKb.js";const Pe={class:"task-audit content-container"},ze={class:"table-container"},Ye={class:"table-header"},Be={class:"left"},Le={class:"right"},Ve=["onClick"],He={class:"danger"},qe={key:0,class:"count-container"},Ke={__name:"confirm-audit-list",setup(Je){const E=Ne(),{t:m}=Re(),oe=se(()=>E.loaded?E.getEnumOptions("TaskAuditStatus"):[]),U=Ge(),W=je(),F=v(!1),B=v(!1),N=v(!1),M=v(!1),S=v(""),R=v(null),h=v([]),P=v([]),o=Y({taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),L=v([]),V=v([]),ne=se(()=>[{title:m("submittedTasks.list.taskName"),key:"taskName"},{title:m("submittedTasks.list.reward"),dataIndex:"reward",key:"reward"},{title:m("submittedTasks.list.memberInfo"),key:"member"},{title:m("submittedTasks.list.status"),dataIndex:"taskAuditStatus",key:"taskAuditStatus"},{title:m("submittedTasks.rejectTimes"),dataIndex:"rejectTimes",key:"rejectTimes"},{title:m("submittedTasks.preAuditor"),key:"preWaiterName"},{title:m("submittedTasks.preAuditTime"),dataIndex:"preAuditTime",key:"preAuditTime",sorter:!0},{title:m("submittedTasks.confirmAuditor"),key:"waiterName"},{title:m("submittedTasks.confirmAuditTime"),dataIndex:"confirmAuditTime",key:"confirmAuditTime",sorter:!0},{title:m("submittedTasks.list.action"),key:"action"}]),O=v([]),H=v(0),T=Y({current:1,pageSize:10,total:0}),q=Y({sorterField:void 0,sorterOrder:void 0}),ue={selectedRowKeys:h,onChange:e=>{h.value=e},getCheckboxProps:e=>({disabled:e.taskAuditStatus!=="pending"})},re=()=>{const e=W.query.filters;if(e){const s={},p=We(e);Object.keys(p).forEach(w=>{w==="current"?T.current=p[w]:s[w]=p[w]}),Object.assign(o,{taskAuditStatus:null},s);const i={...W.query};delete i.filters,U.replace({path:W.path,query:i})}},K=()=>{T.current=1,z()},ie=()=>{Object.assign(o,{taskName:"",channelId:void 0,taskAuditStatus:"pending",preWaiterId:void 0,groupId:void 0,submitTimeRange:[],completedTaskCount:void 0,keyword:"",taskGroupId:void 0}),K()},de=(e,s,p)=>{Object.assign(T,e),Object.assign(q,{sorterField:p.field,sorterOrder:p.order}),z()},ce=e=>{U.push(`/member/view/${e.memberId}`)},me=e=>{const s=Fe({...o,current:T.current});U.push({path:`/submitted-tasks/detail/${e.id}`,query:{type:"confirm",filters:s}})},pe=async e=>{h.value=[e.id],J()},J=async()=>{if(!h.value.length){g.warning(m("submittedTasks.list.selectTask"));return}const e=await le("taskSubmitted.batchConfirmAuditApprove",{ids:h.value});e.code===0?(g.success(m("submittedTasks.resolveSuccess")),O.value.forEach(s=>{h.value.includes(s.id)&&(s.taskAuditStatus="approved")}),h.value=[]):g.error(e.message)},ke=e=>{h.value=[e.id],S.value="",N.value=!0},fe=async()=>{if(!S.value){g.error("请输入拒绝原因");return}M.value=!0;try{await le("taskSubmitted.batchConfirmAuditReject",{ids:h.value,reason:S.value}),g.success("审核拒绝成功"),N.value=!1,O.value.forEach(e=>{h.value.includes(e.id)&&(e.taskAuditStatus="rejected")}),h.value=[]}catch(e){g.error(e.message)}finally{M.value=!1}},ve=()=>{if(!h.value.length){g.warning("请选择要拒绝的任务");return}S.value="",N.value=!0},be=async()=>{const e=await D("channel.list");e.code===0&&(L.value=e.data.list)},he=()=>{Ee.confirm({title:m("common.export"),content:m("common.confirmExportContent"),onOk:async()=>{var e,s;try{const p=g.loading(m("common.exporting"),0),i={taskName:o.taskName,channelId:o.channelId,taskAuditStatus:o.taskAuditStatus,preWaiterId:o.preWaiterId,groupId:o.groupId,submitStartTime:(e=o.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=o.submitTimeRange)==null?void 0:s[1],completedTaskCount:o.completedTaskCount,keyword:o.keyword,taskGroupId:o.taskGroupId};await Ue("taskSubmitted.confirmAuditExport",i,`复审列表_${new Date().toLocaleDateString()}.xlsx`),p(),g.success(m("common.exportSuccess"))}catch(p){console.error("导出失败:",p),g.error(m("common.exportFailed"))}}})},Q=async(e="")=>{try{const s=await D("group.list",{page:1,pageSize:50,keyword:e});s.code===0&&(V.value=s.data.list||[])}catch{g.error("获取群组列表失败")}},z=async()=>{var e,s;F.value=!0;try{const p={page:T.current,pageSize:T.pageSize,taskName:o.taskName,channelId:o.channelId,taskAuditStatus:o.taskAuditStatus,preWaiterId:o.preWaiterId,groupId:o.groupId,submitStartTime:(e=o.submitTimeRange)==null?void 0:e[0],submitEndTime:(s=o.submitTimeRange)==null?void 0:s[1],completedTaskCount:o.completedTaskCount,keyword:o.keyword,taskGroupId:o.taskGroupId},i=await D("taskSubmitted.confirmAuditList",{...p,...q});i.code===0?(O.value=i.data.list,T.total=i.data.total,H.value=i.data.totalAmount):g.error(i.message)}finally{F.value=!1}},ge=async()=>{if(P.value.length)return;const e=await D("waiter.list",{page:1,pageSize:100});e.code===0&&(P.value=e.data.list||[])},X=v([]),Z=async(e="")=>{const s=await D("taskGroup.list",{page:1,pageSize:50,taskGroupName:e});s.code===0&&(X.value=s.data.list||[])};return Oe(()=>{re(),z(),Q(),be(),ge(),Z()}),(e,s)=>{const p=c("a-input"),i=c("a-form-item"),w=c("a-select-option"),j=c("a-select"),ye=c("a-range-picker"),_e=c("a-input-number"),G=c("a-button"),I=c("a-space"),Te=c("a-form"),we=c("DownloadOutlined"),Ae=c("a-avatar"),x=c("a-tag"),Se=c("a-typography-link"),ee=c("a-popconfirm"),Ie=c("a-table"),A=c("a-descriptions-item"),te=c("a-descriptions"),ae=c("a-modal"),Ce=c("a-textarea");return u(),k("div",Pe,[_("div",ze,[_("div",Ye,[_("div",Be,[l(Te,{layout:"inline",model:o},{default:a(()=>[l(i,{label:e.$t("submittedTasks.search.taskName")},{default:a(()=>[l(p,{value:o.taskName,"onUpdate:value":s[0]||(s[0]=t=>o.taskName=t),placeholder:e.$t("submittedTasks.search.taskNamePlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.channel")},{default:a(()=>[l(j,{value:o.channelId,"onUpdate:value":s[1]||(s[1]=t=>o.channelId=t),placeholder:e.$t("submittedTasks.search.channelPlaceholder"),"allow-clear":""},{default:a(()=>[(u(!0),k(y,null,$(L.value,t=>(u(),b(w,{key:t.id,value:t.id},{default:a(()=>[r(n(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.submitTime")},{default:a(()=>[l(ye,{value:o.submitTimeRange,"onUpdate:value":s[2]||(s[2]=t=>o.submitTimeRange=t),"show-time":{format:"HH:mm"},format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["value"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.taskAuditStatus")},{default:a(()=>[l(j,{value:o.taskAuditStatus,"onUpdate:value":s[3]||(s[3]=t=>o.taskAuditStatus=t),placeholder:e.$t("submittedTasks.search.taskAuditStatusPlaceholder"),"allow-clear":""},{default:a(()=>[(u(!0),k(y,null,$(oe.value,t=>(u(),b(w,{key:t.value,value:t.value},{default:a(()=>[r(n(t.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.preAuditor")},{default:a(()=>[l(j,{value:o.preWaiterId,"onUpdate:value":s[4]||(s[4]=t=>o.preWaiterId=t),placeholder:e.$t("submittedTasks.search.preAuditorPlaceholder"),"allow-clear":""},{default:a(()=>[(u(!0),k(y,null,$(P.value,t=>(u(),b(w,{key:t.id,value:t.id},{default:a(()=>[r(n(t.username),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.groupId")},{default:a(()=>[l(j,{value:o.groupId,"onUpdate:value":s[5]||(s[5]=t=>o.groupId=t),placeholder:e.$t("submittedTasks.search.groupIdPlaceholder"),"allow-clear":"","show-search":"","filter-option":!1,onSearch:Q},{default:a(()=>[(u(!0),k(y,null,$(V.value,t=>(u(),b(w,{key:t.id,value:t.id},{default:a(()=>[r(n(t.groupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("submittedTasks.search.completedTaskCount")},{default:a(()=>[l(_e,{value:o.completedTaskCount,"onUpdate:value":s[6]||(s[6]=t=>o.completedTaskCount=t),min:0,max:9999,"addon-after":e.$t("submittedTasks.search.times")},null,8,["value","addon-after"])]),_:1},8,["label"]),l(i,{label:e.$t("member.search.keyword")},{default:a(()=>[l(p,{value:o.keyword,"onUpdate:value":s[7]||(s[7]=t=>o.keyword=t),placeholder:e.$t("member.search.keywordPlaceholder"),"allow-clear":""},null,8,["value","placeholder"])]),_:1},8,["label"]),l(i,{label:e.$t("task.search.taskGroup")},{default:a(()=>[l(j,{value:o.taskGroupId,"onUpdate:value":s[8]||(s[8]=t=>o.taskGroupId=t),placeholder:e.$t("common.selectPlaceholder"),allowClear:"","show-search":"","filter-option":!1,onSearch:Z},{default:a(()=>[(u(!0),k(y,null,$(X.value,t=>(u(),b(w,{key:t.id,value:t.id},{default:a(()=>[r(n(t.taskGroupName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),l(i,null,{default:a(()=>[l(I,null,{default:a(()=>[l(G,{type:"primary",onClick:K},{default:a(()=>[r(n(e.$t("common.search")),1)]),_:1}),l(G,{onClick:ie},{default:a(()=>[r(n(e.$t("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_("div",Le,[l(I,null,{default:a(()=>[O.value.length?(u(),b(G,{key:0,onClick:he},{icon:a(()=>[l(we)]),default:a(()=>[r(" "+n(e.$t("common.export")),1)]),_:1})):f("",!0),l(G,{type:"primary",onClick:J},{default:a(()=>[r(n(e.$t("common.batchResolve")),1)]),_:1}),l(G,{danger:"",onClick:ve},{default:a(()=>[r(n(e.$t("common.batchReject")),1)]),_:1})]),_:1})])]),l(Ie,{columns:ne.value,"data-source":O.value,loading:F.value,pagination:T,showSorterTooltip:!1,"row-selection":ue,rowKey:"id",onChange:de},{bodyCell:a(({column:t,record:d})=>[t.key==="taskName"?(u(),b(I,{key:0},{default:a(()=>[l(Ae,{src:d.channelIcon,size:"small"},null,8,["src"]),_("span",null,n(d.taskName),1),d.taskGroup?(u(),b(x,{key:0,color:"orange"},{default:a(()=>[r(n(d.taskGroup.taskGroupName),1)]),_:2},1024)):f("",!0)]),_:2},1024)):f("",!0),t.key==="taskAuditStatus"?(u(),k(y,{key:1},[r(n(De(E).getEnumText("TaskAuditStatus",d.taskAuditStatus)),1)],64)):f("",!0),t.key==="preWaiterName"?(u(),k(y,{key:2},[r(n(d.preWaiterName||"--"),1)],64)):f("",!0),t.key==="preAuditTime"?(u(),k(y,{key:3},[r(n(d.preAuditTime||"--"),1)],64)):f("",!0),t.key==="waiterName"?(u(),k(y,{key:4},[r(n(d.waiterName||"--"),1)],64)):f("",!0),t.key==="confirmAuditTime"?(u(),k(y,{key:5},[r(n(d.auditTime||"--"),1)],64)):f("",!0),t.key==="member"?(u(),k(y,{key:6},[_("div",null,[l(I,null,{default:a(()=>[l(Se,{onClick:C=>ce(d)},{default:a(()=>[r(n(d.nickname),1)]),_:2},1032,["onClick"]),d.isNew?(u(),b(x,{key:0,color:"green"},{default:a(()=>s[12]||(s[12]=[r("new")])),_:1})):f("",!0)]),_:2},1024)]),_("div",null,n(d.account),1),(u(!0),k(y,null,$(d.groups,C=>(u(),k("div",null,[l(I,null,{default:a(()=>[_("span",null,n(C.groupName),1),C.isOwner?(u(),b(Me,{key:0})):f("",!0)]),_:2},1024)]))),256))],64)):f("",!0),t.key==="action"?(u(),b(I,{key:7},{default:a(()=>[_("a",{onClick:C=>me(d)},n(e.$t("submittedTasks.list.view")),9,Ve),d.taskAuditStatus==="pending"?(u(),b(ee,{key:0,title:e.$t("submittedTasks.list.confirmResolve"),onConfirm:C=>pe(d)},{default:a(()=>[_("a",null,n(e.$t("submittedTasks.list.resolve")),1)]),_:2},1032,["title","onConfirm"])):f("",!0),d.taskAuditStatus==="pending"?(u(),b(ee,{key:1,title:e.$t("submittedTasks.list.confirmReject"),onConfirm:C=>ke(d)},{default:a(()=>[_("a",He,n(e.$t("submittedTasks.list.reject")),1)]),_:2},1032,["title","onConfirm"])):f("",!0)]),_:2},1024)):f("",!0)]),_:1},8,["columns","data-source","loading","pagination"]),T.total?(u(),k("div",qe,[l(te,{column:2},{default:a(()=>[l(A,{label:e.$t("common.totalCount")},{default:a(()=>[r(n(T.total),1)]),_:1},8,["label"]),l(A,{label:e.$t("common.totalAmount")},{default:a(()=>[r(n(H.value),1)]),_:1},8,["label"])]),_:1})])):f("",!0)]),l(ae,{open:B.value,"onUpdate:open":s[9]||(s[9]=t=>B.value=t),title:"任务详情",footer:null},{default:a(()=>[l(te,{column:1},{default:a(()=>[l(A,{label:"任务名称"},{default:a(()=>{var t;return[r(n((t=R.value)==null?void 0:t.taskName),1)]}),_:1}),l(A,{label:"任务类型"},{default:a(()=>{var t;return[r(n((t=R.value)==null?void 0:t.taskType),1)]}),_:1}),l(A,{label:"任务描述"},{default:a(()=>{var t;return[r(n((t=R.value)==null?void 0:t.description),1)]}),_:1}),l(A,{label:"任务奖励"},{default:a(()=>{var t;return[r(n((t=R.value)==null?void 0:t.reward),1)]}),_:1}),l(A,{label:"创建时间"},{default:a(()=>{var t;return[r(n((t=R.value)==null?void 0:t.createTime),1)]}),_:1})]),_:1})]),_:1},8,["open"]),l(ae,{open:N.value,"onUpdate:open":s[11]||(s[11]=t=>N.value=t),title:"拒绝原因",onOk:fe,confirmLoading:M.value},{default:a(()=>[l(Ce,{value:S.value,"onUpdate:value":s[10]||(s[10]=t=>S.value=t),placeholder:"请输入拒绝原因",rows:4},null,8,["value"])]),_:1},8,["open","confirmLoading"])])}}},et=$e(Ke,[["__scopeId","data-v-f2b6b25d"]]);export{et as default};
